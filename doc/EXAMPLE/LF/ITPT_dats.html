<BODY BGCOLOR="#E0E0E0" TEXT="#E80000"><PRE><FONT COLOR="#787878">// Some examples in the following paper:
</FONT><FONT COLOR="#787878">// Implementing typeful program transformations
</FONT><FONT COLOR="#787878">// by Chiyan Chen and Rui Shi and Hongwei Xi
</FONT>
<FONT COLOR="#787878">// February 2007:
</FONT><FONT COLOR="#787878">// It is ported to ATS/Geizella by Hongwei Xi
</FONT>
<FONT COLOR="#787878">(* ****** ****** *)</FONT>

<FONT COLOR="#800080"><FONT COLOR="#000000">infixr</FONT> -&gt;&gt; ::</FONT>

<FONT COLOR="#000000">datasort</FONT> <FONT COLOR="#0000FF">ty <FONT COLOR="#000000">=</FONT> int <FONT COLOR="#000000">|</FONT> -&gt;&gt; <FONT COLOR="#000000">of</FONT> <FONT COLOR="#000000">(</FONT>ty<FONT COLOR="#000000">,</FONT> ty<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">|</FONT> forall <FONT COLOR="#000000">of</FONT> <FONT COLOR="#000000">(</FONT>ty <FONT COLOR="#000000">-&gt;</FONT> ty<FONT COLOR="#000000">)</FONT></FONT>
<FONT COLOR="#000000">datasort</FONT> <FONT COLOR="#0000FF">env <FONT COLOR="#000000">=</FONT> nil <FONT COLOR="#000000">|</FONT> :: <FONT COLOR="#000000">of</FONT> <FONT COLOR="#000000">(</FONT>ty<FONT COLOR="#000000">,</FONT> env<FONT COLOR="#000000">)</FONT></FONT>

<FONT COLOR="#000000">datatype</FONT> <FONT COLOR="#0000FF">VAR <FONT COLOR="#000000">(</FONT>env<FONT COLOR="#000000">,</FONT> ty<FONT COLOR="#000000">)</FONT></FONT> <FONT COLOR="#000000">=</FONT>
  <FONT COLOR="#000000">|</FONT> <FONT COLOR="#000000">{</FONT><FONT COLOR="#0000FF">G<FONT COLOR="#000000">:</FONT>env</FONT><FONT COLOR="#000000">}</FONT> <FONT COLOR="#000000">{</FONT><FONT COLOR="#0000FF">t<FONT COLOR="#000000">:</FONT>ty</FONT><FONT COLOR="#000000">}</FONT> VARone <FONT COLOR="#0000FF"><FONT COLOR="#000000">(</FONT>t :: G<FONT COLOR="#000000">,</FONT> t<FONT COLOR="#000000">)</FONT></FONT>
  <FONT COLOR="#000000">|</FONT> <FONT COLOR="#000000">{</FONT><FONT COLOR="#0000FF">G<FONT COLOR="#000000">:</FONT>env</FONT><FONT COLOR="#000000">}</FONT> <FONT COLOR="#000000">{</FONT><FONT COLOR="#0000FF">t1<FONT COLOR="#000000">,</FONT>t2<FONT COLOR="#000000">:</FONT>ty</FONT><FONT COLOR="#000000">}</FONT> VARshi <FONT COLOR="#0000FF"><FONT COLOR="#000000">(</FONT>t2 :: G<FONT COLOR="#000000">,</FONT> t1<FONT COLOR="#000000">)</FONT></FONT> <FONT COLOR="#000000">of</FONT> <FONT COLOR="#0000FF">VAR <FONT COLOR="#000000">(</FONT>G<FONT COLOR="#000000">,</FONT> t1<FONT COLOR="#000000">)</FONT></FONT>

<FONT COLOR="#000000">datatype</FONT> <FONT COLOR="#0000FF">EXP <FONT COLOR="#000000">(</FONT>env<FONT COLOR="#000000">,</FONT> ty<FONT COLOR="#000000">)</FONT></FONT> <FONT COLOR="#000000">=</FONT>
  <FONT COLOR="#000000">|</FONT> <FONT COLOR="#000000">{</FONT><FONT COLOR="#0000FF">G<FONT COLOR="#000000">:</FONT>env</FONT><FONT COLOR="#000000">}</FONT> <FONT COLOR="#000000">{</FONT><FONT COLOR="#0000FF">t<FONT COLOR="#000000">:</FONT>ty</FONT><FONT COLOR="#000000">}</FONT> EXPvar <FONT COLOR="#0000FF"><FONT COLOR="#000000">(</FONT>G<FONT COLOR="#000000">,</FONT> t<FONT COLOR="#000000">)</FONT></FONT> <FONT COLOR="#000000">of</FONT> <FONT COLOR="#0000FF">VAR <FONT COLOR="#000000">(</FONT>G<FONT COLOR="#000000">,</FONT> t<FONT COLOR="#000000">)</FONT></FONT>
  <FONT COLOR="#000000">|</FONT> <FONT COLOR="#000000">{</FONT><FONT COLOR="#0000FF">G<FONT COLOR="#000000">:</FONT>env</FONT><FONT COLOR="#000000">}</FONT> <FONT COLOR="#000000">{</FONT><FONT COLOR="#0000FF">t1<FONT COLOR="#000000">,</FONT>t2<FONT COLOR="#000000">:</FONT>ty</FONT><FONT COLOR="#000000">}</FONT> EXPlam <FONT COLOR="#0000FF"><FONT COLOR="#000000">(</FONT>G<FONT COLOR="#000000">,</FONT> t1 -&gt;&gt; t2<FONT COLOR="#000000">)</FONT></FONT> <FONT COLOR="#000000">of</FONT> <FONT COLOR="#0000FF">EXP <FONT COLOR="#000000">(</FONT>t1 :: G<FONT COLOR="#000000">,</FONT> t2<FONT COLOR="#000000">)</FONT></FONT>
  <FONT COLOR="#000000">|</FONT> <FONT COLOR="#000000">{</FONT><FONT COLOR="#0000FF">G<FONT COLOR="#000000">:</FONT>env</FONT><FONT COLOR="#000000">}</FONT> <FONT COLOR="#000000">{</FONT><FONT COLOR="#0000FF">t1<FONT COLOR="#000000">,</FONT>t2<FONT COLOR="#000000">:</FONT>ty</FONT><FONT COLOR="#000000">}</FONT> EXPapp <FONT COLOR="#0000FF"><FONT COLOR="#000000">(</FONT>G<FONT COLOR="#000000">,</FONT> t2<FONT COLOR="#000000">)</FONT></FONT> <FONT COLOR="#000000">of</FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">(</FONT>EXP <FONT COLOR="#000000">(</FONT>G<FONT COLOR="#000000">,</FONT> t1 -&gt;&gt; t2<FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">,</FONT> EXP <FONT COLOR="#000000">(</FONT>G<FONT COLOR="#000000">,</FONT> t1<FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT></FONT>
<FONT COLOR="#787878">(*
  | {G:env} {f:ty-&gt;ty} EXPtlam (G, forall f) of ({t:ty} EXP (G, f t))
  | {G:env} {f:ty-&gt;ty;t:ty} EXPtapp (G, f t) of EXP (G, forall f)
*)</FONT>

<FONT COLOR="#000000">typedef</FONT> <FONT COLOR="#0000FF">SUB <FONT COLOR="#000000">(</FONT>G1<FONT COLOR="#000000">:</FONT>env<FONT COLOR="#000000">,</FONT> G2<FONT COLOR="#000000">:</FONT>env<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">{</FONT>t<FONT COLOR="#000000">:</FONT>ty<FONT COLOR="#000000">}</FONT> VAR<FONT COLOR="#000000">(</FONT>G1<FONT COLOR="#000000">,</FONT>t<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">-&gt;</FONT> EXP<FONT COLOR="#000000">(</FONT>G2<FONT COLOR="#000000">,</FONT>t<FONT COLOR="#000000">)</FONT></FONT>

<FONT COLOR="#787878">// implementing some substitution functions
</FONT>
<FONT COLOR="#000000">val</FONT> idSub <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">lam</FONT> x <FONT COLOR="#000000">=&gt;</FONT> EXPvar x<FONT COLOR="#000000">)</FONT>
  <FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>G<FONT COLOR="#000000">:</FONT>env<FONT COLOR="#000000">}</FONT> SUB <FONT COLOR="#000000">(</FONT>G<FONT COLOR="#000000">,</FONT> G<FONT COLOR="#000000">)</FONT></FONT>

<FONT COLOR="#000000">val</FONT> shiSub <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">lam</FONT> x <FONT COLOR="#000000">=&gt;</FONT> EXPvar <FONT COLOR="#000000">(</FONT>VARshi x<FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT>
  <FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>G<FONT COLOR="#000000">:</FONT>env<FONT COLOR="#000000">}</FONT> <FONT COLOR="#000000">{</FONT>t<FONT COLOR="#000000">:</FONT>ty<FONT COLOR="#000000">}</FONT> SUB <FONT COLOR="#000000">(</FONT>G<FONT COLOR="#000000">,</FONT> t :: G<FONT COLOR="#000000">)</FONT></FONT>

<FONT COLOR="#000000">fun</FONT> subst <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>G1<FONT COLOR="#000000">,</FONT>G2<FONT COLOR="#000000">:</FONT>env<FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>t<FONT COLOR="#000000">:</FONT>ty<FONT COLOR="#000000">}</FONT></FONT>
  <FONT COLOR="#000000">(</FONT>sub<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">SUB<FONT COLOR="#000000">(</FONT>G1<FONT COLOR="#000000">,</FONT>G2<FONT COLOR="#000000">)</FONT></FONT><FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">(</FONT>e<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">EXP<FONT COLOR="#000000">(</FONT>G1<FONT COLOR="#000000">,</FONT>t<FONT COLOR="#000000">)</FONT></FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">EXP<FONT COLOR="#000000">(</FONT>G2<FONT COLOR="#000000">,</FONT>t<FONT COLOR="#000000">)</FONT></FONT> <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">begin</FONT> <FONT COLOR="#000000">case+</FONT> e <FONT COLOR="#000000">of</FONT>
  <FONT COLOR="#000000">|</FONT> EXPvar x <FONT COLOR="#000000">=&gt;</FONT> sub <FONT COLOR="#000000">(</FONT>x<FONT COLOR="#000000">)</FONT>
  <FONT COLOR="#000000">|</FONT> EXPlam e <FONT COLOR="#000000">=&gt;</FONT> EXPlam <FONT COLOR="#000000">(</FONT>subst <FONT COLOR="#000000">(</FONT>subLam sub<FONT COLOR="#000000">)</FONT> e<FONT COLOR="#000000">)</FONT>
  <FONT COLOR="#000000">|</FONT> EXPapp <FONT COLOR="#000000">(</FONT>e1<FONT COLOR="#000000">,</FONT> e2<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=&gt;</FONT> EXPapp <FONT COLOR="#000000">(</FONT>subst sub e1<FONT COLOR="#000000">,</FONT> subst sub e2<FONT COLOR="#000000">)</FONT>
<FONT COLOR="#787878">(*
  | EXPtlam {G1} {f} e =&gt; EXPtlam {G2} {f} (lam {t:ty} =&gt; subst sub (e {t}))
  | EXPtapp e =&gt; EXPtapp (subst sub e)
*)</FONT>
<FONT COLOR="#000000">end</FONT> <FONT COLOR="#787878">// end of [subst]
</FONT>
<FONT COLOR="#000000">and</FONT> subLam <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>G1<FONT COLOR="#000000">,</FONT>G2<FONT COLOR="#000000">:</FONT>env<FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>t<FONT COLOR="#000000">:</FONT>ty<FONT COLOR="#000000">}</FONT></FONT>
  <FONT COLOR="#000000">(</FONT>sub<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">SUB <FONT COLOR="#000000">(</FONT>G1<FONT COLOR="#000000">,</FONT>G2<FONT COLOR="#000000">)</FONT></FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">SUB <FONT COLOR="#000000">(</FONT>t::G1<FONT COLOR="#000000">,</FONT>t::G2<FONT COLOR="#000000">)</FONT></FONT> <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">begin</FONT>
  <FONT COLOR="#000000">lam</FONT> v <FONT COLOR="#000000">=&gt;</FONT> <FONT COLOR="#000000">case+</FONT> v <FONT COLOR="#000000">of</FONT>
    <FONT COLOR="#000000">|</FONT> VARone <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=&gt;</FONT> EXPvar <FONT COLOR="#000000">(</FONT>VARone<FONT COLOR="#000000">)</FONT>
    <FONT COLOR="#000000">|</FONT> VARshi x' <FONT COLOR="#000000">=&gt;</FONT> subst <FONT COLOR="#000000">(</FONT>shiSub <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT><FONT COLOR="#000000">..</FONT><FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT><FONT COLOR="#000000">..</FONT><FONT COLOR="#000000">}</FONT></FONT><FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">(</FONT>sub x'<FONT COLOR="#000000">)</FONT> 
<FONT COLOR="#000000">end</FONT> <FONT COLOR="#787878">// end of [subLam]
</FONT>
<FONT COLOR="#000000">fun</FONT> subPre <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>G1<FONT COLOR="#000000">,</FONT>G2<FONT COLOR="#000000">:</FONT>env<FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>t<FONT COLOR="#000000">:</FONT>ty<FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#000000">(</FONT>sub<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">SUB<FONT COLOR="#000000">(</FONT>G1<FONT COLOR="#000000">,</FONT> G2<FONT COLOR="#000000">)</FONT></FONT><FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">(</FONT>e<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">EXP <FONT COLOR="#000000">(</FONT>G2<FONT COLOR="#000000">,</FONT> t<FONT COLOR="#000000">)</FONT></FONT><FONT COLOR="#000000">)</FONT>
  <FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">SUB <FONT COLOR="#000000">(</FONT>t :: G1<FONT COLOR="#000000">,</FONT> G2<FONT COLOR="#000000">)</FONT></FONT> <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">begin</FONT>
  <FONT COLOR="#000000">lam</FONT> x <FONT COLOR="#000000">=&gt;</FONT> <FONT COLOR="#000000">case+</FONT> x <FONT COLOR="#000000">of</FONT> VARone <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=&gt;</FONT> e <FONT COLOR="#000000">|</FONT> VARshi x <FONT COLOR="#000000">=&gt;</FONT> sub x
<FONT COLOR="#000000">end</FONT> <FONT COLOR="#787878">// end of [subPre]
</FONT>  
<FONT COLOR="#000000">fun</FONT> subComp <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>G1<FONT COLOR="#000000">,</FONT>G2<FONT COLOR="#000000">,</FONT>G3<FONT COLOR="#000000">:</FONT>env<FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#000000">(</FONT>sub1<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">SUB <FONT COLOR="#000000">(</FONT>G1<FONT COLOR="#000000">,</FONT>G2<FONT COLOR="#000000">)</FONT></FONT><FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">(</FONT>sub2<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">SUB <FONT COLOR="#000000">(</FONT>G2<FONT COLOR="#000000">,</FONT>G3<FONT COLOR="#000000">)</FONT></FONT><FONT COLOR="#000000">)</FONT>
  <FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">SUB <FONT COLOR="#000000">(</FONT>G1<FONT COLOR="#000000">,</FONT> G3<FONT COLOR="#000000">)</FONT></FONT> <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">begin</FONT>
  <FONT COLOR="#000000">lam</FONT> x <FONT COLOR="#000000">=&gt;</FONT> subst sub2 <FONT COLOR="#000000">(</FONT>sub1 x<FONT COLOR="#000000">)</FONT>
<FONT COLOR="#000000">end</FONT> <FONT COLOR="#787878">// end of [subComp]
</FONT>
<FONT COLOR="#787878">// implementing the normalization function for simply typed lambda-calculus
</FONT>
<FONT COLOR="#000000">fun</FONT> nf <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>G<FONT COLOR="#000000">:</FONT>env<FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>t<FONT COLOR="#000000">:</FONT>ty<FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#000000">(</FONT>e<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">EXP<FONT COLOR="#000000">(</FONT>G<FONT COLOR="#000000">,</FONT> t<FONT COLOR="#000000">)</FONT></FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">EXP <FONT COLOR="#000000">(</FONT>G<FONT COLOR="#000000">,</FONT> t<FONT COLOR="#000000">)</FONT></FONT> <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">begin</FONT>
  <FONT COLOR="#000000">case+</FONT> e <FONT COLOR="#000000">of</FONT>
  <FONT COLOR="#000000">|</FONT> EXPvar _ <FONT COLOR="#000000">=&gt;</FONT> e
  <FONT COLOR="#000000">|</FONT> EXPlam e <FONT COLOR="#000000">=&gt;</FONT> EXPlam <FONT COLOR="#000000">(</FONT>nf e<FONT COLOR="#000000">)</FONT>
  <FONT COLOR="#000000">|</FONT> EXPapp <FONT COLOR="#000000">(</FONT>e1<FONT COLOR="#000000">,</FONT> e2<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=&gt;</FONT> <FONT COLOR="#000000">begin</FONT> <FONT COLOR="#000000">case+</FONT> nf e1 <FONT COLOR="#000000">of</FONT>
    <FONT COLOR="#000000">|</FONT> EXPlam e <FONT COLOR="#000000">=&gt;</FONT> nf <FONT COLOR="#000000">(</FONT>subst <FONT COLOR="#000000">(</FONT>subPre idSub e2<FONT COLOR="#000000">)</FONT> e<FONT COLOR="#000000">)</FONT>
    <FONT COLOR="#000000">|</FONT> e1 <FONT COLOR="#000000">=&gt;</FONT> EXPapp <FONT COLOR="#000000">(</FONT>e1<FONT COLOR="#000000">,</FONT> nf e2<FONT COLOR="#000000">)</FONT>
    <FONT COLOR="#000000">end</FONT>
<FONT COLOR="#787878">(*
  | EXPtlam {G} {f} e =&gt; EXPtlam {G} {f} (lam {t:ty} =&gt; nf (e {t}))
  | EXPtapp e =&gt; EXPtapp (nf e)
*)</FONT>
<FONT COLOR="#000000">end</FONT> <FONT COLOR="#787878">// end of [nf]
</FONT>
<FONT COLOR="#787878">// implementing a call-by-value evaluator for simply typed lambda-calculus
</FONT>
<FONT COLOR="#000000">datatype</FONT> <FONT COLOR="#0000FF">VAL <FONT COLOR="#000000">(</FONT>ty<FONT COLOR="#000000">)</FONT></FONT> <FONT COLOR="#000000">=</FONT>
  <FONT COLOR="#000000">|</FONT> <FONT COLOR="#000000">{</FONT><FONT COLOR="#0000FF">G<FONT COLOR="#000000">:</FONT>env</FONT><FONT COLOR="#000000">}</FONT> <FONT COLOR="#000000">{</FONT><FONT COLOR="#0000FF">t1<FONT COLOR="#000000">,</FONT>t2<FONT COLOR="#000000">:</FONT>ty</FONT><FONT COLOR="#000000">}</FONT> VALclo <FONT COLOR="#0000FF"><FONT COLOR="#000000">(</FONT>t1 -&gt;&gt; t2<FONT COLOR="#000000">)</FONT></FONT> <FONT COLOR="#000000">of</FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">(</FONT>ENV G<FONT COLOR="#000000">,</FONT> EXP <FONT COLOR="#000000">(</FONT>t1 :: G<FONT COLOR="#000000">,</FONT> t2<FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT></FONT>
  <FONT COLOR="#000000">|</FONT> <FONT COLOR="#000000">{</FONT><FONT COLOR="#0000FF">G<FONT COLOR="#000000">:</FONT>env</FONT><FONT COLOR="#000000">}</FONT> <FONT COLOR="#000000">{</FONT><FONT COLOR="#0000FF">f<FONT COLOR="#000000">:</FONT>ty<FONT COLOR="#000000">-&gt;</FONT>ty</FONT><FONT COLOR="#000000">}</FONT> VALtclo <FONT COLOR="#0000FF"><FONT COLOR="#000000">(</FONT>forall f<FONT COLOR="#000000">)</FONT></FONT> <FONT COLOR="#000000">of</FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">(</FONT>ENV G<FONT COLOR="#000000">,</FONT> <FONT COLOR="#000000">{</FONT>t<FONT COLOR="#000000">:</FONT>ty<FONT COLOR="#000000">}</FONT> EXP <FONT COLOR="#000000">(</FONT>G<FONT COLOR="#000000">,</FONT> f t<FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT></FONT>

<FONT COLOR="#000000">and</FONT> <FONT COLOR="#0000FF">ENV <FONT COLOR="#000000">(</FONT>env<FONT COLOR="#000000">)</FONT></FONT> <FONT COLOR="#000000">=</FONT>
  <FONT COLOR="#000000">|</FONT> ENVnil <FONT COLOR="#0000FF"><FONT COLOR="#000000">(</FONT>nil<FONT COLOR="#000000">)</FONT></FONT>
  <FONT COLOR="#000000">|</FONT> <FONT COLOR="#000000">{</FONT><FONT COLOR="#0000FF">G<FONT COLOR="#000000">:</FONT>env</FONT><FONT COLOR="#000000">}</FONT> <FONT COLOR="#000000">{</FONT><FONT COLOR="#0000FF">t<FONT COLOR="#000000">:</FONT>ty</FONT><FONT COLOR="#000000">}</FONT> ENVcons <FONT COLOR="#0000FF"><FONT COLOR="#000000">(</FONT>t :: G<FONT COLOR="#000000">)</FONT></FONT> <FONT COLOR="#000000">of</FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">(</FONT>VAL t<FONT COLOR="#000000">,</FONT> ENV G<FONT COLOR="#000000">)</FONT></FONT>

<FONT COLOR="#000000">fun</FONT> evalVar <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>G<FONT COLOR="#000000">:</FONT>env<FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>t<FONT COLOR="#000000">:</FONT>ty<FONT COLOR="#000000">}</FONT></FONT>
  <FONT COLOR="#000000">(</FONT>env<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">ENV G</FONT><FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">(</FONT>x<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">VAR <FONT COLOR="#000000">(</FONT>G<FONT COLOR="#000000">,</FONT> t<FONT COLOR="#000000">)</FONT></FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">VAL t</FONT> <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">begin</FONT> <FONT COLOR="#000000">case+</FONT> x <FONT COLOR="#000000">of</FONT>
  <FONT COLOR="#000000">|</FONT> VARone <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=&gt;</FONT> <FONT COLOR="#000000">let</FONT> <FONT COLOR="#000000">val</FONT> ENVcons <FONT COLOR="#000000">(</FONT>v<FONT COLOR="#000000">,</FONT> _<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> env <FONT COLOR="#000000">in</FONT> v <FONT COLOR="#000000">end</FONT>
  <FONT COLOR="#000000">|</FONT> VARshi x <FONT COLOR="#000000">=&gt;</FONT> <FONT COLOR="#000000">let</FONT> <FONT COLOR="#000000">val</FONT> ENVcons <FONT COLOR="#000000">(</FONT>_<FONT COLOR="#000000">,</FONT> env<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> env <FONT COLOR="#000000">in</FONT> evalVar env x <FONT COLOR="#000000">end</FONT>
<FONT COLOR="#000000">end</FONT> <FONT COLOR="#787878">// end of [evalVar]
</FONT>
<FONT COLOR="#000000">fun</FONT> eval <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>G<FONT COLOR="#000000">:</FONT>env<FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>t<FONT COLOR="#000000">:</FONT>ty<FONT COLOR="#000000">}</FONT></FONT>
  <FONT COLOR="#000000">(</FONT>env<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">ENV G</FONT><FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">(</FONT>e<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">EXP <FONT COLOR="#000000">(</FONT>G<FONT COLOR="#000000">,</FONT> t<FONT COLOR="#000000">)</FONT></FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">VAL t</FONT> <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">begin</FONT> <FONT COLOR="#000000">case+</FONT> e <FONT COLOR="#000000">of</FONT>
  <FONT COLOR="#000000">|</FONT> EXPvar x <FONT COLOR="#000000">=&gt;</FONT> evalVar env x
  <FONT COLOR="#000000">|</FONT> EXPlam <FONT COLOR="#000000">(</FONT>e<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=&gt;</FONT> VALclo <FONT COLOR="#000000">(</FONT>env<FONT COLOR="#000000">,</FONT> e<FONT COLOR="#000000">)</FONT>
  <FONT COLOR="#000000">|</FONT> EXPapp <FONT COLOR="#000000">(</FONT>e1<FONT COLOR="#000000">,</FONT> e2<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=&gt;</FONT> <FONT COLOR="#000000">let</FONT>
      <FONT COLOR="#000000">val</FONT> VALclo <FONT COLOR="#000000">(</FONT>env'<FONT COLOR="#000000">,</FONT> body<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> eval env e1
      <FONT COLOR="#000000">val</FONT> v <FONT COLOR="#000000">=</FONT> eval env e2
    <FONT COLOR="#000000">in</FONT>
      eval <FONT COLOR="#000000">(</FONT>ENVcons <FONT COLOR="#000000">(</FONT>v<FONT COLOR="#000000">,</FONT> env'<FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT> body
    <FONT COLOR="#000000">end</FONT>
<FONT COLOR="#787878">(*
  | EXPtlam {G} {f} e =&gt; VALtclo {G} {f} (env, e)
  | EXPtapp e =&gt; let
      val VALtclo (env, body) = eval env e
    in
      eval env (body {...})
    end
*)</FONT>
<FONT COLOR="#000000">end</FONT> <FONT COLOR="#787878">// end of [eval]
</FONT>
<FONT COLOR="#000000">fun</FONT> evaluate <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>t<FONT COLOR="#000000">:</FONT>ty<FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#000000">(</FONT>e<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">EXP <FONT COLOR="#000000">(</FONT>nil<FONT COLOR="#000000">,</FONT> t<FONT COLOR="#000000">)</FONT></FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">VAL t</FONT> <FONT COLOR="#000000">=</FONT> eval ENVnil e

<FONT COLOR="#787878">// ------------------------ additional examples ------------------------
</FONT>
<FONT COLOR="#787878">// the example of CPS transformation can be found in CPS.ats in the same
</FONT><FONT COLOR="#787878">// directory
</FONT>
<FONT COLOR="#787878">// the example of closure conversion can be found in ClosureConv.ats in
</FONT><FONT COLOR="#787878">// the same directory
</FONT>
<FONT COLOR="#787878">(* ****** ****** *)</FONT>

<FONT COLOR="#787878">(* end of [ITPT.dats] *)</FONT>
</PRE></BODY>

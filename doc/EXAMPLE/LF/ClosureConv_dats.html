<BODY BGCOLOR="#E0E0E0" TEXT="#E80000"><PRE><FONT COLOR="#787878">//
</FONT><FONT COLOR="#787878">//
</FONT><FONT COLOR="#787878">// A typeful implementation of closure conversion
</FONT><FONT COLOR="#787878">//
</FONT><FONT COLOR="#787878">//
</FONT>
<FONT COLOR="#787878">// January 2005:
</FONT><FONT COLOR="#787878">// The code is written by Hongwei Xi
</FONT>
<FONT COLOR="#787878">// February 2007:
</FONT><FONT COLOR="#787878">// This code is ported to ATS/Geizella by Hongwei Xi
</FONT>
<FONT COLOR="#787878">// March 3rd, 2008
</FONT><FONT COLOR="#787878">// This code is ported to ATS/Anairiats by Hongwei Xi
</FONT>
<FONT COLOR="#787878">(* ****** ****** *)</FONT>

<FONT COLOR="#800080"><FONT COLOR="#000000">infixr</FONT> -&gt;&gt; ::</FONT>

<FONT COLOR="#000000">datasort</FONT> <FONT COLOR="#0000FF">ty <FONT COLOR="#000000">=</FONT> int <FONT COLOR="#000000">|</FONT> -&gt;&gt; <FONT COLOR="#000000">of</FONT> <FONT COLOR="#000000">(</FONT>ty<FONT COLOR="#000000">,</FONT> ty<FONT COLOR="#000000">)</FONT></FONT>
<FONT COLOR="#000000">datasort</FONT> <FONT COLOR="#0000FF">env <FONT COLOR="#000000">=</FONT> nil <FONT COLOR="#000000">|</FONT> :: <FONT COLOR="#000000">of</FONT> <FONT COLOR="#000000">(</FONT>ty<FONT COLOR="#000000">,</FONT> env<FONT COLOR="#000000">)</FONT></FONT>

<FONT COLOR="#000000">datatype</FONT> <FONT COLOR="#0000FF">VAR <FONT COLOR="#000000">(</FONT>env<FONT COLOR="#000000">,</FONT> ty<FONT COLOR="#000000">)</FONT></FONT> <FONT COLOR="#000000">=</FONT>
  <FONT COLOR="#000000">|</FONT> <FONT COLOR="#000000">{</FONT><FONT COLOR="#0000FF">G<FONT COLOR="#000000">:</FONT>env</FONT><FONT COLOR="#000000">}</FONT> <FONT COLOR="#000000">{</FONT><FONT COLOR="#0000FF">t<FONT COLOR="#000000">:</FONT>ty</FONT><FONT COLOR="#000000">}</FONT> VARone <FONT COLOR="#0000FF"><FONT COLOR="#000000">(</FONT>t :: G<FONT COLOR="#000000">,</FONT> t<FONT COLOR="#000000">)</FONT></FONT>
  <FONT COLOR="#000000">|</FONT> <FONT COLOR="#000000">{</FONT><FONT COLOR="#0000FF">G<FONT COLOR="#000000">:</FONT>env</FONT><FONT COLOR="#000000">}</FONT> <FONT COLOR="#000000">{</FONT><FONT COLOR="#0000FF">t1<FONT COLOR="#000000">,</FONT>t2<FONT COLOR="#000000">:</FONT>ty</FONT><FONT COLOR="#000000">}</FONT> VARshi <FONT COLOR="#0000FF"><FONT COLOR="#000000">(</FONT>t2 :: G<FONT COLOR="#000000">,</FONT> t1<FONT COLOR="#000000">)</FONT></FONT> <FONT COLOR="#000000">of</FONT> <FONT COLOR="#0000FF">VAR <FONT COLOR="#000000">(</FONT>G<FONT COLOR="#000000">,</FONT> t1<FONT COLOR="#000000">)</FONT></FONT>

<FONT COLOR="#000000">datatype</FONT> <FONT COLOR="#0000FF">EXP <FONT COLOR="#000000">(</FONT>env<FONT COLOR="#000000">,</FONT> ty<FONT COLOR="#000000">)</FONT></FONT> <FONT COLOR="#000000">=</FONT>
  <FONT COLOR="#000000">|</FONT> <FONT COLOR="#000000">{</FONT><FONT COLOR="#0000FF">G<FONT COLOR="#000000">:</FONT>env</FONT><FONT COLOR="#000000">}</FONT> <FONT COLOR="#000000">{</FONT><FONT COLOR="#0000FF">t<FONT COLOR="#000000">:</FONT>ty</FONT><FONT COLOR="#000000">}</FONT> EXPvar <FONT COLOR="#0000FF"><FONT COLOR="#000000">(</FONT>G<FONT COLOR="#000000">,</FONT> t<FONT COLOR="#000000">)</FONT></FONT> <FONT COLOR="#000000">of</FONT> <FONT COLOR="#0000FF">VAR <FONT COLOR="#000000">(</FONT>G<FONT COLOR="#000000">,</FONT> t<FONT COLOR="#000000">)</FONT></FONT>
  <FONT COLOR="#000000">|</FONT> <FONT COLOR="#000000">{</FONT><FONT COLOR="#0000FF">G<FONT COLOR="#000000">:</FONT>env</FONT><FONT COLOR="#000000">}</FONT> <FONT COLOR="#000000">{</FONT><FONT COLOR="#0000FF">t1<FONT COLOR="#000000">,</FONT>t2<FONT COLOR="#000000">:</FONT>ty</FONT><FONT COLOR="#000000">}</FONT> EXPlam <FONT COLOR="#0000FF"><FONT COLOR="#000000">(</FONT>G<FONT COLOR="#000000">,</FONT> t1 -&gt;&gt; t2<FONT COLOR="#000000">)</FONT></FONT> <FONT COLOR="#000000">of</FONT> <FONT COLOR="#0000FF">EXP <FONT COLOR="#000000">(</FONT>t1 :: G<FONT COLOR="#000000">,</FONT> t2<FONT COLOR="#000000">)</FONT></FONT>
  <FONT COLOR="#000000">|</FONT> <FONT COLOR="#000000">{</FONT><FONT COLOR="#0000FF">G<FONT COLOR="#000000">:</FONT>env</FONT><FONT COLOR="#000000">}</FONT> <FONT COLOR="#000000">{</FONT><FONT COLOR="#0000FF">t1<FONT COLOR="#000000">,</FONT>t2<FONT COLOR="#000000">:</FONT>ty</FONT><FONT COLOR="#000000">}</FONT> EXPapp <FONT COLOR="#0000FF"><FONT COLOR="#000000">(</FONT>G<FONT COLOR="#000000">,</FONT> t2<FONT COLOR="#000000">)</FONT></FONT> <FONT COLOR="#000000">of</FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">(</FONT>EXP <FONT COLOR="#000000">(</FONT>G<FONT COLOR="#000000">,</FONT> t1 -&gt;&gt; t2<FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">,</FONT> EXP <FONT COLOR="#000000">(</FONT>G<FONT COLOR="#000000">,</FONT> t1<FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT></FONT>

<FONT COLOR="#000000">typedef</FONT> <FONT COLOR="#0000FF">EXP0 <FONT COLOR="#000000">(</FONT>t<FONT COLOR="#000000">:</FONT> ty<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> EXP <FONT COLOR="#000000">(</FONT>nil<FONT COLOR="#000000">,</FONT> t<FONT COLOR="#000000">)</FONT></FONT>

<FONT COLOR="#000000">datatype</FONT> <FONT COLOR="#0000FF">EXP' <FONT COLOR="#000000">(</FONT>env<FONT COLOR="#000000">,</FONT> ty<FONT COLOR="#000000">)</FONT></FONT> <FONT COLOR="#000000">=</FONT>
  <FONT COLOR="#000000">|</FONT> <FONT COLOR="#000000">{</FONT><FONT COLOR="#0000FF">G<FONT COLOR="#000000">:</FONT>env</FONT><FONT COLOR="#000000">}</FONT> <FONT COLOR="#000000">{</FONT><FONT COLOR="#0000FF">t<FONT COLOR="#000000">:</FONT>ty</FONT><FONT COLOR="#000000">}</FONT> EXPvar' <FONT COLOR="#0000FF"><FONT COLOR="#000000">(</FONT>G<FONT COLOR="#000000">,</FONT> t<FONT COLOR="#000000">)</FONT></FONT> <FONT COLOR="#000000">of</FONT> <FONT COLOR="#0000FF">VAR <FONT COLOR="#000000">(</FONT>G<FONT COLOR="#000000">,</FONT> t<FONT COLOR="#000000">)</FONT></FONT>
  <FONT COLOR="#000000">|</FONT> <FONT COLOR="#000000">{</FONT><FONT COLOR="#0000FF">G1<FONT COLOR="#000000">,</FONT>G2<FONT COLOR="#000000">:</FONT>env</FONT><FONT COLOR="#000000">}</FONT> <FONT COLOR="#000000">{</FONT><FONT COLOR="#0000FF">t1<FONT COLOR="#000000">,</FONT>t2<FONT COLOR="#000000">:</FONT>ty</FONT><FONT COLOR="#000000">}</FONT>
      EXPclo' <FONT COLOR="#0000FF"><FONT COLOR="#000000">(</FONT>G1<FONT COLOR="#000000">,</FONT> t1 -&gt;&gt; t2<FONT COLOR="#000000">)</FONT></FONT> <FONT COLOR="#000000">of</FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">(</FONT>EXP' <FONT COLOR="#000000">(</FONT>t1 :: G2<FONT COLOR="#000000">,</FONT> t2<FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">,</FONT> ENV <FONT COLOR="#000000">(</FONT>G1<FONT COLOR="#000000">,</FONT> G2<FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT></FONT>
  <FONT COLOR="#000000">|</FONT> <FONT COLOR="#000000">{</FONT><FONT COLOR="#0000FF">G1<FONT COLOR="#000000">:</FONT>env</FONT><FONT COLOR="#000000">}</FONT> <FONT COLOR="#000000">{</FONT><FONT COLOR="#0000FF">t1<FONT COLOR="#000000">,</FONT>t2<FONT COLOR="#000000">:</FONT>ty</FONT><FONT COLOR="#000000">}</FONT> EXPapp' <FONT COLOR="#0000FF"><FONT COLOR="#000000">(</FONT>G1<FONT COLOR="#000000">,</FONT> t2<FONT COLOR="#000000">)</FONT></FONT> <FONT COLOR="#000000">of</FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">(</FONT>EXP' <FONT COLOR="#000000">(</FONT>G1<FONT COLOR="#000000">,</FONT> t1 -&gt;&gt; t2<FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">,</FONT> EXP' <FONT COLOR="#000000">(</FONT>G1<FONT COLOR="#000000">,</FONT> t1<FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT></FONT>

<FONT COLOR="#000000">and</FONT> <FONT COLOR="#0000FF">ENV <FONT COLOR="#000000">(</FONT>env<FONT COLOR="#000000">,</FONT> env<FONT COLOR="#000000">)</FONT></FONT> <FONT COLOR="#000000">=</FONT>
  <FONT COLOR="#000000">|</FONT> <FONT COLOR="#000000">{</FONT><FONT COLOR="#0000FF">G<FONT COLOR="#000000">:</FONT>env</FONT><FONT COLOR="#000000">}</FONT> ENVnil <FONT COLOR="#0000FF"><FONT COLOR="#000000">(</FONT>G<FONT COLOR="#000000">,</FONT> nil<FONT COLOR="#000000">)</FONT></FONT>
  <FONT COLOR="#000000">|</FONT> <FONT COLOR="#000000">{</FONT><FONT COLOR="#0000FF">G1<FONT COLOR="#000000">,</FONT>G2<FONT COLOR="#000000">:</FONT>env</FONT><FONT COLOR="#000000">}</FONT> <FONT COLOR="#000000">{</FONT><FONT COLOR="#0000FF">t<FONT COLOR="#000000">:</FONT>ty</FONT><FONT COLOR="#000000">}</FONT> ENVcons <FONT COLOR="#0000FF"><FONT COLOR="#000000">(</FONT>G1<FONT COLOR="#000000">,</FONT> t :: G2<FONT COLOR="#000000">)</FONT></FONT> <FONT COLOR="#000000">of</FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">(</FONT>EXP' <FONT COLOR="#000000">(</FONT>G1<FONT COLOR="#000000">,</FONT> t<FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">,</FONT> ENV <FONT COLOR="#000000">(</FONT>G1<FONT COLOR="#000000">,</FONT> G2<FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT></FONT>

<FONT COLOR="#000000">typedef</FONT> <FONT COLOR="#0000FF">EXP0' <FONT COLOR="#000000">(</FONT>t<FONT COLOR="#000000">:</FONT>ty<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> EXP' <FONT COLOR="#000000">(</FONT>nil<FONT COLOR="#000000">,</FONT> t<FONT COLOR="#000000">)</FONT></FONT>

<FONT COLOR="#000000">fun</FONT> EXPone' <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>G<FONT COLOR="#000000">:</FONT>env<FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>t<FONT COLOR="#000000">:</FONT>ty<FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">EXP' <FONT COLOR="#000000">(</FONT>t :: G<FONT COLOR="#000000">,</FONT> t<FONT COLOR="#000000">)</FONT></FONT> <FONT COLOR="#000000">=</FONT> EXPvar' <FONT COLOR="#000000">(</FONT>VARone<FONT COLOR="#000000">)</FONT>

<FONT COLOR="#000000">typedef</FONT> <FONT COLOR="#0000FF">SUB <FONT COLOR="#000000">(</FONT>G1<FONT COLOR="#000000">:</FONT>env<FONT COLOR="#000000">,</FONT> G2<FONT COLOR="#000000">:</FONT>env<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">{</FONT>t<FONT COLOR="#000000">:</FONT>ty<FONT COLOR="#000000">}</FONT> VAR<FONT COLOR="#000000">(</FONT>G1<FONT COLOR="#000000">,</FONT>t<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">-&gt;</FONT> EXP'<FONT COLOR="#000000">(</FONT>G2<FONT COLOR="#000000">,</FONT>t<FONT COLOR="#000000">)</FONT></FONT>

<FONT COLOR="#000000">val</FONT> nilSub <FONT COLOR="#000000">=</FONT>
  <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">lam</FONT> x <FONT COLOR="#000000">=&gt;</FONT> <FONT COLOR="#000000">case+</FONT> x <FONT COLOR="#000000">of</FONT> VARone _ <FONT COLOR="#000000">=/=&gt;</FONT> <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">|</FONT> VARshi _ <FONT COLOR="#000000">=/=&gt;</FONT> <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT>
  <FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">SUB <FONT COLOR="#000000">(</FONT>nil<FONT COLOR="#000000">,</FONT> nil<FONT COLOR="#000000">)</FONT></FONT>

<FONT COLOR="#000000">val</FONT> idSub <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">lam</FONT> x <FONT COLOR="#000000">=&gt;</FONT> EXPvar' x<FONT COLOR="#000000">)</FONT>
  <FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>G<FONT COLOR="#000000">:</FONT>env<FONT COLOR="#000000">}</FONT> SUB <FONT COLOR="#000000">(</FONT>G<FONT COLOR="#000000">,</FONT> G<FONT COLOR="#000000">)</FONT></FONT>

<FONT COLOR="#000000">val</FONT> shiSub <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">lam</FONT> x <FONT COLOR="#000000">=&gt;</FONT> EXPvar' <FONT COLOR="#000000">(</FONT>VARshi x<FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT>
  <FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>G<FONT COLOR="#000000">:</FONT>env<FONT COLOR="#000000">}</FONT> <FONT COLOR="#000000">{</FONT>t<FONT COLOR="#000000">:</FONT>ty<FONT COLOR="#000000">}</FONT> SUB <FONT COLOR="#000000">(</FONT>G<FONT COLOR="#000000">,</FONT> t :: G<FONT COLOR="#000000">)</FONT></FONT>

<FONT COLOR="#787878">//
</FONT>
<FONT COLOR="#000000">fun</FONT> subst <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>G1<FONT COLOR="#000000">,</FONT>G2<FONT COLOR="#000000">:</FONT>env<FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>t<FONT COLOR="#000000">:</FONT>ty<FONT COLOR="#000000">}</FONT></FONT>
  <FONT COLOR="#000000">(</FONT>sub<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">SUB<FONT COLOR="#000000">(</FONT>G1<FONT COLOR="#000000">,</FONT>G2<FONT COLOR="#000000">)</FONT></FONT><FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">(</FONT>e<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">EXP'<FONT COLOR="#000000">(</FONT>G1<FONT COLOR="#000000">,</FONT>t<FONT COLOR="#000000">)</FONT></FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">EXP'<FONT COLOR="#000000">(</FONT>G2<FONT COLOR="#000000">,</FONT>t<FONT COLOR="#000000">)</FONT></FONT> <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">begin</FONT>
  <FONT COLOR="#000000">case+</FONT> e <FONT COLOR="#000000">of</FONT>
  <FONT COLOR="#000000">|</FONT> EXPvar' x <FONT COLOR="#000000">=&gt;</FONT> sub <FONT COLOR="#000000">(</FONT>x<FONT COLOR="#000000">)</FONT>
  <FONT COLOR="#000000">|</FONT> EXPclo' <FONT COLOR="#000000">(</FONT>code<FONT COLOR="#000000">,</FONT> env<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=&gt;</FONT> EXPclo' <FONT COLOR="#000000">(</FONT>code<FONT COLOR="#000000">,</FONT> substEnv sub env<FONT COLOR="#000000">)</FONT>
  <FONT COLOR="#000000">|</FONT> EXPapp' <FONT COLOR="#000000">(</FONT>e1<FONT COLOR="#000000">,</FONT> e2<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=&gt;</FONT> EXPapp' <FONT COLOR="#000000">(</FONT>subst sub e1<FONT COLOR="#000000">,</FONT> subst sub e2<FONT COLOR="#000000">)</FONT>
<FONT COLOR="#000000">end</FONT> <FONT COLOR="#787878">// end of [subst]
</FONT>
<FONT COLOR="#000000">and</FONT> subLam <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>G1<FONT COLOR="#000000">,</FONT>G2<FONT COLOR="#000000">:</FONT>env<FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>t<FONT COLOR="#000000">:</FONT>ty<FONT COLOR="#000000">}</FONT></FONT>
  <FONT COLOR="#000000">(</FONT>sub<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">SUB <FONT COLOR="#000000">(</FONT>G1<FONT COLOR="#000000">,</FONT>G2<FONT COLOR="#000000">)</FONT></FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">SUB <FONT COLOR="#000000">(</FONT>t::G1<FONT COLOR="#000000">,</FONT>t::G2<FONT COLOR="#000000">)</FONT></FONT> <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">begin</FONT>
  <FONT COLOR="#000000">lam</FONT> x <FONT COLOR="#000000">=&gt;</FONT> <FONT COLOR="#000000">case+</FONT> x <FONT COLOR="#000000">of</FONT>
    <FONT COLOR="#000000">|</FONT> VARone <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=&gt;</FONT> EXPvar' <FONT COLOR="#000000">(</FONT>VARone<FONT COLOR="#000000">)</FONT>
    <FONT COLOR="#000000">|</FONT> VARshi x' <FONT COLOR="#000000">=&gt;</FONT> subst <FONT COLOR="#000000">(</FONT>shiSub <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT><FONT COLOR="#000000">..</FONT><FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT><FONT COLOR="#000000">..</FONT><FONT COLOR="#000000">}</FONT></FONT><FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">(</FONT>sub x'<FONT COLOR="#000000">)</FONT>
<FONT COLOR="#000000">end</FONT> <FONT COLOR="#787878">// end of [subLam]
</FONT>
<FONT COLOR="#000000">and</FONT> substEnv <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>G1<FONT COLOR="#000000">,</FONT>G2<FONT COLOR="#000000">,</FONT>G3<FONT COLOR="#000000">:</FONT>env<FONT COLOR="#000000">}</FONT></FONT>
  <FONT COLOR="#000000">(</FONT>sub<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">SUB<FONT COLOR="#000000">(</FONT>G1<FONT COLOR="#000000">,</FONT>G2<FONT COLOR="#000000">)</FONT></FONT><FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">(</FONT>e<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">ENV<FONT COLOR="#000000">(</FONT>G1<FONT COLOR="#000000">,</FONT>G3<FONT COLOR="#000000">)</FONT></FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">ENV<FONT COLOR="#000000">(</FONT>G2<FONT COLOR="#000000">,</FONT>G3<FONT COLOR="#000000">)</FONT></FONT> <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">begin</FONT>
  <FONT COLOR="#000000">case+</FONT> e <FONT COLOR="#000000">of</FONT>
  <FONT COLOR="#000000">|</FONT> ENVnil <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=&gt;</FONT> ENVnil
  <FONT COLOR="#000000">|</FONT> ENVcons <FONT COLOR="#000000">(</FONT>e<FONT COLOR="#000000">,</FONT> env<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=&gt;</FONT> ENVcons <FONT COLOR="#000000">(</FONT>subst sub e<FONT COLOR="#000000">,</FONT> substEnv sub env<FONT COLOR="#000000">)</FONT>
<FONT COLOR="#000000">end</FONT> <FONT COLOR="#787878">// end of [substEnv]
</FONT>
<FONT COLOR="#000000">fun</FONT> expShi <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>G<FONT COLOR="#000000">:</FONT>env<FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>t1<FONT COLOR="#000000">,</FONT>t2<FONT COLOR="#000000">:</FONT>ty<FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#000000">(</FONT>e<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">EXP' <FONT COLOR="#000000">(</FONT>G<FONT COLOR="#000000">,</FONT> t1<FONT COLOR="#000000">)</FONT></FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">EXP' <FONT COLOR="#000000">(</FONT>t2 :: G<FONT COLOR="#000000">,</FONT> t1<FONT COLOR="#000000">)</FONT></FONT> <FONT COLOR="#000000">=</FONT>
  subst <FONT COLOR="#000000">(</FONT>shiSub <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT><FONT COLOR="#000000">..</FONT><FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT><FONT COLOR="#000000">..</FONT><FONT COLOR="#000000">}</FONT></FONT><FONT COLOR="#000000">)</FONT> e

<FONT COLOR="#000000">fun</FONT> envShi <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>G1<FONT COLOR="#000000">,</FONT>G2<FONT COLOR="#000000">:</FONT>env<FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>t<FONT COLOR="#000000">:</FONT>ty<FONT COLOR="#000000">}</FONT></FONT>
  <FONT COLOR="#000000">(</FONT>env<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">ENV <FONT COLOR="#000000">(</FONT>G1<FONT COLOR="#000000">,</FONT> G2<FONT COLOR="#000000">)</FONT></FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">ENV <FONT COLOR="#000000">(</FONT>t :: G1<FONT COLOR="#000000">,</FONT> G2<FONT COLOR="#000000">)</FONT></FONT> <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">begin</FONT>
  <FONT COLOR="#000000">case+</FONT> env <FONT COLOR="#000000">of</FONT>
  <FONT COLOR="#000000">|</FONT> ENVnil <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=&gt;</FONT> ENVnil
  <FONT COLOR="#000000">|</FONT> ENVcons <FONT COLOR="#000000">(</FONT>e<FONT COLOR="#000000">,</FONT> env<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=&gt;</FONT> ENVcons <FONT COLOR="#000000">(</FONT>expShi e<FONT COLOR="#000000">,</FONT> envShi env<FONT COLOR="#000000">)</FONT>
<FONT COLOR="#000000">end</FONT> <FONT COLOR="#787878">// end of [envShi]
</FONT>
<FONT COLOR="#000000">fun</FONT> envLam <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>G1<FONT COLOR="#000000">,</FONT>G2<FONT COLOR="#000000">:</FONT>env<FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>t<FONT COLOR="#000000">:</FONT>ty<FONT COLOR="#000000">}</FONT></FONT>
  <FONT COLOR="#000000">(</FONT>env<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">ENV <FONT COLOR="#000000">(</FONT>G1<FONT COLOR="#000000">,</FONT> G2<FONT COLOR="#000000">)</FONT></FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">ENV <FONT COLOR="#000000">(</FONT>t :: G1<FONT COLOR="#000000">,</FONT> t :: G2<FONT COLOR="#000000">)</FONT></FONT> <FONT COLOR="#000000">=</FONT>
  ENVcons <FONT COLOR="#000000">(</FONT>EXPone' <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">,</FONT> envShi env<FONT COLOR="#000000">)</FONT>

<FONT COLOR="#000000">fun</FONT> cc <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>G1<FONT COLOR="#000000">,</FONT>G2<FONT COLOR="#000000">:</FONT>env<FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>t<FONT COLOR="#000000">:</FONT>ty<FONT COLOR="#000000">}</FONT></FONT>
  <FONT COLOR="#000000">(</FONT>sub<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">SUB <FONT COLOR="#000000">(</FONT>G1<FONT COLOR="#000000">,</FONT> G2<FONT COLOR="#000000">)</FONT></FONT><FONT COLOR="#000000">,</FONT> env<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">ENV <FONT COLOR="#000000">(</FONT>G2<FONT COLOR="#000000">,</FONT> G2<FONT COLOR="#000000">)</FONT></FONT><FONT COLOR="#000000">,</FONT> e<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">EXP <FONT COLOR="#000000">(</FONT>G1<FONT COLOR="#000000">,</FONT> t<FONT COLOR="#000000">)</FONT></FONT><FONT COLOR="#000000">)</FONT>
  <FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">EXP' <FONT COLOR="#000000">(</FONT>G2<FONT COLOR="#000000">,</FONT> t<FONT COLOR="#000000">)</FONT></FONT> <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">begin</FONT> <FONT COLOR="#000000">case+</FONT> e <FONT COLOR="#000000">of</FONT>
  <FONT COLOR="#000000">|</FONT> EXPvar i <FONT COLOR="#000000">=&gt;</FONT> sub i
  <FONT COLOR="#000000">|</FONT> EXPlam e <FONT COLOR="#000000">=&gt;</FONT> EXPclo' <FONT COLOR="#000000">(</FONT>cc <FONT COLOR="#000000">(</FONT>subLam sub<FONT COLOR="#000000">,</FONT> envLam env<FONT COLOR="#000000">,</FONT> e<FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">,</FONT> env<FONT COLOR="#000000">)</FONT>
  <FONT COLOR="#000000">|</FONT> EXPapp <FONT COLOR="#000000">(</FONT>e1<FONT COLOR="#000000">,</FONT> e2<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=&gt;</FONT> EXPapp' <FONT COLOR="#000000">(</FONT>cc <FONT COLOR="#000000">(</FONT>sub<FONT COLOR="#000000">,</FONT> env<FONT COLOR="#000000">,</FONT> e1<FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">,</FONT> cc <FONT COLOR="#000000">(</FONT>sub<FONT COLOR="#000000">,</FONT> env<FONT COLOR="#000000">,</FONT> e2<FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT>
<FONT COLOR="#000000">end</FONT> <FONT COLOR="#787878">// end of [cc]
</FONT>
<FONT COLOR="#000000">fun</FONT> cc0 <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>t<FONT COLOR="#000000">:</FONT>ty<FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#000000">(</FONT>e<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">EXP0 <FONT COLOR="#000000">(</FONT>t<FONT COLOR="#000000">)</FONT></FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">EXP0' t</FONT> <FONT COLOR="#000000">=</FONT> cc <FONT COLOR="#000000">(</FONT>nilSub<FONT COLOR="#000000">,</FONT> ENVnil<FONT COLOR="#000000">,</FONT> e<FONT COLOR="#000000">)</FONT>

<FONT COLOR="#787878">//
</FONT>
<FONT COLOR="#787878">// some simple examples:
</FONT>
<FONT COLOR="#000000">fun</FONT> EXPone <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>G<FONT COLOR="#000000">:</FONT>env<FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>t<FONT COLOR="#000000">:</FONT>ty<FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">EXP <FONT COLOR="#000000">(</FONT>t :: G<FONT COLOR="#000000">,</FONT> t<FONT COLOR="#000000">)</FONT></FONT> <FONT COLOR="#000000">=</FONT>
  EXPvar <FONT COLOR="#000000">(</FONT>VARone<FONT COLOR="#000000">)</FONT>

<FONT COLOR="#000000">fun</FONT> EXPtwo <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>G<FONT COLOR="#000000">:</FONT>env<FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>t1<FONT COLOR="#000000">,</FONT>t2<FONT COLOR="#000000">:</FONT>ty<FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">EXP <FONT COLOR="#000000">(</FONT>t1 :: t2 :: G<FONT COLOR="#000000">,</FONT> t2<FONT COLOR="#000000">)</FONT></FONT> <FONT COLOR="#000000">=</FONT>
  EXPvar <FONT COLOR="#000000">(</FONT>VARshi VARone<FONT COLOR="#000000">)</FONT>

<FONT COLOR="#000000">fun</FONT> EXPthree <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>G<FONT COLOR="#000000">:</FONT>env<FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>t1<FONT COLOR="#000000">,</FONT>t2<FONT COLOR="#000000">,</FONT>t3<FONT COLOR="#000000">:</FONT>ty<FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">EXP <FONT COLOR="#000000">(</FONT>t1 :: t2 :: t3 :: G<FONT COLOR="#000000">,</FONT> t3<FONT COLOR="#000000">)</FONT></FONT> <FONT COLOR="#000000">=</FONT>
  EXPvar <FONT COLOR="#000000">(</FONT>VARshi <FONT COLOR="#000000">(</FONT>VARshi VARone<FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT>

<FONT COLOR="#787878">// lam x. x
</FONT><FONT COLOR="#000000">val</FONT> ans1 <FONT COLOR="#000000">=</FONT> cc0 <FONT COLOR="#000000">(</FONT>EXPlam <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>nil<FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>int<FONT COLOR="#000000">,</FONT>int<FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#000000">(</FONT>EXPone <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT>

<FONT COLOR="#787878">// lam x. lam y. y (x)
</FONT><FONT COLOR="#000000">val</FONT> ans2 <FONT COLOR="#000000">=</FONT> cc0 <FONT COLOR="#000000">(</FONT>EXPlam <FONT COLOR="#000000">(</FONT>EXPlam <FONT COLOR="#000000">(</FONT>EXPapp <FONT COLOR="#000000">(</FONT>EXPone <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">,</FONT> EXPtwo <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT>

<FONT COLOR="#787878">// lam x. lam y. lam z. z (x (y))
</FONT><FONT COLOR="#000000">val</FONT> ans3 <FONT COLOR="#000000">=</FONT> cc0 <FONT COLOR="#000000">(</FONT>EXPlam <FONT COLOR="#000000">(</FONT>EXPlam <FONT COLOR="#000000">(</FONT>EXPlam <FONT COLOR="#000000">(</FONT>EXPapp <FONT COLOR="#000000">(</FONT>EXPone <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">,</FONT> EXPapp <FONT COLOR="#000000">(</FONT>EXPtwo <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">,</FONT> EXPthree <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT>

<FONT COLOR="#787878">// lam x. lam y. x (y) (y)
</FONT><FONT COLOR="#000000">val</FONT> ans4 <FONT COLOR="#000000">=</FONT> cc0 <FONT COLOR="#000000">(</FONT>EXPlam <FONT COLOR="#000000">(</FONT>EXPlam <FONT COLOR="#000000">(</FONT>EXPapp <FONT COLOR="#000000">(</FONT>EXPapp <FONT COLOR="#000000">(</FONT>EXPtwo <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">,</FONT> EXPone <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">,</FONT> EXPone <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT>

<FONT COLOR="#787878">(* ****** ****** *)</FONT>

<FONT COLOR="#787878">(* end of [ClosureConv.dats] *)</FONT>
</PRE></BODY>

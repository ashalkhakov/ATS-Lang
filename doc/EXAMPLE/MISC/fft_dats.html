<BODY BGCOLOR="#E0E0E0" TEXT="#E80000"><PRE>
<FONT COLOR="#787878">(*
 *
 * This is a primitive irrational-base discrete weighted transform taken
 * from pseudocode found in: "Prime Numbers: A Computational Perspective"
 *
 * The code was originally written by Rick Lavoie and translated to ATS
 * by Hongwei Xi (November, 2005)
 *
 * Absolutely no optimization has gone into this code; written for clarity,
 * not speed.
 *
 *)</FONT>

<FONT COLOR="#787878">(*
 *
 * The code is ported to ATS/Geizella by Hongwei Xi (July 2007)
 *
 * test: 2 ^ 44497 - 1 is a prime! (BITSIZE = 16)
 * time: 357.479u 0.234s 5:59.57 99.4%	0+0k 0+0io 0pf+0w
 *
 * test: 2 ^ 110503 - 1 is a prime! (BITSIZE = 16) 
 * time: 2171.782u 2.094s 36:18.67 99.7% 0+0k 0+0io 0pf+0w
 *
 *)</FONT>

<FONT COLOR="#787878">//
</FONT>
<FONT COLOR="#000000">staload</FONT> <FONT COLOR="#0000FF">"libc/SATS/math.sats"</FONT>
<FONT COLOR="#000000">staload</FONT> <FONT COLOR="#0000FF">"libc/SATS/stdio.sats"</FONT>

<FONT COLOR="#A52A2A">%{^

#include "prelude/CATS/array.cats"
#include "libc/CATS/math.cats"
#include "libc/CATS/stdio.cats"

static inline
ats_double_type
double_of_double (ats_double_type x) { return x ; }

%}</FONT>

<FONT COLOR="#787878">//
</FONT>
<FONT COLOR="#000000">macdef</FONT> <FONT COLOR="#800080">PI <FONT COLOR="#000000">=</FONT> 3.1415926535897932384626</FONT>

<FONT COLOR="#787878">//
</FONT>
<FONT COLOR="#000000">typedef</FONT> <FONT COLOR="#0000FF">real <FONT COLOR="#000000">=</FONT> double</FONT>

<FONT COLOR="#000000">extern</FONT> <FONT COLOR="#000000">fun</FONT> real_of_double <FONT COLOR="#000000">(</FONT>d<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">double</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">:&lt;&gt;</FONT> <FONT COLOR="#0000FF">real</FONT> <FONT COLOR="#000000">=</FONT> "double_of_double"
<FONT COLOR="#000000">#define</FONT> <FONT COLOR="#800080">d2r real_of_double</FONT>

<FONT COLOR="#787878">// This is an experimental effort to differentiate imaginary from real
</FONT>
<FONT COLOR="#000000">abst@ype</FONT> <FONT COLOR="#0000FF">imag</FONT> <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">$extype</FONT> "ats_double_type"

<FONT COLOR="#000000">extern</FONT> <FONT COLOR="#000000">fun</FONT> imag_of_double <FONT COLOR="#000000">(</FONT>d<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">double</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">:&lt;&gt;</FONT> <FONT COLOR="#0000FF">imag</FONT>
  <FONT COLOR="#000000">=</FONT> "double_of_double"

<FONT COLOR="#000000">#define</FONT> <FONT COLOR="#800080">d2i imag_of_double</FONT>

<FONT COLOR="#000000">extern</FONT> <FONT COLOR="#000000">fun</FONT> add_imag_imag <FONT COLOR="#000000">(</FONT>x<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">imag</FONT><FONT COLOR="#000000">,</FONT> y<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">imag</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">imag</FONT>
  <FONT COLOR="#000000">=</FONT> "atspre_add_double_double"
<FONT COLOR="#000000">overload</FONT> <FONT COLOR="#800080">+ <FONT COLOR="#000000">with</FONT> add_imag_imag</FONT>

<FONT COLOR="#000000">extern</FONT> <FONT COLOR="#000000">fun</FONT> sub_imag_imag <FONT COLOR="#000000">(</FONT>x<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">imag</FONT><FONT COLOR="#000000">,</FONT> y<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">imag</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">imag</FONT>
  <FONT COLOR="#000000">=</FONT> "atspre_sub_double_double"
<FONT COLOR="#000000">overload</FONT> <FONT COLOR="#800080">- <FONT COLOR="#000000">with</FONT> sub_imag_imag</FONT>

<FONT COLOR="#000000">extern</FONT> <FONT COLOR="#000000">fun</FONT> mul_imag_imag <FONT COLOR="#000000">(</FONT>x<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">imag</FONT><FONT COLOR="#000000">,</FONT> y<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">imag</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">real</FONT>
  <FONT COLOR="#000000">=</FONT> "atspre_mul_double_double"

<FONT COLOR="#000000">extern</FONT> <FONT COLOR="#000000">fun</FONT> mul_real_imag <FONT COLOR="#000000">(</FONT>x<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">real</FONT><FONT COLOR="#000000">,</FONT> y<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">imag</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">imag</FONT>
  <FONT COLOR="#000000">=</FONT> "atspre_mul_double_double"

<FONT COLOR="#000000">extern</FONT> <FONT COLOR="#000000">fun</FONT> mul_imag_real <FONT COLOR="#000000">(</FONT>x<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">imag</FONT><FONT COLOR="#000000">,</FONT> y<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">real</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">imag</FONT>
  <FONT COLOR="#000000">=</FONT> "atspre_mul_double_double"

<FONT COLOR="#000000">overload</FONT> <FONT COLOR="#800080">* <FONT COLOR="#000000">with</FONT> mul_imag_imag</FONT>
<FONT COLOR="#000000">overload</FONT> <FONT COLOR="#800080">* <FONT COLOR="#000000">with</FONT> mul_real_imag</FONT>
<FONT COLOR="#000000">overload</FONT> <FONT COLOR="#800080">* <FONT COLOR="#000000">with</FONT> mul_imag_real</FONT>

<FONT COLOR="#787878">//
</FONT>
<FONT COLOR="#000000">#define</FONT> <FONT COLOR="#800080">i2d double_of_int</FONT>

<FONT COLOR="#787878">//
</FONT>
<FONT COLOR="#000000">fn</FONT> compute_signal_sum <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>n<FONT COLOR="#000000">:</FONT>nat<FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>l<FONT COLOR="#000000">:</FONT>addr<FONT COLOR="#000000">}</FONT></FONT>
  <FONT COLOR="#000000">(</FONT><FONT COLOR="#009000">pf<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">!</FONT>array_v <FONT COLOR="#000000">(</FONT>real<FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">,</FONT> l<FONT COLOR="#000000">)</FONT></FONT></FONT> <FONT COLOR="#000000">|</FONT> A<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">ptr l</FONT><FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">int n</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">real</FONT> <FONT COLOR="#000000">=</FONT>
  <FONT COLOR="#000000">let</FONT>
     <FONT COLOR="#000000">fun</FONT> loop <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>i<FONT COLOR="#000000">:</FONT>nat <FONT COLOR="#000000">|</FONT> i &lt;= n<FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">.&lt;</FONT>n-i<FONT COLOR="#000000">&gt;.</FONT></FONT> <FONT COLOR="#000000">(</FONT>
         <FONT COLOR="#009000">pf<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">!</FONT>array_v <FONT COLOR="#000000">(</FONT>real<FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">,</FONT> l<FONT COLOR="#000000">)</FONT></FONT></FONT> <FONT COLOR="#000000">|</FONT> i<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">int i</FONT><FONT COLOR="#000000">,</FONT> res<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">real</FONT>
       <FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">:&lt;</FONT><FONT COLOR="#0000FF">cloptr1</FONT><FONT COLOR="#000000">&gt;</FONT> <FONT COLOR="#0000FF">real</FONT> <FONT COLOR="#000000">=</FONT>
       <FONT COLOR="#000000">if</FONT> i <FONT COLOR="#000000">&lt;</FONT> n <FONT COLOR="#000000">then</FONT> loop <FONT COLOR="#000000">(</FONT><FONT COLOR="#009000">pf</FONT> <FONT COLOR="#000000">|</FONT> i+1<FONT COLOR="#000000">,</FONT> res + A[<FONT COLOR="#009000">i</FONT><FONT COLOR="#000000">]</FONT><FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">else</FONT> res
  <FONT COLOR="#000000">in</FONT>
     loop <FONT COLOR="#000000">(</FONT><FONT COLOR="#009000">pf</FONT> <FONT COLOR="#000000">|</FONT> 0<FONT COLOR="#000000">,</FONT> d2r 0.0<FONT COLOR="#000000">)</FONT>
  <FONT COLOR="#000000">end</FONT>

<FONT COLOR="#000000">fn</FONT> convolve_signal <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>n<FONT COLOR="#000000">:</FONT>nat<FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>l_r<FONT COLOR="#000000">,</FONT>l_i<FONT COLOR="#000000">:</FONT>addr<FONT COLOR="#000000">}</FONT></FONT>
  <FONT COLOR="#000000">(</FONT><FONT COLOR="#009000">pf_r<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">!</FONT>array_v <FONT COLOR="#000000">(</FONT>real<FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">,</FONT> l_r<FONT COLOR="#000000">)</FONT></FONT></FONT><FONT COLOR="#000000">,</FONT> <FONT COLOR="#009000">pf_i<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">!</FONT>array_v <FONT COLOR="#000000">(</FONT>imag<FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">,</FONT> l_i<FONT COLOR="#000000">)</FONT></FONT></FONT> <FONT COLOR="#000000">|</FONT>
   R<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">ptr l_r</FONT><FONT COLOR="#000000">,</FONT> I<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">ptr l_i</FONT><FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">int n</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">void</FONT> <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">let</FONT>
  <FONT COLOR="#000000">fun</FONT> loop <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>i<FONT COLOR="#000000">:</FONT>nat <FONT COLOR="#000000">|</FONT> i &lt;= n<FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">.&lt;</FONT>n-i<FONT COLOR="#000000">&gt;.</FONT></FONT> <FONT COLOR="#000000">(</FONT>
      <FONT COLOR="#009000">pf_r<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">!</FONT>array_v <FONT COLOR="#000000">(</FONT>real<FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">,</FONT> l_r<FONT COLOR="#000000">)</FONT></FONT></FONT>
    <FONT COLOR="#000000">,</FONT> <FONT COLOR="#009000">pf_i<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">!</FONT>array_v <FONT COLOR="#000000">(</FONT>imag<FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">,</FONT> l_i<FONT COLOR="#000000">)</FONT></FONT></FONT>
    <FONT COLOR="#000000">|</FONT> i<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">int i</FONT>
    <FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">:&lt;</FONT><FONT COLOR="#0000FF">cloptr1</FONT><FONT COLOR="#000000">&gt;</FONT> <FONT COLOR="#0000FF">void</FONT> <FONT COLOR="#000000">=</FONT>
    <FONT COLOR="#000000">if</FONT> i <FONT COLOR="#000000">&lt;</FONT> n <FONT COLOR="#000000">then</FONT> <FONT COLOR="#000000">let</FONT>
      <FONT COLOR="#000000">val</FONT> t_r <FONT COLOR="#000000">=</FONT> R[<FONT COLOR="#009000">i</FONT><FONT COLOR="#000000">]</FONT> <FONT COLOR="#000000">and</FONT> t_i <FONT COLOR="#000000">=</FONT> I[<FONT COLOR="#009000">i</FONT><FONT COLOR="#000000">]</FONT>
      <FONT COLOR="#000000">val</FONT> t_rr <FONT COLOR="#000000">=</FONT> t_r * t_r <FONT COLOR="#000000">and</FONT> t_ii <FONT COLOR="#000000">=</FONT> t_i * t_i <FONT COLOR="#000000">and</FONT> t_ri <FONT COLOR="#000000">=</FONT> t_r * t_i
    <FONT COLOR="#000000">in</FONT>
      R[<FONT COLOR="#009000">i</FONT><FONT COLOR="#000000">]</FONT> := t_rr - t_ii<FONT COLOR="#000000">;</FONT> I[<FONT COLOR="#009000">i</FONT><FONT COLOR="#000000">]</FONT> := t_ri + t_ri<FONT COLOR="#000000">;</FONT> loop <FONT COLOR="#000000">(</FONT><FONT COLOR="#009000">pf_r</FONT><FONT COLOR="#000000">,</FONT> <FONT COLOR="#009000">pf_i</FONT> <FONT COLOR="#000000">|</FONT> i+1<FONT COLOR="#000000">)</FONT>
    <FONT COLOR="#000000">end</FONT> <FONT COLOR="#000000">else</FONT> <FONT COLOR="#000000">begin</FONT>
      <FONT COLOR="#787878">// this is empty
</FONT>    <FONT COLOR="#000000">end</FONT> 
<FONT COLOR="#000000">in</FONT>
  loop <FONT COLOR="#000000">(</FONT><FONT COLOR="#009000">pf_r</FONT><FONT COLOR="#000000">,</FONT> <FONT COLOR="#009000">pf_i</FONT> <FONT COLOR="#000000">|</FONT> 0<FONT COLOR="#000000">)</FONT>
<FONT COLOR="#000000">end</FONT> <FONT COLOR="#787878">// end of [convolve_signal]
</FONT>
<FONT COLOR="#000000">fn</FONT> round_signal <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>n<FONT COLOR="#000000">:</FONT>nat<FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>l_r<FONT COLOR="#000000">,</FONT>l_i<FONT COLOR="#000000">:</FONT>addr<FONT COLOR="#000000">}</FONT></FONT>
  <FONT COLOR="#000000">(</FONT><FONT COLOR="#009000">pf_r<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">!</FONT>array_v <FONT COLOR="#000000">(</FONT>real<FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">,</FONT> l_r<FONT COLOR="#000000">)</FONT></FONT></FONT><FONT COLOR="#000000">,</FONT> <FONT COLOR="#009000">pf_i<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">!</FONT>array_v <FONT COLOR="#000000">(</FONT>imag<FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">,</FONT> l_i<FONT COLOR="#000000">)</FONT></FONT></FONT> <FONT COLOR="#000000">|</FONT>
   R<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">ptr l_r</FONT><FONT COLOR="#000000">,</FONT> I<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">ptr l_i</FONT><FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">int n</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">void</FONT> <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">let</FONT>
  <FONT COLOR="#000000">fun</FONT> loop <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>i<FONT COLOR="#000000">:</FONT>nat <FONT COLOR="#000000">|</FONT> i &lt;= n<FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">.&lt;</FONT>n-i<FONT COLOR="#000000">&gt;.</FONT></FONT> <FONT COLOR="#000000">(</FONT>
      <FONT COLOR="#009000">pf_r<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">!</FONT>array_v <FONT COLOR="#000000">(</FONT>real<FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">,</FONT> l_r<FONT COLOR="#000000">)</FONT></FONT></FONT>
    <FONT COLOR="#000000">,</FONT> <FONT COLOR="#009000">pf_i<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">!</FONT>array_v <FONT COLOR="#000000">(</FONT>imag<FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">,</FONT> l_i<FONT COLOR="#000000">)</FONT></FONT></FONT>
    <FONT COLOR="#000000">|</FONT> i<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">int i</FONT>
    <FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">:&lt;</FONT><FONT COLOR="#0000FF">cloptr1</FONT><FONT COLOR="#000000">&gt;</FONT> <FONT COLOR="#0000FF">void</FONT> <FONT COLOR="#000000">=</FONT>
    <FONT COLOR="#000000">if</FONT> i <FONT COLOR="#000000">&lt;</FONT> n <FONT COLOR="#000000">then</FONT> <FONT COLOR="#000000">begin</FONT>
      R[<FONT COLOR="#009000">i</FONT><FONT COLOR="#000000">]</FONT> := floor <FONT COLOR="#000000">(</FONT>R[<FONT COLOR="#009000">i</FONT><FONT COLOR="#000000">]</FONT> + d2r 0.5<FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">;</FONT> I[<FONT COLOR="#009000">i</FONT><FONT COLOR="#000000">]</FONT> := d2i <FONT COLOR="#000000">(</FONT>0.0<FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">;</FONT> loop <FONT COLOR="#000000">(</FONT><FONT COLOR="#009000">pf_r</FONT><FONT COLOR="#000000">,</FONT> <FONT COLOR="#009000">pf_i</FONT> <FONT COLOR="#000000">|</FONT> i+1<FONT COLOR="#000000">)</FONT>
    <FONT COLOR="#000000">end</FONT>
<FONT COLOR="#000000">in</FONT>
  loop <FONT COLOR="#000000">(</FONT><FONT COLOR="#009000">pf_r</FONT><FONT COLOR="#000000">,</FONT> <FONT COLOR="#009000">pf_i</FONT> <FONT COLOR="#000000">|</FONT> 0<FONT COLOR="#000000">)</FONT>
<FONT COLOR="#000000">end</FONT> <FONT COLOR="#787878">// end of [round_signal]
</FONT>
<FONT COLOR="#787878">//
</FONT>
<FONT COLOR="#000000">fun</FONT> forward_fft <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>n<FONT COLOR="#000000">:</FONT>nat<FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>l_r<FONT COLOR="#000000">,</FONT> l_i<FONT COLOR="#000000">,</FONT> l_w<FONT COLOR="#000000">:</FONT>addr<FONT COLOR="#000000">}</FONT></FONT>
   <FONT COLOR="#000000">(</FONT><FONT COLOR="#009000">pf_r<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">!</FONT>array_v <FONT COLOR="#000000">(</FONT>real<FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">,</FONT> l_r<FONT COLOR="#000000">)</FONT></FONT></FONT> <FONT COLOR="#000000">,</FONT>
    <FONT COLOR="#009000">pf_i<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">!</FONT>array_v <FONT COLOR="#000000">(</FONT>imag<FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">,</FONT> l_i<FONT COLOR="#000000">)</FONT></FONT></FONT> <FONT COLOR="#000000">,</FONT>
    <FONT COLOR="#009000">pf_w<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">!</FONT>array_v <FONT COLOR="#000000">(</FONT>real<FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">,</FONT> l_w<FONT COLOR="#000000">)</FONT></FONT></FONT> <FONT COLOR="#000000">|</FONT>
    R<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">ptr l_r</FONT><FONT COLOR="#000000">,</FONT> I<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">ptr l_i</FONT><FONT COLOR="#000000">,</FONT> W<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">ptr l_w</FONT><FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">int n</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">real</FONT> <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">let</FONT>

  <FONT COLOR="#000000">fun</FONT> aux0 <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>i<FONT COLOR="#000000">:</FONT>nat <FONT COLOR="#000000">|</FONT> i &lt;= n<FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">.&lt;</FONT>n-i<FONT COLOR="#000000">&gt;.</FONT></FONT> <FONT COLOR="#000000">(</FONT>
      <FONT COLOR="#009000">pf_r<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">!</FONT>array_v <FONT COLOR="#000000">(</FONT>real<FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">,</FONT> l_r<FONT COLOR="#000000">)</FONT></FONT></FONT>
    <FONT COLOR="#000000">,</FONT> <FONT COLOR="#009000">pf_w<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">!</FONT>array_v <FONT COLOR="#000000">(</FONT>real<FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">,</FONT> l_w<FONT COLOR="#000000">)</FONT></FONT></FONT>
    <FONT COLOR="#000000">|</FONT> i<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">int i</FONT>
    <FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">:&lt;</FONT><FONT COLOR="#0000FF">cloptr1</FONT><FONT COLOR="#000000">&gt;</FONT> <FONT COLOR="#0000FF">void</FONT> <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">begin</FONT>
    <FONT COLOR="#000000">if</FONT> i <FONT COLOR="#000000">&lt;</FONT> n <FONT COLOR="#000000">then</FONT> <FONT COLOR="#000000">(</FONT>R[<FONT COLOR="#009000">i</FONT><FONT COLOR="#000000">]</FONT> := R[<FONT COLOR="#009000">i</FONT><FONT COLOR="#000000">]</FONT> * W[<FONT COLOR="#009000">i</FONT><FONT COLOR="#000000">]</FONT><FONT COLOR="#000000">;</FONT> aux0 <FONT COLOR="#000000">(</FONT><FONT COLOR="#009000">pf_r</FONT><FONT COLOR="#000000">,</FONT> <FONT COLOR="#009000">pf_w</FONT> <FONT COLOR="#000000">|</FONT> i+1<FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">else</FONT> <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT>
  <FONT COLOR="#000000">end</FONT>

  <FONT COLOR="#000000">fun</FONT> aux1 <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>i<FONT COLOR="#000000">,</FONT>m<FONT COLOR="#000000">:</FONT>nat<FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#000000">(</FONT>
      <FONT COLOR="#009000">pf_r<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">!</FONT>array_v <FONT COLOR="#000000">(</FONT>real<FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">,</FONT> l_r<FONT COLOR="#000000">)</FONT></FONT></FONT>
    <FONT COLOR="#000000">,</FONT> <FONT COLOR="#009000">pf_i<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">!</FONT>array_v <FONT COLOR="#000000">(</FONT>imag<FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">,</FONT> l_i<FONT COLOR="#000000">)</FONT></FONT></FONT>
    <FONT COLOR="#000000">|</FONT> i<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">int i</FONT><FONT COLOR="#000000">,</FONT> m<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">int m</FONT><FONT COLOR="#000000">,</FONT> a_r<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">real</FONT><FONT COLOR="#000000">,</FONT> a_i<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">imag</FONT>
    <FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">:&lt;</FONT><FONT COLOR="#0000FF">cloptr1</FONT><FONT COLOR="#000000">&gt;</FONT> <FONT COLOR="#0000FF">void</FONT> <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">let</FONT>
    <FONT COLOR="#000000">val</FONT> im <FONT COLOR="#000000">=</FONT> i + m
  <FONT COLOR="#000000">in</FONT>
    <FONT COLOR="#000000">if</FONT> im <FONT COLOR="#000000">&lt;</FONT> n <FONT COLOR="#000000">then</FONT> <FONT COLOR="#000000">let</FONT>
      <FONT COLOR="#000000">val</FONT> t1_r <FONT COLOR="#000000">=</FONT> R[<FONT COLOR="#009000">im</FONT><FONT COLOR="#000000">]</FONT> <FONT COLOR="#000000">and</FONT> t1_i <FONT COLOR="#000000">=</FONT> I[<FONT COLOR="#009000">im</FONT><FONT COLOR="#000000">]</FONT>
      <FONT COLOR="#000000">val</FONT> t2_r <FONT COLOR="#000000">=</FONT> R[<FONT COLOR="#009000">i</FONT><FONT COLOR="#000000">]</FONT> <FONT COLOR="#000000">and</FONT> t2_i <FONT COLOR="#000000">=</FONT> I[<FONT COLOR="#009000">i</FONT><FONT COLOR="#000000">]</FONT>
      <FONT COLOR="#000000">val</FONT> <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> R[<FONT COLOR="#009000">i</FONT><FONT COLOR="#000000">]</FONT> := t2_r + t1_r
      <FONT COLOR="#000000">and</FONT> <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> I[<FONT COLOR="#009000">i</FONT><FONT COLOR="#000000">]</FONT> := t2_i + t1_i
      <FONT COLOR="#000000">val</FONT> t1_r <FONT COLOR="#000000">=</FONT> t2_r - t1_r <FONT COLOR="#000000">and</FONT> t1_i <FONT COLOR="#000000">=</FONT> t2_i - t1_i
      <FONT COLOR="#000000">val</FONT> <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> R[<FONT COLOR="#009000">im</FONT><FONT COLOR="#000000">]</FONT> := a_r * t1_r - a_i * t1_i
      <FONT COLOR="#000000">val</FONT> <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> I[<FONT COLOR="#009000">im</FONT><FONT COLOR="#000000">]</FONT> := a_r * t1_i + a_i * t1_r
    <FONT COLOR="#000000">in</FONT>
      aux1 <FONT COLOR="#000000">(</FONT><FONT COLOR="#009000">pf_r</FONT><FONT COLOR="#000000">,</FONT> <FONT COLOR="#009000">pf_i</FONT> <FONT COLOR="#000000">|</FONT> im + m<FONT COLOR="#000000">,</FONT> m<FONT COLOR="#000000">,</FONT> a_r<FONT COLOR="#000000">,</FONT> a_i<FONT COLOR="#000000">)</FONT>
    <FONT COLOR="#000000">end</FONT> <FONT COLOR="#000000">else</FONT> <FONT COLOR="#000000">begin</FONT>
      <FONT COLOR="#787878">// this is empty
</FONT>    <FONT COLOR="#000000">end</FONT>
  <FONT COLOR="#000000">end</FONT> <FONT COLOR="#787878">// end of [aux1]
</FONT>
  <FONT COLOR="#000000">fun</FONT> aux2 <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>j<FONT COLOR="#000000">,</FONT>m<FONT COLOR="#000000">:</FONT>nat<FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#000000">(</FONT>
      <FONT COLOR="#009000">pf_r<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">!</FONT>array_v <FONT COLOR="#000000">(</FONT>real<FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">,</FONT> l_r<FONT COLOR="#000000">)</FONT></FONT></FONT>
    <FONT COLOR="#000000">,</FONT> <FONT COLOR="#009000">pf_i<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">!</FONT>array_v <FONT COLOR="#000000">(</FONT>imag<FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">,</FONT> l_i<FONT COLOR="#000000">)</FONT></FONT></FONT>
    <FONT COLOR="#000000">|</FONT> j<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">int j</FONT><FONT COLOR="#000000">,</FONT> m<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">int m</FONT>
    <FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">:&lt;</FONT><FONT COLOR="#0000FF">cloptr1</FONT><FONT COLOR="#000000">&gt;</FONT> <FONT COLOR="#0000FF">void</FONT> <FONT COLOR="#000000">=</FONT>
    <FONT COLOR="#000000">if</FONT> j <FONT COLOR="#000000">&lt;</FONT> m <FONT COLOR="#000000">then</FONT> <FONT COLOR="#000000">let</FONT>
      <FONT COLOR="#000000">val</FONT> theta <FONT COLOR="#000000">=</FONT> d2r <FONT COLOR="#000000">(</FONT>PI * <FONT COLOR="#000000">(</FONT>i2d j<FONT COLOR="#000000">)</FONT> / <FONT COLOR="#000000">(</FONT>i2d m<FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT>
    <FONT COLOR="#000000">in</FONT>
      aux1 <FONT COLOR="#000000">(</FONT><FONT COLOR="#009000">pf_r</FONT><FONT COLOR="#000000">,</FONT> <FONT COLOR="#009000">pf_i</FONT> <FONT COLOR="#000000">|</FONT> j<FONT COLOR="#000000">,</FONT> m<FONT COLOR="#000000">,</FONT> d2r <FONT COLOR="#000000">(</FONT>cos theta<FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">,</FONT> d2i <FONT COLOR="#000000">~</FONT><FONT COLOR="#000000">(</FONT>sin theta<FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">;</FONT>
      aux2 <FONT COLOR="#000000">(</FONT><FONT COLOR="#009000">pf_r</FONT><FONT COLOR="#000000">,</FONT> <FONT COLOR="#009000">pf_i</FONT> <FONT COLOR="#000000">|</FONT> j+1<FONT COLOR="#000000">,</FONT> m<FONT COLOR="#000000">)</FONT>
    <FONT COLOR="#000000">end</FONT>

  <FONT COLOR="#000000">fun</FONT> aux3 <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>m<FONT COLOR="#000000">:</FONT>nat<FONT COLOR="#000000">}</FONT></FONT>
    <FONT COLOR="#000000">(</FONT><FONT COLOR="#009000">pf_r<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">!</FONT>array_v <FONT COLOR="#000000">(</FONT>real<FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">,</FONT> l_r<FONT COLOR="#000000">)</FONT></FONT></FONT><FONT COLOR="#000000">,</FONT> <FONT COLOR="#009000">pf_i<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">!</FONT>array_v <FONT COLOR="#000000">(</FONT>imag<FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">,</FONT> l_i<FONT COLOR="#000000">)</FONT></FONT></FONT> <FONT COLOR="#000000">|</FONT> m<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">int m</FONT><FONT COLOR="#000000">)</FONT>
    <FONT COLOR="#000000">:&lt;</FONT><FONT COLOR="#0000FF">cloptr1</FONT><FONT COLOR="#000000">&gt;</FONT> <FONT COLOR="#0000FF">void</FONT> <FONT COLOR="#000000">=</FONT>
    <FONT COLOR="#000000">if</FONT> m &gt;= 1 <FONT COLOR="#000000">then</FONT> <FONT COLOR="#000000">(</FONT>aux2 <FONT COLOR="#000000">(</FONT><FONT COLOR="#009000">pf_r</FONT><FONT COLOR="#000000">,</FONT> <FONT COLOR="#009000">pf_i</FONT> <FONT COLOR="#000000">|</FONT> 0<FONT COLOR="#000000">,</FONT> m<FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">;</FONT> aux3 <FONT COLOR="#000000">(</FONT><FONT COLOR="#009000">pf_r</FONT><FONT COLOR="#000000">,</FONT> <FONT COLOR="#009000">pf_i</FONT> <FONT COLOR="#000000">|</FONT> nhalf m<FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT>

  <FONT COLOR="#000000">val</FONT> <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> aux0 <FONT COLOR="#000000">(</FONT><FONT COLOR="#009000">pf_r</FONT><FONT COLOR="#000000">,</FONT> <FONT COLOR="#009000">pf_w</FONT> <FONT COLOR="#000000">|</FONT> 0<FONT COLOR="#000000">)</FONT>
  <FONT COLOR="#000000">val</FONT> sum <FONT COLOR="#000000">=</FONT> compute_signal_sum <FONT COLOR="#000000">(</FONT><FONT COLOR="#009000">pf_r</FONT> <FONT COLOR="#000000">|</FONT> R<FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">)</FONT>
<FONT COLOR="#000000">in</FONT>
  aux3 <FONT COLOR="#000000">(</FONT><FONT COLOR="#009000">pf_r</FONT><FONT COLOR="#000000">,</FONT> <FONT COLOR="#009000">pf_i</FONT> <FONT COLOR="#000000">|</FONT> nhalf n<FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">;</FONT> sum
<FONT COLOR="#000000">end</FONT> <FONT COLOR="#787878">// end of [forward_fft]
</FONT>
<FONT COLOR="#787878">//
</FONT>
<FONT COLOR="#000000">fun</FONT> inverse_fft <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>n<FONT COLOR="#000000">:</FONT>nat<FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>l_r<FONT COLOR="#000000">,</FONT> l_i<FONT COLOR="#000000">,</FONT> l_w<FONT COLOR="#000000">:</FONT>addr<FONT COLOR="#000000">}</FONT></FONT>
  <FONT COLOR="#000000">(</FONT><FONT COLOR="#009000">pf_r<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">!</FONT>array_v <FONT COLOR="#000000">(</FONT>real<FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">,</FONT> l_r<FONT COLOR="#000000">)</FONT></FONT></FONT> <FONT COLOR="#000000">,</FONT>
   <FONT COLOR="#009000">pf_i<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">!</FONT>array_v <FONT COLOR="#000000">(</FONT>imag<FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">,</FONT> l_i<FONT COLOR="#000000">)</FONT></FONT></FONT> <FONT COLOR="#000000">,</FONT>
   <FONT COLOR="#009000">pf_w<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">!</FONT>array_v <FONT COLOR="#000000">(</FONT>real<FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">,</FONT> l_w<FONT COLOR="#000000">)</FONT></FONT></FONT> <FONT COLOR="#000000">|</FONT>
   R<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">ptr l_r</FONT><FONT COLOR="#000000">,</FONT> I<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">ptr l_i</FONT><FONT COLOR="#000000">,</FONT> W<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">ptr l_w</FONT><FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">int n</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">real</FONT> <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">let</FONT>
  <FONT COLOR="#000000">fun</FONT> aux1 <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>i<FONT COLOR="#000000">,</FONT>m<FONT COLOR="#000000">:</FONT>nat<FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#000000">(</FONT>
      <FONT COLOR="#009000">pf_r<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">!</FONT>array_v <FONT COLOR="#000000">(</FONT>real<FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">,</FONT> l_r<FONT COLOR="#000000">)</FONT></FONT></FONT>
    <FONT COLOR="#000000">,</FONT> <FONT COLOR="#009000">pf_i<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">!</FONT>array_v <FONT COLOR="#000000">(</FONT>imag<FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">,</FONT> l_i<FONT COLOR="#000000">)</FONT></FONT></FONT>
    <FONT COLOR="#000000">|</FONT> i<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">int i</FONT><FONT COLOR="#000000">,</FONT> m<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">int m</FONT><FONT COLOR="#000000">,</FONT> a_r<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">real</FONT><FONT COLOR="#000000">,</FONT> a_i<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">imag</FONT>
    <FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">:&lt;</FONT><FONT COLOR="#0000FF">cloptr1</FONT><FONT COLOR="#000000">&gt;</FONT> <FONT COLOR="#0000FF">void</FONT> <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">let</FONT>
    <FONT COLOR="#000000">val</FONT> im <FONT COLOR="#000000">=</FONT> i + m
  <FONT COLOR="#000000">in</FONT>
    <FONT COLOR="#000000">if</FONT> im <FONT COLOR="#000000">&lt;</FONT> n <FONT COLOR="#000000">then</FONT> <FONT COLOR="#000000">let</FONT>
      <FONT COLOR="#000000">val</FONT> c_r <FONT COLOR="#000000">=</FONT> R[<FONT COLOR="#009000">im</FONT><FONT COLOR="#000000">]</FONT> <FONT COLOR="#000000">and</FONT> c_i <FONT COLOR="#000000">=</FONT> I[<FONT COLOR="#009000">im</FONT><FONT COLOR="#000000">]</FONT>
      <FONT COLOR="#000000">val</FONT> t1_r <FONT COLOR="#000000">=</FONT> c_r * a_r - c_i * a_i
      <FONT COLOR="#000000">and</FONT> t1_i <FONT COLOR="#000000">=</FONT> c_r * a_i + c_i * a_r
      <FONT COLOR="#000000">val</FONT> t2_r <FONT COLOR="#000000">=</FONT> R[<FONT COLOR="#009000">i</FONT><FONT COLOR="#000000">]</FONT> <FONT COLOR="#000000">and</FONT> t2_i <FONT COLOR="#000000">=</FONT> I[<FONT COLOR="#009000">i</FONT><FONT COLOR="#000000">]</FONT>
      <FONT COLOR="#000000">val</FONT> <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> R[<FONT COLOR="#009000">i</FONT><FONT COLOR="#000000">]</FONT> := t2_r + t1_r <FONT COLOR="#000000">and</FONT> <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> I[<FONT COLOR="#009000">i</FONT><FONT COLOR="#000000">]</FONT> := t2_i + t1_i
      <FONT COLOR="#000000">val</FONT> <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> R[<FONT COLOR="#009000">im</FONT><FONT COLOR="#000000">]</FONT> := t2_r - t1_r <FONT COLOR="#000000">and</FONT> <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> I[<FONT COLOR="#009000">im</FONT><FONT COLOR="#000000">]</FONT> := t2_i - t1_i
    <FONT COLOR="#000000">in</FONT>
      aux1 <FONT COLOR="#000000">(</FONT><FONT COLOR="#009000">pf_r</FONT><FONT COLOR="#000000">,</FONT> <FONT COLOR="#009000">pf_i</FONT> <FONT COLOR="#000000">|</FONT> im + m<FONT COLOR="#000000">,</FONT> m<FONT COLOR="#000000">,</FONT> a_r<FONT COLOR="#000000">,</FONT> a_i<FONT COLOR="#000000">)</FONT>
    <FONT COLOR="#000000">end</FONT>
  <FONT COLOR="#000000">end</FONT>

  <FONT COLOR="#000000">fun</FONT> aux2 <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>j<FONT COLOR="#000000">,</FONT>m<FONT COLOR="#000000">:</FONT>nat<FONT COLOR="#000000">}</FONT></FONT>
    <FONT COLOR="#000000">(</FONT><FONT COLOR="#009000">pf_r<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">!</FONT>array_v <FONT COLOR="#000000">(</FONT>real<FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">,</FONT> l_r<FONT COLOR="#000000">)</FONT></FONT></FONT><FONT COLOR="#000000">,</FONT> <FONT COLOR="#009000">pf_i<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">!</FONT>array_v <FONT COLOR="#000000">(</FONT>imag<FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">,</FONT> l_i<FONT COLOR="#000000">)</FONT></FONT></FONT> <FONT COLOR="#000000">|</FONT>
     j<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">int j</FONT><FONT COLOR="#000000">,</FONT> m<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">int m</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">:&lt;</FONT><FONT COLOR="#0000FF">cloptr1</FONT><FONT COLOR="#000000">&gt;</FONT> <FONT COLOR="#0000FF">void</FONT> <FONT COLOR="#000000">=</FONT>
    <FONT COLOR="#000000">if</FONT> j <FONT COLOR="#000000">&lt;</FONT> m <FONT COLOR="#000000">then</FONT> <FONT COLOR="#000000">let</FONT>
      <FONT COLOR="#000000">val</FONT> theta <FONT COLOR="#000000">=</FONT> d2r <FONT COLOR="#000000">(</FONT>PI * <FONT COLOR="#000000">(</FONT>i2d j<FONT COLOR="#000000">)</FONT> / <FONT COLOR="#000000">(</FONT>i2d m<FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT>
    <FONT COLOR="#000000">in</FONT>
      aux1 <FONT COLOR="#000000">(</FONT><FONT COLOR="#009000">pf_r</FONT><FONT COLOR="#000000">,</FONT> <FONT COLOR="#009000">pf_i</FONT> <FONT COLOR="#000000">|</FONT> j<FONT COLOR="#000000">,</FONT> m<FONT COLOR="#000000">,</FONT> d2r <FONT COLOR="#000000">(</FONT>cos theta<FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">,</FONT> d2i <FONT COLOR="#000000">(</FONT>sin theta<FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">;</FONT>
      aux2 <FONT COLOR="#000000">(</FONT><FONT COLOR="#009000">pf_r</FONT><FONT COLOR="#000000">,</FONT> <FONT COLOR="#009000">pf_i</FONT> <FONT COLOR="#000000">|</FONT> j+1<FONT COLOR="#000000">,</FONT> m<FONT COLOR="#000000">)</FONT>
    <FONT COLOR="#000000">end</FONT>

  <FONT COLOR="#000000">fun</FONT> aux3 <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>m<FONT COLOR="#000000">:</FONT>nat<FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#000000">(</FONT>
      <FONT COLOR="#009000">pf_r<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">!</FONT>array_v <FONT COLOR="#000000">(</FONT>real<FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">,</FONT> l_r<FONT COLOR="#000000">)</FONT></FONT></FONT>
    <FONT COLOR="#000000">,</FONT> <FONT COLOR="#009000">pf_i<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">!</FONT>array_v <FONT COLOR="#000000">(</FONT>imag<FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">,</FONT> l_i<FONT COLOR="#000000">)</FONT></FONT></FONT>
    <FONT COLOR="#000000">|</FONT> m<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">int m</FONT>
    <FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">:&lt;</FONT><FONT COLOR="#0000FF">cloptr1</FONT><FONT COLOR="#000000">&gt;</FONT> <FONT COLOR="#0000FF">void</FONT> <FONT COLOR="#000000">=</FONT>
    <FONT COLOR="#000000">if</FONT> m <FONT COLOR="#000000">&lt;</FONT> n <FONT COLOR="#000000">then</FONT> <FONT COLOR="#000000">(</FONT>aux2 <FONT COLOR="#000000">(</FONT><FONT COLOR="#009000">pf_r</FONT><FONT COLOR="#000000">,</FONT> <FONT COLOR="#009000">pf_i</FONT> <FONT COLOR="#000000">|</FONT> 0<FONT COLOR="#000000">,</FONT> m<FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">;</FONT> aux3 <FONT COLOR="#000000">(</FONT><FONT COLOR="#009000">pf_r</FONT><FONT COLOR="#000000">,</FONT> <FONT COLOR="#009000">pf_i</FONT> <FONT COLOR="#000000">|</FONT> m+m<FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT>

  <FONT COLOR="#000000">fun</FONT> aux4 <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>i<FONT COLOR="#000000">:</FONT>nat <FONT COLOR="#000000">|</FONT> i &lt;= n<FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#000000">(</FONT>
      <FONT COLOR="#009000">pf_r<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">!</FONT>array_v <FONT COLOR="#000000">(</FONT>real<FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">,</FONT> l_r<FONT COLOR="#000000">)</FONT></FONT></FONT> <FONT COLOR="#000000">|</FONT> i<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">int i</FONT><FONT COLOR="#000000">,</FONT> nf<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">real</FONT>
    <FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">:&lt;</FONT><FONT COLOR="#0000FF">cloptr1</FONT><FONT COLOR="#000000">&gt;</FONT> <FONT COLOR="#0000FF">void</FONT> <FONT COLOR="#000000">=</FONT>
    <FONT COLOR="#000000">if</FONT> i <FONT COLOR="#000000">&lt;</FONT> n <FONT COLOR="#000000">then</FONT> <FONT COLOR="#000000">(</FONT>R[<FONT COLOR="#009000">i</FONT><FONT COLOR="#000000">]</FONT> := R[<FONT COLOR="#009000">i</FONT><FONT COLOR="#000000">]</FONT> / nf<FONT COLOR="#000000">;</FONT> aux4 <FONT COLOR="#000000">(</FONT><FONT COLOR="#009000">pf_r</FONT> <FONT COLOR="#000000">|</FONT> i+1<FONT COLOR="#000000">,</FONT> nf<FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT>

  <FONT COLOR="#000000">fun</FONT> aux5 <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>i<FONT COLOR="#000000">:</FONT>nat <FONT COLOR="#000000">|</FONT> i &lt;= n<FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#000000">(</FONT>
      <FONT COLOR="#009000">pf_r<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">!</FONT>array_v <FONT COLOR="#000000">(</FONT>real<FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">,</FONT> l_r<FONT COLOR="#000000">)</FONT></FONT></FONT>
    <FONT COLOR="#000000">,</FONT> <FONT COLOR="#009000">pf_w<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">!</FONT>array_v <FONT COLOR="#000000">(</FONT>real<FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">,</FONT> l_w<FONT COLOR="#000000">)</FONT></FONT></FONT>
    <FONT COLOR="#000000">|</FONT> i<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">int i</FONT>
    <FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">:&lt;</FONT><FONT COLOR="#0000FF">cloptr1</FONT><FONT COLOR="#000000">&gt;</FONT> <FONT COLOR="#0000FF">void</FONT> <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">begin</FONT>
    <FONT COLOR="#000000">if</FONT> i <FONT COLOR="#000000">&lt;</FONT> n <FONT COLOR="#000000">then</FONT> <FONT COLOR="#000000">(</FONT>R[<FONT COLOR="#009000">i</FONT><FONT COLOR="#000000">]</FONT> := R[<FONT COLOR="#009000">i</FONT><FONT COLOR="#000000">]</FONT> / W[<FONT COLOR="#009000">i</FONT><FONT COLOR="#000000">]</FONT><FONT COLOR="#000000">;</FONT> aux5 <FONT COLOR="#000000">(</FONT><FONT COLOR="#009000">pf_r</FONT><FONT COLOR="#000000">,</FONT> <FONT COLOR="#009000">pf_w</FONT> <FONT COLOR="#000000">|</FONT> i+1<FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">else</FONT> <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT>
  <FONT COLOR="#000000">end</FONT>

  <FONT COLOR="#000000">val</FONT> <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> aux3 <FONT COLOR="#000000">(</FONT><FONT COLOR="#009000">pf_r</FONT><FONT COLOR="#000000">,</FONT> <FONT COLOR="#009000">pf_i</FONT> <FONT COLOR="#000000">|</FONT> 1<FONT COLOR="#000000">)</FONT>
  <FONT COLOR="#000000">val</FONT> <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> aux4 <FONT COLOR="#000000">(</FONT><FONT COLOR="#009000">pf_r</FONT> <FONT COLOR="#000000">|</FONT> 0<FONT COLOR="#000000">,</FONT> d2r <FONT COLOR="#000000">(</FONT>i2d n<FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT>
  <FONT COLOR="#000000">val</FONT> sum <FONT COLOR="#000000">=</FONT> compute_signal_sum <FONT COLOR="#000000">(</FONT><FONT COLOR="#009000">pf_r</FONT> <FONT COLOR="#000000">|</FONT> R<FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">)</FONT>
  <FONT COLOR="#000000">val</FONT> <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> aux5 <FONT COLOR="#000000">(</FONT><FONT COLOR="#009000">pf_r</FONT><FONT COLOR="#000000">,</FONT> <FONT COLOR="#009000">pf_w</FONT> <FONT COLOR="#000000">|</FONT> 0<FONT COLOR="#000000">)</FONT>
<FONT COLOR="#000000">in</FONT>
  sum
<FONT COLOR="#000000">end</FONT> <FONT COLOR="#787878">// end of [inverse_fft]
</FONT>
<FONT COLOR="#787878">//
</FONT>
<FONT COLOR="#000000">fun</FONT> modular_reduce <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>n<FONT COLOR="#000000">:</FONT>nat<FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>l_r<FONT COLOR="#000000">,</FONT>l_b<FONT COLOR="#000000">:</FONT>addr<FONT COLOR="#000000">}</FONT></FONT>
  <FONT COLOR="#000000">(</FONT><FONT COLOR="#009000">pf_r<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">!</FONT>array_v <FONT COLOR="#000000">(</FONT>real<FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">,</FONT> l_r<FONT COLOR="#000000">)</FONT></FONT></FONT><FONT COLOR="#000000">,</FONT> <FONT COLOR="#009000">pf_b<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">!</FONT>array_v <FONT COLOR="#000000">(</FONT>real<FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">,</FONT> l_b<FONT COLOR="#000000">)</FONT></FONT></FONT> <FONT COLOR="#000000">|</FONT>
   R<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">ptr l_r</FONT><FONT COLOR="#000000">,</FONT> B<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">ptr l_b</FONT><FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">int n</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">void</FONT> <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">let</FONT>
  <FONT COLOR="#000000">fun</FONT> aux1 <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>i<FONT COLOR="#000000">:</FONT>nat <FONT COLOR="#000000">|</FONT> i &lt;= n<FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#000000">(</FONT>
      <FONT COLOR="#009000">pf_r<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">!</FONT>array_v <FONT COLOR="#000000">(</FONT>real<FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">,</FONT> l_r<FONT COLOR="#000000">)</FONT></FONT></FONT>
    <FONT COLOR="#000000">,</FONT> <FONT COLOR="#009000">pf_b<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">!</FONT>array_v <FONT COLOR="#000000">(</FONT>real<FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">,</FONT> l_b<FONT COLOR="#000000">)</FONT></FONT></FONT>
    <FONT COLOR="#000000">|</FONT> i<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">int i</FONT><FONT COLOR="#000000">,</FONT> carry<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">real</FONT>
    <FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">:&lt;</FONT><FONT COLOR="#0000FF">cloptr1</FONT><FONT COLOR="#000000">&gt;</FONT> <FONT COLOR="#0000FF">real</FONT> <FONT COLOR="#000000">=</FONT>
    <FONT COLOR="#000000">if</FONT> i <FONT COLOR="#000000">&lt;</FONT> n <FONT COLOR="#000000">then</FONT> <FONT COLOR="#000000">let</FONT>
      <FONT COLOR="#000000">val</FONT> temp <FONT COLOR="#000000">=</FONT> R[<FONT COLOR="#009000">i</FONT><FONT COLOR="#000000">]</FONT> + carry
      <FONT COLOR="#000000">val</FONT> bi <FONT COLOR="#000000">=</FONT> B[<FONT COLOR="#009000">i</FONT><FONT COLOR="#000000">]</FONT>
      <FONT COLOR="#000000">val</FONT> <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> R[<FONT COLOR="#009000">i</FONT><FONT COLOR="#000000">]</FONT> := fmod <FONT COLOR="#000000">(</FONT>temp<FONT COLOR="#000000">,</FONT> bi<FONT COLOR="#000000">)</FONT>
    <FONT COLOR="#000000">in</FONT>
      aux1 <FONT COLOR="#000000">(</FONT><FONT COLOR="#009000">pf_r</FONT><FONT COLOR="#000000">,</FONT> <FONT COLOR="#009000">pf_b</FONT> <FONT COLOR="#000000">|</FONT> i+1<FONT COLOR="#000000">,</FONT> floor <FONT COLOR="#000000">(</FONT>temp / bi<FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT>
    <FONT COLOR="#000000">end</FONT> <FONT COLOR="#000000">else</FONT> <FONT COLOR="#000000">begin</FONT>
      carry <FONT COLOR="#787878">// return value
</FONT>    <FONT COLOR="#000000">end</FONT>

  <FONT COLOR="#000000">fun</FONT> aux2 <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>i<FONT COLOR="#000000">:</FONT>nat <FONT COLOR="#000000">|</FONT> i &lt;= n<FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#000000">(</FONT>
      <FONT COLOR="#009000">pf_r<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">!</FONT>array_v <FONT COLOR="#000000">(</FONT>real<FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">,</FONT> l_r<FONT COLOR="#000000">)</FONT></FONT></FONT>
    <FONT COLOR="#000000">,</FONT> <FONT COLOR="#009000">pf_b<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">!</FONT>array_v <FONT COLOR="#000000">(</FONT>real<FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">,</FONT> l_b<FONT COLOR="#000000">)</FONT></FONT></FONT>
    <FONT COLOR="#000000">|</FONT> i<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">int i</FONT><FONT COLOR="#000000">,</FONT> carry<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">real</FONT>
    <FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">:&lt;</FONT><FONT COLOR="#0000FF">cloptr1</FONT><FONT COLOR="#000000">&gt;</FONT> <FONT COLOR="#0000FF">void</FONT> <FONT COLOR="#000000">=</FONT>
    <FONT COLOR="#000000">if</FONT> i <FONT COLOR="#000000">&lt;</FONT> n <FONT COLOR="#000000">then</FONT>
      <FONT COLOR="#000000">if</FONT> carry <FONT COLOR="#000000">=</FONT> d2r 0.0 <FONT COLOR="#000000">then</FONT> <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">else</FONT> <FONT COLOR="#000000">let</FONT>
        <FONT COLOR="#000000">val</FONT> temp <FONT COLOR="#000000">=</FONT> R[<FONT COLOR="#009000">i</FONT><FONT COLOR="#000000">]</FONT> + carry
        <FONT COLOR="#000000">val</FONT> bi <FONT COLOR="#000000">=</FONT> B[<FONT COLOR="#009000">i</FONT><FONT COLOR="#000000">]</FONT>
        <FONT COLOR="#000000">val</FONT> <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> R[<FONT COLOR="#009000">i</FONT><FONT COLOR="#000000">]</FONT> := fmod <FONT COLOR="#000000">(</FONT>temp<FONT COLOR="#000000">,</FONT> bi<FONT COLOR="#000000">)</FONT>
      <FONT COLOR="#000000">in</FONT>
        aux2 <FONT COLOR="#000000">(</FONT><FONT COLOR="#009000">pf_r</FONT><FONT COLOR="#000000">,</FONT> <FONT COLOR="#009000">pf_b</FONT> <FONT COLOR="#000000">|</FONT> i+1<FONT COLOR="#000000">,</FONT> floor <FONT COLOR="#000000">(</FONT>temp / bi<FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT>
      <FONT COLOR="#000000">end</FONT>
    <FONT COLOR="#000000">else</FONT> <FONT COLOR="#000000">begin</FONT>
      aux2 <FONT COLOR="#000000">(</FONT><FONT COLOR="#009000">pf_r</FONT><FONT COLOR="#000000">,</FONT> <FONT COLOR="#009000">pf_b</FONT> <FONT COLOR="#000000">|</FONT> 0<FONT COLOR="#000000">,</FONT> carry<FONT COLOR="#000000">)</FONT>
    <FONT COLOR="#000000">end</FONT>

  <FONT COLOR="#000000">val</FONT> carry <FONT COLOR="#000000">=</FONT> aux1 <FONT COLOR="#000000">(</FONT><FONT COLOR="#009000">pf_r</FONT><FONT COLOR="#000000">,</FONT> <FONT COLOR="#009000">pf_b</FONT> <FONT COLOR="#000000">|</FONT> 0<FONT COLOR="#000000">,</FONT> d2r 0.0<FONT COLOR="#000000">)</FONT>
<FONT COLOR="#000000">in</FONT>
  aux2 <FONT COLOR="#000000">(</FONT><FONT COLOR="#009000">pf_r</FONT><FONT COLOR="#000000">,</FONT> <FONT COLOR="#009000">pf_b</FONT> <FONT COLOR="#000000">|</FONT> 0<FONT COLOR="#000000">,</FONT> carry<FONT COLOR="#000000">)</FONT>
<FONT COLOR="#000000">end</FONT> <FONT COLOR="#787878">// end of [modular_reduce]
</FONT>
<FONT COLOR="#787878">//
</FONT>
<FONT COLOR="#000000">fun</FONT> subtract2 <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>n<FONT COLOR="#000000">:</FONT>nat<FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>l_r<FONT COLOR="#000000">,</FONT>l_b<FONT COLOR="#000000">:</FONT>addr<FONT COLOR="#000000">}</FONT></FONT>
  <FONT COLOR="#000000">(</FONT><FONT COLOR="#009000">pf_r<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">!</FONT>array_v <FONT COLOR="#000000">(</FONT>real<FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">,</FONT> l_r<FONT COLOR="#000000">)</FONT></FONT></FONT><FONT COLOR="#000000">,</FONT> <FONT COLOR="#009000">pf_b<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">!</FONT>array_v <FONT COLOR="#000000">(</FONT>real<FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">,</FONT> l_b<FONT COLOR="#000000">)</FONT></FONT></FONT> <FONT COLOR="#000000">|</FONT>
   R<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">ptr l_r</FONT><FONT COLOR="#000000">,</FONT> B<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">ptr l_b</FONT><FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">int n</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">void</FONT> <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">let</FONT>
  <FONT COLOR="#000000">fun</FONT> aux <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>i<FONT COLOR="#000000">:</FONT>nat <FONT COLOR="#000000">|</FONT> i &lt;= n<FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#000000">(</FONT>
      <FONT COLOR="#009000">pf_r<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">!</FONT>array_v <FONT COLOR="#000000">(</FONT>real<FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">,</FONT> l_r<FONT COLOR="#000000">)</FONT></FONT></FONT>
    <FONT COLOR="#000000">,</FONT> <FONT COLOR="#009000">pf_b<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">!</FONT>array_v <FONT COLOR="#000000">(</FONT>real<FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">,</FONT> l_b<FONT COLOR="#000000">)</FONT></FONT></FONT>
    <FONT COLOR="#000000">|</FONT> i<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">int i</FONT><FONT COLOR="#000000">,</FONT> carry<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">real</FONT>
    <FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">:&lt;</FONT><FONT COLOR="#0000FF">cloptr1</FONT><FONT COLOR="#000000">&gt;</FONT> <FONT COLOR="#0000FF">void</FONT> <FONT COLOR="#000000">=</FONT>
    <FONT COLOR="#000000">if</FONT> i <FONT COLOR="#000000">&lt;</FONT> n <FONT COLOR="#000000">then</FONT>
      <FONT COLOR="#000000">if</FONT> carry <FONT COLOR="#000000">=</FONT> d2r 0.0 <FONT COLOR="#000000">then</FONT> <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">else</FONT> <FONT COLOR="#000000">let</FONT>
        <FONT COLOR="#000000">val</FONT> ri <FONT COLOR="#000000">=</FONT> R[<FONT COLOR="#009000">i</FONT><FONT COLOR="#000000">]</FONT> <FONT COLOR="#000000">and</FONT> bi <FONT COLOR="#000000">=</FONT> B[<FONT COLOR="#009000">i</FONT><FONT COLOR="#000000">]</FONT>
      <FONT COLOR="#000000">in</FONT>
        <FONT COLOR="#000000">if</FONT> carry <FONT COLOR="#000000">&gt;</FONT> ri <FONT COLOR="#000000">then</FONT>
          <FONT COLOR="#000000">(</FONT>R[<FONT COLOR="#009000">i</FONT><FONT COLOR="#000000">]</FONT> := bi - carry + ri<FONT COLOR="#000000">;</FONT> aux <FONT COLOR="#000000">(</FONT><FONT COLOR="#009000">pf_r</FONT><FONT COLOR="#000000">,</FONT> <FONT COLOR="#009000">pf_b</FONT> <FONT COLOR="#000000">|</FONT> i+1<FONT COLOR="#000000">,</FONT> d2r 1.0<FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT>
        <FONT COLOR="#000000">else</FONT> <FONT COLOR="#000000">let</FONT>
          <FONT COLOR="#000000">val</FONT> t <FONT COLOR="#000000">=</FONT> ri - carry
        <FONT COLOR="#000000">in</FONT>
          R[<FONT COLOR="#009000">i</FONT><FONT COLOR="#000000">]</FONT> := fmod <FONT COLOR="#000000">(</FONT>t<FONT COLOR="#000000">,</FONT> bi<FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">;</FONT>
          aux <FONT COLOR="#000000">(</FONT><FONT COLOR="#009000">pf_r</FONT><FONT COLOR="#000000">,</FONT> <FONT COLOR="#009000">pf_b</FONT> <FONT COLOR="#000000">|</FONT> i+1<FONT COLOR="#000000">,</FONT> floor <FONT COLOR="#000000">(</FONT>t / bi<FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT>
        <FONT COLOR="#000000">end</FONT>
      <FONT COLOR="#000000">end</FONT> <FONT COLOR="#000000">else</FONT> <FONT COLOR="#000000">begin</FONT>
        <FONT COLOR="#787878">// this is empty
</FONT>      <FONT COLOR="#000000">end</FONT>
<FONT COLOR="#000000">in</FONT>
  aux <FONT COLOR="#000000">(</FONT><FONT COLOR="#009000">pf_r</FONT><FONT COLOR="#000000">,</FONT> <FONT COLOR="#009000">pf_b</FONT> <FONT COLOR="#000000">|</FONT> 0<FONT COLOR="#000000">,</FONT> d2r 2.0<FONT COLOR="#000000">)</FONT>
<FONT COLOR="#000000">end</FONT> <FONT COLOR="#787878">// end of [substract2]
</FONT>
<FONT COLOR="#787878">//
</FONT>
<FONT COLOR="#000000">#define</FONT> <FONT COLOR="#800080">BITSIZE 16</FONT>

<FONT COLOR="#000000">fun</FONT> compute_optimal_signal_size <FONT COLOR="#000000">(</FONT>exponent<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">Nat</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">intGt 0</FONT> <FONT COLOR="#000000">=</FONT>
  <FONT COLOR="#000000">let</FONT>
     <FONT COLOR="#000000">fun</FONT> aux <FONT COLOR="#000000">(</FONT>i<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">Nat</FONT><FONT COLOR="#000000">,</FONT> p<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">intGt 0</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">intGt 0</FONT> <FONT COLOR="#000000">=</FONT>
       <FONT COLOR="#000000">if</FONT> i <FONT COLOR="#000000">&lt;</FONT> BITSIZE <FONT COLOR="#000000">then</FONT> p <FONT COLOR="#000000">else</FONT> aux <FONT COLOR="#000000">(</FONT>nhalf i<FONT COLOR="#000000">,</FONT> p + p<FONT COLOR="#000000">)</FONT>
  <FONT COLOR="#000000">in</FONT>
     aux <FONT COLOR="#000000">(</FONT>exponent<FONT COLOR="#000000">,</FONT> 1<FONT COLOR="#000000">)</FONT>
  <FONT COLOR="#000000">end</FONT>

<FONT COLOR="#787878">//
</FONT>
<FONT COLOR="#000000">fun</FONT> compute_base_signal <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>n<FONT COLOR="#000000">:</FONT>nat<FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>l_b<FONT COLOR="#000000">:</FONT>addr<FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#000000">(</FONT>
    <FONT COLOR="#009000">pf_b<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">!</FONT>array_v <FONT COLOR="#000000">(</FONT>real<FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">,</FONT> l_b<FONT COLOR="#000000">)</FONT></FONT></FONT> <FONT COLOR="#000000">|</FONT> B<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">ptr l_b</FONT><FONT COLOR="#000000">,</FONT> exponent<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">Nat</FONT><FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">int n</FONT>
  <FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">void</FONT> <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">let</FONT>
  <FONT COLOR="#000000">fun</FONT> aux <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>i<FONT COLOR="#000000">:</FONT>nat <FONT COLOR="#000000">|</FONT> i &lt;= n<FONT COLOR="#000000">}</FONT></FONT>
    <FONT COLOR="#000000">(</FONT><FONT COLOR="#009000">pf_b<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">!</FONT>array_v <FONT COLOR="#000000">(</FONT>real<FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">,</FONT> l_b<FONT COLOR="#000000">)</FONT></FONT></FONT> <FONT COLOR="#000000">|</FONT> i<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">int i</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">:&lt;</FONT><FONT COLOR="#0000FF">cloptr1</FONT><FONT COLOR="#000000">&gt;</FONT> <FONT COLOR="#0000FF">void</FONT> <FONT COLOR="#000000">=</FONT>
    <FONT COLOR="#000000">if</FONT> i <FONT COLOR="#000000">&lt;</FONT> n <FONT COLOR="#000000">then</FONT> <FONT COLOR="#000000">let</FONT>
      <FONT COLOR="#000000">val</FONT> e <FONT COLOR="#000000">=</FONT> i2d exponent
      <FONT COLOR="#000000">val</FONT> en <FONT COLOR="#000000">=</FONT> e / <FONT COLOR="#000000">(</FONT>i2d n<FONT COLOR="#000000">)</FONT>
      <FONT COLOR="#000000">val</FONT> eni <FONT COLOR="#000000">=</FONT> en * <FONT COLOR="#000000">(</FONT>i2d i<FONT COLOR="#000000">)</FONT>
    <FONT COLOR="#000000">in</FONT>
      B[<FONT COLOR="#009000">i</FONT><FONT COLOR="#000000">]</FONT> := pow <FONT COLOR="#000000">(</FONT>d2r 2.0<FONT COLOR="#000000">,</FONT> d2r <FONT COLOR="#000000">(</FONT>ceil <FONT COLOR="#000000">(</FONT>eni + en<FONT COLOR="#000000">)</FONT> - ceil <FONT COLOR="#000000">(</FONT>eni<FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">;</FONT>
      aux <FONT COLOR="#000000">(</FONT><FONT COLOR="#009000">pf_b</FONT> <FONT COLOR="#000000">|</FONT> i+1<FONT COLOR="#000000">)</FONT>
    <FONT COLOR="#000000">end</FONT> <FONT COLOR="#787878">// end of [if]
</FONT><FONT COLOR="#000000">in</FONT>
  aux <FONT COLOR="#000000">(</FONT><FONT COLOR="#009000">pf_b</FONT> <FONT COLOR="#000000">|</FONT> 0<FONT COLOR="#000000">)</FONT>
<FONT COLOR="#000000">end</FONT> <FONT COLOR="#787878">// end of [compute_base_signal]
</FONT>
<FONT COLOR="#787878">//
</FONT>
<FONT COLOR="#000000">fun</FONT> compute_weight_signal <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>n<FONT COLOR="#000000">:</FONT>nat<FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>l_w<FONT COLOR="#000000">:</FONT>addr<FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#000000">(</FONT>
    <FONT COLOR="#009000">pf_w<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">!</FONT>array_v <FONT COLOR="#000000">(</FONT>real<FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">,</FONT> l_w<FONT COLOR="#000000">)</FONT></FONT></FONT>
  <FONT COLOR="#000000">|</FONT> W<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">ptr l_w</FONT><FONT COLOR="#000000">,</FONT> exponent<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">Nat</FONT><FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">int n</FONT>
  <FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">void</FONT> <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">let</FONT>
  <FONT COLOR="#000000">fun</FONT> aux <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>i<FONT COLOR="#000000">:</FONT>nat <FONT COLOR="#000000">|</FONT> i &lt;= n<FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">.&lt;</FONT>n-i<FONT COLOR="#000000">&gt;.</FONT></FONT>
    <FONT COLOR="#000000">(</FONT><FONT COLOR="#009000">pf_w<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">!</FONT>array_v <FONT COLOR="#000000">(</FONT>real<FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">,</FONT> l_w<FONT COLOR="#000000">)</FONT></FONT></FONT> <FONT COLOR="#000000">|</FONT> i<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">int i</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">:&lt;</FONT><FONT COLOR="#0000FF">cloptr1</FONT><FONT COLOR="#000000">&gt;</FONT> <FONT COLOR="#0000FF">void</FONT> <FONT COLOR="#000000">=</FONT>
    <FONT COLOR="#000000">if</FONT> i <FONT COLOR="#000000">&lt;</FONT> n <FONT COLOR="#000000">then</FONT> <FONT COLOR="#000000">let</FONT>
      <FONT COLOR="#000000">val</FONT> e <FONT COLOR="#000000">=</FONT> i2d exponent
      <FONT COLOR="#000000">val</FONT> en <FONT COLOR="#000000">=</FONT> e / <FONT COLOR="#000000">(</FONT>i2d n<FONT COLOR="#000000">)</FONT>
      <FONT COLOR="#000000">val</FONT> eni <FONT COLOR="#000000">=</FONT> en * <FONT COLOR="#000000">(</FONT>i2d i<FONT COLOR="#000000">)</FONT>
    <FONT COLOR="#000000">in</FONT>
      W[<FONT COLOR="#009000">i</FONT><FONT COLOR="#000000">]</FONT> := pow <FONT COLOR="#000000">(</FONT>d2r 2.0<FONT COLOR="#000000">,</FONT> d2r <FONT COLOR="#000000">(</FONT>ceil eni - eni<FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">;</FONT>
      aux <FONT COLOR="#000000">(</FONT><FONT COLOR="#009000">pf_w</FONT> <FONT COLOR="#000000">|</FONT> i+1<FONT COLOR="#000000">)</FONT>
    <FONT COLOR="#000000">end</FONT>
<FONT COLOR="#000000">in</FONT>
  aux <FONT COLOR="#000000">(</FONT><FONT COLOR="#009000">pf_w</FONT> <FONT COLOR="#000000">|</FONT> 0<FONT COLOR="#000000">)</FONT>
<FONT COLOR="#000000">end</FONT> <FONT COLOR="#787878">// end of [compute_weight_signal]
</FONT>
<FONT COLOR="#787878">//
</FONT>
<FONT COLOR="#000000">fun</FONT> check_zero_signal <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>n<FONT COLOR="#000000">:</FONT>nat<FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>l<FONT COLOR="#000000">:</FONT>addr<FONT COLOR="#000000">}</FONT></FONT>
  <FONT COLOR="#000000">(</FONT><FONT COLOR="#009000">pf<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">!</FONT>array_v <FONT COLOR="#000000">(</FONT>real<FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">,</FONT> l<FONT COLOR="#000000">)</FONT></FONT></FONT> <FONT COLOR="#000000">|</FONT> A<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">ptr l</FONT><FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">int n</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">bool</FONT> <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">let</FONT>
  <FONT COLOR="#000000">fun</FONT> aux <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>i<FONT COLOR="#000000">:</FONT>nat <FONT COLOR="#000000">|</FONT> i &lt;= n<FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">.&lt;</FONT>n-i<FONT COLOR="#000000">&gt;.</FONT></FONT>
    <FONT COLOR="#000000">(</FONT><FONT COLOR="#009000">pf<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">!</FONT>array_v <FONT COLOR="#000000">(</FONT>real<FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">,</FONT> l<FONT COLOR="#000000">)</FONT></FONT></FONT> <FONT COLOR="#000000">|</FONT> i<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">int i</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">:&lt;</FONT><FONT COLOR="#0000FF">cloptr1</FONT><FONT COLOR="#000000">&gt;</FONT> <FONT COLOR="#0000FF">bool</FONT> <FONT COLOR="#000000">=</FONT>
    <FONT COLOR="#000000">if</FONT> i <FONT COLOR="#000000">&lt;</FONT> n <FONT COLOR="#000000">then</FONT> <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">if</FONT> A[<FONT COLOR="#009000">i</FONT><FONT COLOR="#000000">]</FONT> <FONT COLOR="#000000">=</FONT> d2r 0.0 <FONT COLOR="#000000">then</FONT> aux <FONT COLOR="#000000">(</FONT><FONT COLOR="#009000">pf</FONT> <FONT COLOR="#000000">|</FONT> i+1<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">else</FONT> false<FONT COLOR="#000000">)</FONT>
    <FONT COLOR="#000000">else</FONT> true
<FONT COLOR="#000000">in</FONT>
  aux <FONT COLOR="#000000">(</FONT><FONT COLOR="#009000">pf</FONT> <FONT COLOR="#000000">|</FONT> 0<FONT COLOR="#000000">)</FONT>
<FONT COLOR="#000000">end</FONT> <FONT COLOR="#787878">// end of [check_zero_signal]
</FONT>
<FONT COLOR="#787878">//
</FONT>
<FONT COLOR="#000000">fun</FONT> do_iteration <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>n<FONT COLOR="#000000">:</FONT>nat<FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>l_r<FONT COLOR="#000000">,</FONT>l_i<FONT COLOR="#000000">,</FONT>l_b<FONT COLOR="#000000">,</FONT>l_w<FONT COLOR="#000000">:</FONT>addr<FONT COLOR="#000000">}</FONT></FONT>
   <FONT COLOR="#000000">(</FONT><FONT COLOR="#009000">pf_r<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">!</FONT>array_v <FONT COLOR="#000000">(</FONT>real<FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">,</FONT> l_r<FONT COLOR="#000000">)</FONT></FONT></FONT><FONT COLOR="#000000">,</FONT> <FONT COLOR="#009000">pf_i<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">!</FONT>array_v <FONT COLOR="#000000">(</FONT>imag<FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">,</FONT> l_i<FONT COLOR="#000000">)</FONT></FONT></FONT> <FONT COLOR="#000000">,</FONT> 
    <FONT COLOR="#009000">pf_b<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">!</FONT>array_v <FONT COLOR="#000000">(</FONT>real<FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">,</FONT> l_b<FONT COLOR="#000000">)</FONT></FONT></FONT><FONT COLOR="#000000">,</FONT> <FONT COLOR="#009000">pf_w<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">!</FONT>array_v <FONT COLOR="#000000">(</FONT>real<FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">,</FONT> l_w<FONT COLOR="#000000">)</FONT></FONT></FONT> <FONT COLOR="#000000">|</FONT>
    R<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">ptr l_r</FONT><FONT COLOR="#000000">,</FONT> I<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">ptr l_i</FONT><FONT COLOR="#000000">,</FONT> B<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">ptr l_b</FONT><FONT COLOR="#000000">,</FONT> W<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">ptr l_w</FONT><FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">int n</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">void</FONT> <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">let</FONT>
  <FONT COLOR="#000000">val</FONT> sum_in <FONT COLOR="#000000">=</FONT> forward_fft <FONT COLOR="#000000">(</FONT><FONT COLOR="#009000">pf_r</FONT><FONT COLOR="#000000">,</FONT> <FONT COLOR="#009000">pf_i</FONT><FONT COLOR="#000000">,</FONT> <FONT COLOR="#009000">pf_w</FONT> <FONT COLOR="#000000">|</FONT> R<FONT COLOR="#000000">,</FONT> I<FONT COLOR="#000000">,</FONT> W<FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">)</FONT>
  <FONT COLOR="#000000">val</FONT> <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> convolve_signal <FONT COLOR="#000000">(</FONT><FONT COLOR="#009000">pf_r</FONT><FONT COLOR="#000000">,</FONT> <FONT COLOR="#009000">pf_i</FONT> <FONT COLOR="#000000">|</FONT> R<FONT COLOR="#000000">,</FONT> I<FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">)</FONT>
  <FONT COLOR="#000000">val</FONT> sum_out <FONT COLOR="#000000">=</FONT> inverse_fft <FONT COLOR="#000000">(</FONT><FONT COLOR="#009000">pf_r</FONT><FONT COLOR="#000000">,</FONT> <FONT COLOR="#009000">pf_i</FONT><FONT COLOR="#000000">,</FONT> <FONT COLOR="#009000">pf_w</FONT> <FONT COLOR="#000000">|</FONT> R<FONT COLOR="#000000">,</FONT> I<FONT COLOR="#000000">,</FONT> W<FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">)</FONT>
  <FONT COLOR="#000000">val</FONT> diff <FONT COLOR="#000000">=</FONT> abs <FONT COLOR="#000000">(</FONT>sum_in * sum_in - sum_out<FONT COLOR="#000000">)</FONT>
<FONT COLOR="#000000">in</FONT>
  <FONT COLOR="#000000">if</FONT> diff <FONT COLOR="#000000">&gt;</FONT> d2r 1.0 <FONT COLOR="#000000">then</FONT> <FONT COLOR="#000000">begin</FONT>
    print "Possible error: difference = "<FONT COLOR="#000000">;</FONT> print diff<FONT COLOR="#000000">;</FONT> print_newline <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT>
   <FONT COLOR="#000000">end</FONT><FONT COLOR="#000000">;</FONT>
   round_signal <FONT COLOR="#000000">(</FONT><FONT COLOR="#009000">pf_r</FONT><FONT COLOR="#000000">,</FONT> <FONT COLOR="#009000">pf_i</FONT> <FONT COLOR="#000000">|</FONT> R<FONT COLOR="#000000">,</FONT> I<FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">;</FONT>
   modular_reduce <FONT COLOR="#000000">(</FONT><FONT COLOR="#009000">pf_r</FONT><FONT COLOR="#000000">,</FONT> <FONT COLOR="#009000">pf_b</FONT> <FONT COLOR="#000000">|</FONT> R<FONT COLOR="#000000">,</FONT> B<FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">;</FONT>
   subtract2 <FONT COLOR="#000000">(</FONT><FONT COLOR="#009000">pf_r</FONT><FONT COLOR="#000000">,</FONT> <FONT COLOR="#009000">pf_b</FONT> <FONT COLOR="#000000">|</FONT> R<FONT COLOR="#000000">,</FONT> B<FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">)</FONT>
<FONT COLOR="#000000">end</FONT> <FONT COLOR="#787878">// end of [do_iteration]
</FONT>
<FONT COLOR="#000000">#define</FONT> <FONT COLOR="#800080">STRIDE 100</FONT>

<FONT COLOR="#000000">fun</FONT> main_loop <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>n<FONT COLOR="#000000">:</FONT>nat<FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>l_r<FONT COLOR="#000000">,</FONT>l_i<FONT COLOR="#000000">,</FONT>l_b<FONT COLOR="#000000">,</FONT>l_w<FONT COLOR="#000000">:</FONT>addr<FONT COLOR="#000000">}</FONT></FONT>
   <FONT COLOR="#000000">(</FONT><FONT COLOR="#009000">pf_r<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">!</FONT>array_v <FONT COLOR="#000000">(</FONT>real<FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">,</FONT> l_r<FONT COLOR="#000000">)</FONT></FONT></FONT><FONT COLOR="#000000">,</FONT> <FONT COLOR="#009000">pf_i<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">!</FONT>array_v <FONT COLOR="#000000">(</FONT>imag<FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">,</FONT> l_i<FONT COLOR="#000000">)</FONT></FONT></FONT> <FONT COLOR="#000000">,</FONT> 
    <FONT COLOR="#009000">pf_b<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">!</FONT>array_v <FONT COLOR="#000000">(</FONT>real<FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">,</FONT> l_b<FONT COLOR="#000000">)</FONT></FONT></FONT><FONT COLOR="#000000">,</FONT> <FONT COLOR="#009000">pf_w<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">!</FONT>array_v <FONT COLOR="#000000">(</FONT>real<FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">,</FONT> l_w<FONT COLOR="#000000">)</FONT></FONT></FONT> <FONT COLOR="#000000">|</FONT>
    R<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">ptr l_r</FONT><FONT COLOR="#000000">,</FONT> I<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">ptr l_i</FONT><FONT COLOR="#000000">,</FONT> B<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">ptr l_b</FONT><FONT COLOR="#000000">,</FONT> W<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">ptr l_w</FONT><FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">int n</FONT><FONT COLOR="#000000">,</FONT>
    i<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">Nat</FONT><FONT COLOR="#000000">,</FONT> limit<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">Nat</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">void</FONT> <FONT COLOR="#000000">=</FONT>
  <FONT COLOR="#000000">if</FONT> i <FONT COLOR="#000000">&lt;</FONT> limit <FONT COLOR="#000000">then</FONT> <FONT COLOR="#000000">begin</FONT>
    <FONT COLOR="#000000">if</FONT> <FONT COLOR="#000000">(</FONT>i mod STRIDE <FONT COLOR="#000000">=</FONT> 0<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">then</FONT> <FONT COLOR="#000000">(</FONT>print '.'<FONT COLOR="#000000">;</FONT> fflush_stdout <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">;</FONT>
    do_iteration <FONT COLOR="#000000">(</FONT><FONT COLOR="#009000">pf_r</FONT><FONT COLOR="#000000">,</FONT> <FONT COLOR="#009000">pf_i</FONT><FONT COLOR="#000000">,</FONT> <FONT COLOR="#009000">pf_b</FONT><FONT COLOR="#000000">,</FONT> <FONT COLOR="#009000">pf_w</FONT> <FONT COLOR="#000000">|</FONT> R<FONT COLOR="#000000">,</FONT> I<FONT COLOR="#000000">,</FONT> B<FONT COLOR="#000000">,</FONT> W<FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">;</FONT>
    main_loop <FONT COLOR="#000000">(</FONT><FONT COLOR="#009000">pf_r</FONT><FONT COLOR="#000000">,</FONT> <FONT COLOR="#009000">pf_i</FONT><FONT COLOR="#000000">,</FONT> <FONT COLOR="#009000">pf_b</FONT><FONT COLOR="#000000">,</FONT> <FONT COLOR="#009000">pf_w</FONT> <FONT COLOR="#000000">|</FONT> R<FONT COLOR="#000000">,</FONT> I<FONT COLOR="#000000">,</FONT> B<FONT COLOR="#000000">,</FONT> W<FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">,</FONT> i+1<FONT COLOR="#000000">,</FONT> limit<FONT COLOR="#000000">)</FONT>
  <FONT COLOR="#000000">end</FONT>

<FONT COLOR="#787878">// Here are the first few Mersenne primes:
</FONT><FONT COLOR="#787878">// 2, 3, 5, 7, 13, 17, 19, 31, 61, 89, 107, 127, 521, 607,
</FONT><FONT COLOR="#787878">// 1279, 2203, 2281, 3217, 4253, 4423, 9689, 9941, 11213,
</FONT><FONT COLOR="#787878">// 19937, 21701, 23209, 44497, 86243, 110503, 132049, 216091,
</FONT><FONT COLOR="#787878">// 756839, 859433, 1257787, 1398269, 2976221, 3021377, 6972593,
</FONT><FONT COLOR="#787878">// 13466917, ...
</FONT>
<FONT COLOR="#787878">// The following function tests whether 2^exponent-1 is a prime:
</FONT><FONT COLOR="#000000">fun</FONT> is_mersenne_prime <FONT COLOR="#000000">(</FONT>exponent<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">intGte 2</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">bool</FONT> <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">let</FONT>
  <FONT COLOR="#000000">val</FONT> n <FONT COLOR="#000000">=</FONT> compute_optimal_signal_size <FONT COLOR="#000000">(</FONT>exponent<FONT COLOR="#000000">)</FONT>

  <FONT COLOR="#000000">val</FONT> <FONT COLOR="#000000">(</FONT><FONT COLOR="#009000">pf_gc_r</FONT><FONT COLOR="#000000">,</FONT> <FONT COLOR="#009000">pf_r</FONT> <FONT COLOR="#000000">|</FONT> R<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT>
    array_ptr_make_fun_tsz_cloptr <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>real<FONT COLOR="#000000">}</FONT></FONT>
      <FONT COLOR="#000000">(</FONT>n<FONT COLOR="#000000">,</FONT> <FONT COLOR="#000000">lam</FONT> <FONT COLOR="#000000">(</FONT>x<FONT COLOR="#000000">,</FONT> _<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=&lt;</FONT><FONT COLOR="#0000FF">cloptr</FONT><FONT COLOR="#000000">&gt;</FONT> x := d2r 0.0<FONT COLOR="#000000">,</FONT> sizeof&lt;<FONT COLOR="#0000FF">real</FONT><FONT COLOR="#000000">&gt;</FONT><FONT COLOR="#000000">)</FONT>
  <FONT COLOR="#000000">val</FONT> <FONT COLOR="#000000">(</FONT><FONT COLOR="#009000">pf_gc_i</FONT><FONT COLOR="#000000">,</FONT> <FONT COLOR="#009000">pf_i</FONT> <FONT COLOR="#000000">|</FONT> I<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT>
    array_ptr_make_fun_tsz_cloptr <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>imag<FONT COLOR="#000000">}</FONT></FONT>
      <FONT COLOR="#000000">(</FONT>n<FONT COLOR="#000000">,</FONT> <FONT COLOR="#000000">lam</FONT> <FONT COLOR="#000000">(</FONT>x<FONT COLOR="#000000">,</FONT> _<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=&lt;</FONT><FONT COLOR="#0000FF">cloptr</FONT><FONT COLOR="#000000">&gt;</FONT> x := d2i 0.0<FONT COLOR="#000000">,</FONT> sizeof&lt;<FONT COLOR="#0000FF">imag</FONT><FONT COLOR="#000000">&gt;</FONT><FONT COLOR="#000000">)</FONT>
  <FONT COLOR="#000000">val</FONT> <FONT COLOR="#000000">(</FONT><FONT COLOR="#009000">pf_gc_b</FONT><FONT COLOR="#000000">,</FONT> <FONT COLOR="#009000">pf_b</FONT> <FONT COLOR="#000000">|</FONT> B<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT>
    array_ptr_make_fun_tsz_cloptr <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>real<FONT COLOR="#000000">}</FONT></FONT>
      <FONT COLOR="#000000">(</FONT>n<FONT COLOR="#000000">,</FONT> <FONT COLOR="#000000">lam</FONT> <FONT COLOR="#000000">(</FONT>x<FONT COLOR="#000000">,</FONT> _<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=&lt;</FONT><FONT COLOR="#0000FF">cloptr</FONT><FONT COLOR="#000000">&gt;</FONT> x := d2r 0.0<FONT COLOR="#000000">,</FONT> sizeof&lt;<FONT COLOR="#0000FF">real</FONT><FONT COLOR="#000000">&gt;</FONT><FONT COLOR="#000000">)</FONT>
  <FONT COLOR="#000000">val</FONT> <FONT COLOR="#000000">(</FONT><FONT COLOR="#009000">pf_gc_w</FONT><FONT COLOR="#000000">,</FONT> <FONT COLOR="#009000">pf_w</FONT> <FONT COLOR="#000000">|</FONT> W<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT>
    array_ptr_make_fun_tsz_cloptr <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>real<FONT COLOR="#000000">}</FONT></FONT>
      <FONT COLOR="#000000">(</FONT>n<FONT COLOR="#000000">,</FONT> <FONT COLOR="#000000">lam</FONT> <FONT COLOR="#000000">(</FONT>x<FONT COLOR="#000000">,</FONT> _<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=&lt;</FONT><FONT COLOR="#0000FF">cloptr</FONT><FONT COLOR="#000000">&gt;</FONT> x := d2r 0.0<FONT COLOR="#000000">,</FONT> sizeof&lt;<FONT COLOR="#0000FF">real</FONT><FONT COLOR="#000000">&gt;</FONT><FONT COLOR="#000000">)</FONT>

  <FONT COLOR="#000000">val</FONT> <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> compute_base_signal <FONT COLOR="#000000">(</FONT><FONT COLOR="#009000">pf_b</FONT> <FONT COLOR="#000000">|</FONT> B<FONT COLOR="#000000">,</FONT> exponent<FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">)</FONT>
  <FONT COLOR="#000000">val</FONT> <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> compute_weight_signal <FONT COLOR="#000000">(</FONT><FONT COLOR="#009000">pf_w</FONT> <FONT COLOR="#000000">|</FONT> W<FONT COLOR="#000000">,</FONT> exponent<FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">)</FONT>
  <FONT COLOR="#000000">val</FONT> <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> R[<FONT COLOR="#009000">0</FONT><FONT COLOR="#000000">]</FONT> := d2r 4.0
  <FONT COLOR="#000000">val</FONT> <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> main_loop <FONT COLOR="#000000">(</FONT><FONT COLOR="#009000">pf_r</FONT><FONT COLOR="#000000">,</FONT> <FONT COLOR="#009000">pf_i</FONT><FONT COLOR="#000000">,</FONT> <FONT COLOR="#009000">pf_b</FONT><FONT COLOR="#000000">,</FONT> <FONT COLOR="#009000">pf_w</FONT> <FONT COLOR="#000000">|</FONT> R<FONT COLOR="#000000">,</FONT> I<FONT COLOR="#000000">,</FONT> B<FONT COLOR="#000000">,</FONT> W<FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">,</FONT> 0<FONT COLOR="#000000">,</FONT> exponent - 2<FONT COLOR="#000000">)</FONT>
  <FONT COLOR="#000000">val</FONT> <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> print_newline <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT>
  <FONT COLOR="#000000">val</FONT> ans <FONT COLOR="#000000">=</FONT> check_zero_signal <FONT COLOR="#000000">(</FONT><FONT COLOR="#009000">pf_r</FONT> <FONT COLOR="#000000">|</FONT> R<FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">)</FONT>
<FONT COLOR="#000000">in</FONT>
  array_ptr_free <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>real<FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#000000">(</FONT><FONT COLOR="#009000">pf_gc_r</FONT><FONT COLOR="#000000">,</FONT> <FONT COLOR="#009000">pf_r</FONT> <FONT COLOR="#000000">|</FONT> R<FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">;</FONT>
  array_ptr_free <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>imag<FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#000000">(</FONT><FONT COLOR="#009000">pf_gc_i</FONT><FONT COLOR="#000000">,</FONT> <FONT COLOR="#009000">pf_i</FONT> <FONT COLOR="#000000">|</FONT> I<FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">;</FONT>
  array_ptr_free <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>real<FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#000000">(</FONT><FONT COLOR="#009000">pf_gc_b</FONT><FONT COLOR="#000000">,</FONT> <FONT COLOR="#009000">pf_b</FONT> <FONT COLOR="#000000">|</FONT> B<FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">;</FONT>
  array_ptr_free <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>real<FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#000000">(</FONT><FONT COLOR="#009000">pf_gc_w</FONT><FONT COLOR="#000000">,</FONT> <FONT COLOR="#009000">pf_w</FONT> <FONT COLOR="#000000">|</FONT> W<FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">;</FONT>
  ans
<FONT COLOR="#000000">end</FONT> <FONT COLOR="#787878">// end of [is_mersenne_prime]
</FONT>
<FONT COLOR="#787878">//
</FONT>
<FONT COLOR="#000000">fn</FONT> usage <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">void</FONT> <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">begin</FONT>
  print "A natural number argument &gt;= 2 is needed."<FONT COLOR="#000000">;</FONT>
  print_newline <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT>
<FONT COLOR="#000000">end</FONT>

<FONT COLOR="#000000">implement</FONT> main <FONT COLOR="#000000">(</FONT>argc<FONT COLOR="#000000">,</FONT> argv<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">let</FONT>
  <FONT COLOR="#000000">val</FONT> <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">if</FONT> argc &lt;= 1 <FONT COLOR="#000000">then</FONT> <FONT COLOR="#000000">(</FONT>usage <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">;</FONT> exit <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>void<FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#000000">(</FONT>1<FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT>
  <FONT COLOR="#000000">val</FONT> <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> assert <FONT COLOR="#000000">(</FONT>argc <FONT COLOR="#000000">&gt;</FONT> 1<FONT COLOR="#000000">)</FONT>
  <FONT COLOR="#000000">val</FONT> exp <FONT COLOR="#000000">=</FONT> int1_of <FONT COLOR="#000000">(</FONT>argv<FONT COLOR="#000000">.</FONT><FONT COLOR="#000000">[</FONT><FONT COLOR="#009000">1</FONT><FONT COLOR="#000000">]</FONT><FONT COLOR="#000000">)</FONT>
  <FONT COLOR="#000000">val</FONT> <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">if</FONT> exp &lt;= 1 <FONT COLOR="#000000">then</FONT> <FONT COLOR="#000000">(</FONT>usage <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">;</FONT> exit <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>void<FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#000000">(</FONT>1<FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT>
  <FONT COLOR="#000000">val</FONT> <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT>  assert <FONT COLOR="#000000">(</FONT>exp <FONT COLOR="#000000">&gt;</FONT> 1<FONT COLOR="#000000">)</FONT>
<FONT COLOR="#000000">in</FONT>
  <FONT COLOR="#000000">if</FONT> is_mersenne_prime exp <FONT COLOR="#000000">then</FONT> <FONT COLOR="#000000">begin</FONT>
    printf <FONT COLOR="#000000">(</FONT>"2 ^ %i - 1 is a prime!\n"<FONT COLOR="#000000">,</FONT> <FONT COLOR="#000000">@(</FONT>exp<FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT>
  <FONT COLOR="#000000">end</FONT> <FONT COLOR="#000000">else</FONT> <FONT COLOR="#000000">begin</FONT>
    printf <FONT COLOR="#000000">(</FONT>"2 ^ %i - 1 is a composite.\n"<FONT COLOR="#000000">,</FONT> <FONT COLOR="#000000">@(</FONT>exp<FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT>
  <FONT COLOR="#000000">end</FONT>
<FONT COLOR="#000000">end</FONT> <FONT COLOR="#787878">// end of [main]
</FONT>
<FONT COLOR="#787878">////

/* FFT.c
Very primitive implementation of the irrational-base discrete weighted transform.
Written by Rick Lavoie
Taken from pseudocode found in "Prime Numbers: A Computational Perspective"

Absolutely no optimization has gone into this code. It's written for clarity, not speed.
*/
#include &lt;stdio.h&gt;
#include &lt;math.h&gt;
#include &lt;memory.h&gt;
#include &lt;stdlib.h&gt;

#define PI 3.1415926535897932384626

// Displays the contents of a signal
int display_signal(double* real, double* imag, unsigned int signal_size)
{
	unsigned int i;

	if (imag == NULL) { // Pass NULL as the second parameter if we just want the real part
		for (i = 0; i &lt; signal_size; i++)
			printf("%.2f ", real[i]);
	} else {
		for (i = 0; i &lt; signal_size; i++) 
			printf("%.2f+%.2fi ", real[i], imag[i]);
	}

	printf("\n");
	return 0;
}

// Adds together the values of a signal. Used for error-checking
double compute_signal_sum(double* real, unsigned int signal_size)
{
	unsigned int i;
	double running_total = 0.0;

	for (i = 0; i &lt; signal_size; i++) 
		running_total += real[i]; 
	
	return running_total;
}

// Computes the forward fast fourier transform of a complex signal. Uses Gentleman-Sande decimation
// in frequency variant. weight is a weight signal, and signal_size is the size of the signal. real
// and imag are the signal to be transformed. Bitscrambling is not done.
double forward_fast_fourier(double* real, double* imag, double* weight, unsigned int signal_size)
{
	unsigned int m, j, i;
	double a_real, a_imag, temp1_real, temp1_imag, temp2_real, temp2_imag;
	double sum;
	
	for (m = 0; m &lt; signal_size; m++) // Initially multiply the input by the weights
		real[m] *= weight[m];
	
	sum = compute_signal_sum(real, signal_size);

	// Taken straight from "Prime Numbers"
	for (m = signal_size/2; m &gt;= 1; m = m/2) {
		for (j = 0; j &lt; m; j++) {
			a_real = cos((2.0*PI*j*signal_size/(2*m))/signal_size);
			a_imag = -sin((2.0*PI*j*signal_size/(2*m))/signal_size);
			for (i = j; i &lt; signal_size; i += 2*m) {
				temp1_real = real[i+m];
				temp1_imag = imag[i+m];
				temp2_real = real[i];
				temp2_imag = imag[i];
				real[i] = temp2_real + temp1_real;
				imag[i] = temp2_imag + temp1_imag;
				temp1_real = temp2_real - temp1_real;
				temp1_imag = temp2_imag - temp1_imag;
				real[i+m] = (a_real * temp1_real) - (a_imag * temp1_imag);
				imag[i+m] = (a_real * temp1_imag) + (a_imag * temp1_real);
			}
		}
	}

	return sum;
}

// Computes the inverse fast fourier transform. Uses Cooley-Turkey decimation in time. Parameters
// are the same as the forward transform. Bitscrambling is not done, because the use of the two
// different decimations cancels them out.
double inverse_fast_fourier(double* real, double* imag, double* weight, unsigned int signal_size)
{
	unsigned int m, j, i;
	double a_real, a_imag, temp1_real, temp1_imag, temp2_real, temp2_imag;
	double sum;
		
	for (m = 1; m &lt; signal_size; m = 2*m) {
		for (j = 0; j &lt; m; j++) {
			a_real = cos((2.0*PI*j*signal_size/(2*m))/signal_size);
			a_imag = sin((2.0*PI*j*signal_size/(2*m))/signal_size);
			for (i = j; i &lt; signal_size; i += 2*m) {
				temp1_real = (real[i+m] * a_real) - (imag[i+m] * a_imag);
				temp1_imag = (real[i+m] * a_imag) + (imag[i+m] * a_real);
				temp2_real = real[i];
				temp2_imag = imag[i];
				real[i] = temp2_real + temp1_real;
				imag[i] = temp2_imag + temp1_imag;
				real[i+m] = temp2_real - temp1_real;
				imag[i+m] = temp2_imag - temp1_imag;
			}
		}
	}

	for (m = 0; m &lt; signal_size; m++) // Divide by the signal_size to re-normalize the signal
		real[m] = real[m] / signal_size;
	
	sum = compute_signal_sum(real, signal_size);
	
	for (m = 0; m &lt; signal_size; m++)  // Adjust by the weights
		real[m] = real[m] / weight[m];
	
	return sum;
}

// Convulves a transformed signal. IE, square the signal dyadically.
int convulve_signal(double* real, double* imag, unsigned int signal_size)
{
	unsigned int i;
	double temp_real, temp_imag;

	for (i = 0; i &lt; signal_size; i++) {
		temp_real = real[i];
		temp_imag = imag[i];
		real[i] = (temp_real * temp_real) - (temp_imag * temp_imag); // Complex multiplication
		imag[i] = (temp_real * temp_imag) + (temp_real * temp_imag);
	}

	return 0;
}

// Rounds the floating point signal to closest integers.
int round_signal(double* real, double* imag, unsigned int signal_size)
{
	unsigned int i;

	// I'll eventually add a check to see if we're not rounding too far
	for (i = 0; i &lt; signal_size; i++) 
		real[i] = floor(real[i] + 0.5);
	
	return 0;
}

// Reduces the signal into their appropriate bases. base is the base signal. 
int modular_reduce(double* real, double* base, unsigned int signal_size)
{
	unsigned int i;
	double carry = 0;
	double temp;

	for (i = 0; i &lt; signal_size; i++) {
		temp = real[i] + carry;
		real[i] = fmod(temp, base[i]);
		carry = floor(temp/base[i]);
	}
	
	while (carry != 0) {
		for (i = 0; i &lt; signal_size; i++) {
			if (carry == 0)
				break;
			temp = real[i] + carry;
			real[i] = fmod(temp, base[i]);
			carry = floor(temp/base[i]);
		}
	}
	
	return 0;
}

// Subtracts 2 from the signal. This is part of the Lucas-Lehmer test. This code won't work
// if the base is less than 2.
int subtract_2(double* real, double* base, unsigned int signal_size)
{
	unsigned int i;
	double carry = 2; // Subtract 2
	double temp;

	for (i = 0; i &lt; signal_size; i++) {
		if (carry == 0) // No more carry, so we can exit early
			break;
		else if (carry &gt; real[i]) { // If real[i] is less than the carry
			real[i] = base[i] - (carry - real[i]);
			carry = 1;
		} else {
			temp = real[i] - carry; // Subtract the carry
			real[i] = fmod(temp, base[i]); // Modular adjust
			carry = floor(temp/base[i]); // Get the carry
		}
	}

	return 0;
}

// Computes the optimal size of a signal, given an exponent
unsigned int compute_optimal_signal_size(unsigned int exponent)
{
	unsigned int temp = 1;
	// "Prime Numbers" says to find a signal_length such that Floor[2^(exponent/temp)] is
	// an "appropriate" size;
	while (1) { 
		if ((double)exponent/temp &lt; 16) // I have no clue how to decide what's an ideal bitsize
			break; // so I'm just using 16 bits and hope it's adequate
		temp *= 2;
	}

	return temp;
}

// Computes the base signal for an exponent
int compute_base_signal(double* base, unsigned int exponent, unsigned int signal_size)
{
	unsigned int i;
	// "Prime Numbers" says base[i-1] = 2^(Ceil[exponent*i/signal_size] - Ceil[exponent*(i-1)/signal_size]);
	// Running i from 1 to signal_size;
	for (i = 1; i &lt;= signal_size; i++) 
		base[i-1] = pow(2, ceil((double)exponent*i/signal_size)-ceil((double)exponent*(i-1)/signal_size));

	return 0;
}

// Computes the weight signal for an exponent
int compute_weight_signal(double* weight, unsigned int exponent, unsigned int signal_size)
{
	unsigned int i;
	double temp;
	// "Prime Numbers" says weight[i] = 2^(Ceil[exponent*i/signal_size]-(exponent*i/signal_size))
	for (i = 0; i &lt; signal_size; i++) {
		temp = ((double)exponent*i)/signal_size;
		weight[i] = pow(2, ceil(temp) - temp);
	}

	return 0;
}

int check_zero_signal(double* signal, unsigned int signal_size)
{
	int is_zero = 1;
	unsigned int i;

	for (i = 0; i &lt; signal_size; i++) {
		if (signal[i] != 0) {
			is_zero = 0;
			break;
		}
	}

	return is_zero;
}

// Performs one Lucas-Lehmer iteration using the IBDWT algorithm
int do_iteration(double* real, double* imag, double* weight, double* base, unsigned int signal_size)
{
	double sum_in, sum_out, difference;
		
	// I know that you can "embed" the real signal into the complex, but for clarity I'm avoiding that
	sum_in = forward_fast_fourier(real, imag, weight, signal_size);

	// Square the elements
	convulve_signal(real, imag, signal_size);

	// Invert the signal
	sum_out = inverse_fast_fourier(real, imag, weight, signal_size);

	// What's the difference between sum_in^2 and sum_out
	difference = fabs((sum_in * sum_in) - sum_out);
	if (difference &gt; 10)  // Uh oh, an error, they're not matching
		printf("**POSSIBLE ERROR**: SUMIN and SUMOUT differ by %.2f\n", difference);
		
	// Round the signal to integers
	round_signal(real, imag, signal_size);
	memset(imag, 0, signal_size*sizeof(double));

	// Modular reduce them to their variable base
	modular_reduce(real, base, signal_size); 
	// Subtract 2
	subtract_2(real, base, signal_size);

	return 0;
}

int main(int argc, char* argv[])
{

  double* real; // Real part of the signal
  double* imag; // Imaginary part of the signal
  unsigned int signal_size; // Signal length
  unsigned int exponent; // Exponent for the LL test (Change as needed)
  double* base; // Variable base of the signal
  double* weight; // Weight signal
  unsigned int i;

  exponent = atoi(argv[1]);

  // Find out the appropriate size for this exponent
  signal_size = compute_optimal_signal_size(exponent);

  // Allocate memory
  base = malloc(sizeof(double)*signal_size);
  weight = malloc(sizeof(double)*signal_size);
  real = malloc(sizeof(double)*signal_size);
  imag = malloc(sizeof(double)*signal_size);

  // Clear memory and compute the signals
  memset(real, 0, sizeof(double) * signal_size);
  memset(imag, 0, sizeof(double) * signal_size);
  compute_base_signal(base, exponent, signal_size);
  compute_weight_signal(weight, exponent, signal_size);

  real[0] = 4; // LL test starts with 4
  for (i = 0; i &lt; exponent-2; i++) {
    do_iteration(real, imag, weight, base, signal_size);
    if (i % 100 == 0)
      printf("%i\r\n", i);
  }

  if (check_zero_signal(real, signal_size) == 1)
    printf("PRIME!!!\n");
  else
    printf("Not Prime\n");

  // Clear memory
  free(base);
  free(weight);
  free(real);
  free(imag);
  return 0;
}

(* ****** ****** *)

(* end of [fft.dats] *)
</FONT></PRE></BODY>

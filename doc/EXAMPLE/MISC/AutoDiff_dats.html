<BODY BGCOLOR="#E0E0E0" TEXT="#E80000"><PRE><FONT COLOR="#000000">staload</FONT> <FONT COLOR="#0000FF">LIST <FONT COLOR="#000000">=</FONT> "prelude/DATS/list.dats"</FONT>
<FONT COLOR="#000000">staload</FONT> <FONT COLOR="#0000FF">REF <FONT COLOR="#000000">=</FONT> "prelude/DATS/reference.dats"</FONT>

<FONT COLOR="#000000">datatype</FONT> <FONT COLOR="#0000FF">dualnum</FONT> <FONT COLOR="#000000">=</FONT>
  <FONT COLOR="#000000">|</FONT> Base <FONT COLOR="#000000">of</FONT> <FONT COLOR="#0000FF">double</FONT> <FONT COLOR="#000000">|</FONT> Bundle <FONT COLOR="#000000">of</FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">(</FONT>int<FONT COLOR="#000000">,</FONT> dualnum<FONT COLOR="#000000">,</FONT> dualnum<FONT COLOR="#000000">)</FONT></FONT>

<FONT COLOR="#000000">typedef</FONT> <FONT COLOR="#0000FF">dualnumlst <FONT COLOR="#000000">(</FONT>n<FONT COLOR="#000000">:</FONT>int<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> list <FONT COLOR="#000000">(</FONT>dualnum<FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">)</FONT></FONT>
<FONT COLOR="#000000">typedef</FONT> <FONT COLOR="#0000FF">dualnumlst1 <FONT COLOR="#000000">=</FONT> dualnumlst 1</FONT>
<FONT COLOR="#000000">typedef</FONT> <FONT COLOR="#0000FF">dualnumlst2 <FONT COLOR="#000000">=</FONT> dualnumlst 2</FONT>
<FONT COLOR="#000000">typedef</FONT> <FONT COLOR="#0000FF">dualnumLst <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">[</FONT>n<FONT COLOR="#000000">:</FONT>nat<FONT COLOR="#000000">]</FONT> dualnumlst <FONT COLOR="#000000">(</FONT>n<FONT COLOR="#000000">)</FONT></FONT>

<FONT COLOR="#787878">(* ****** ****** *)</FONT>

<FONT COLOR="#000000">val</FONT> zero_dualnum<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">dualnum</FONT> <FONT COLOR="#000000">=</FONT> Base 0.0
<FONT COLOR="#000000">val</FONT> one_dualnum<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">dualnum</FONT> <FONT COLOR="#000000">=</FONT> Base 1.0
<FONT COLOR="#000000">val</FONT> negone_dualnum<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">dualnum</FONT> <FONT COLOR="#000000">=</FONT> Base <FONT COLOR="#000000">(</FONT>~1.0<FONT COLOR="#000000">)</FONT>
<FONT COLOR="#000000">val</FONT> two_dualnum<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">dualnum</FONT> <FONT COLOR="#000000">=</FONT> Base 2.0

<FONT COLOR="#000000">fn</FONT> epsilon <FONT COLOR="#000000">(</FONT>p<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">dualnum</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">int</FONT> <FONT COLOR="#000000">=</FONT>
  <FONT COLOR="#000000">case+</FONT> p <FONT COLOR="#000000">of</FONT> Base _ <FONT COLOR="#000000">=&gt;</FONT> 0 <FONT COLOR="#000000">|</FONT> Bundle <FONT COLOR="#000000">(</FONT>e<FONT COLOR="#000000">,</FONT> _<FONT COLOR="#000000">,</FONT> _<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=&gt;</FONT> e

<FONT COLOR="#000000">fn</FONT> primal <FONT COLOR="#000000">(</FONT>e<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">int</FONT><FONT COLOR="#000000">,</FONT> p<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">dualnum</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">dualnum</FONT> <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">case+</FONT> p <FONT COLOR="#000000">of</FONT>
  <FONT COLOR="#000000">|</FONT> Base _ <FONT COLOR="#000000">=&gt;</FONT> p
  <FONT COLOR="#000000">|</FONT> Bundle <FONT COLOR="#000000">(</FONT>e1<FONT COLOR="#000000">,</FONT> x<FONT COLOR="#000000">,</FONT> _<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=&gt;</FONT> <FONT COLOR="#000000">if</FONT> e1 <FONT COLOR="#000000">&lt;</FONT> e <FONT COLOR="#000000">then</FONT> p <FONT COLOR="#000000">else</FONT> x

<FONT COLOR="#000000">fn</FONT> perturbation <FONT COLOR="#000000">(</FONT>e<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">int</FONT><FONT COLOR="#000000">,</FONT> p<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">dualnum</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">dualnum</FONT> <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">case+</FONT> p <FONT COLOR="#000000">of</FONT>
  <FONT COLOR="#000000">|</FONT> Base _ <FONT COLOR="#000000">=&gt;</FONT> zero_dualnum
  <FONT COLOR="#000000">|</FONT> Bundle <FONT COLOR="#000000">(</FONT>e1<FONT COLOR="#000000">,</FONT> _<FONT COLOR="#000000">,</FONT> x'<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=&gt;</FONT> <FONT COLOR="#000000">if</FONT> e1 <FONT COLOR="#000000">&lt;</FONT> e <FONT COLOR="#000000">then</FONT> zero_dualnum <FONT COLOR="#000000">else</FONT> x'

<FONT COLOR="#000000">val</FONT> EPSILON <FONT COLOR="#000000">=</FONT> ref_make_elt&lt;<FONT COLOR="#0000FF">int</FONT><FONT COLOR="#000000">&gt;</FONT> <FONT COLOR="#000000">(</FONT>0<FONT COLOR="#000000">)</FONT>
<FONT COLOR="#000000">fn</FONT> derivative <FONT COLOR="#000000">(</FONT>f<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">dualnum <FONT COLOR="#000000">-&gt;</FONT> dualnum</FONT><FONT COLOR="#000000">,</FONT> x<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">dualnum</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">dualnum</FONT> <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">let</FONT>
  <FONT COLOR="#000000">val</FONT> e <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">!</FONT>EPSILON + 1
  <FONT COLOR="#000000">val</FONT> <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">!</FONT>EPSILON := e
  <FONT COLOR="#000000">val</FONT> result <FONT COLOR="#000000">=</FONT> perturbation <FONT COLOR="#000000">(</FONT>e<FONT COLOR="#000000">,</FONT> f <FONT COLOR="#000000">(</FONT>Bundle <FONT COLOR="#000000">(</FONT>e<FONT COLOR="#000000">,</FONT> x<FONT COLOR="#000000">,</FONT> one_dualnum<FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT>
  <FONT COLOR="#000000">val</FONT> <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">!</FONT>EPSILON := e - 1
<FONT COLOR="#000000">in</FONT>
  result
<FONT COLOR="#000000">end</FONT>

<FONT COLOR="#000000">fun</FONT> print_dualnum <FONT COLOR="#000000">(</FONT>p<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">dualnum</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">void</FONT> <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">case+</FONT> p <FONT COLOR="#000000">of</FONT>
  <FONT COLOR="#000000">|</FONT> Bundle <FONT COLOR="#000000">(</FONT>_<FONT COLOR="#000000">,</FONT> x<FONT COLOR="#000000">,</FONT> _<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=&gt;</FONT> print_dualnum x <FONT COLOR="#000000">|</FONT> Base x <FONT COLOR="#000000">=&gt;</FONT> printf <FONT COLOR="#000000">(</FONT>"%.18g"<FONT COLOR="#000000">,</FONT> <FONT COLOR="#000000">@(</FONT>x<FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT>

<FONT COLOR="#000000">fn</FONT> print_dualnumlst <FONT COLOR="#000000">(</FONT>ps<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">dualnumLst</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">void</FONT> <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">let</FONT>
  <FONT COLOR="#000000">fun</FONT> aux <FONT COLOR="#000000">(</FONT>i<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">int</FONT><FONT COLOR="#000000">,</FONT> ps<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">dualnumLst</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">void</FONT> <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">case+</FONT> ps <FONT COLOR="#000000">of</FONT>
    <FONT COLOR="#000000">|</FONT> list_cons <FONT COLOR="#000000">(</FONT>p<FONT COLOR="#000000">,</FONT> ps<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=&gt;</FONT> <FONT COLOR="#000000">begin</FONT>
        <FONT COLOR="#000000">if</FONT> i <FONT COLOR="#000000">&gt;</FONT> 0 <FONT COLOR="#000000">then</FONT> print ", "<FONT COLOR="#000000">;</FONT> print_dualnum p<FONT COLOR="#000000">;</FONT> aux <FONT COLOR="#000000">(</FONT>i+1<FONT COLOR="#000000">,</FONT> ps<FONT COLOR="#000000">)</FONT>
      <FONT COLOR="#000000">end</FONT>
    <FONT COLOR="#000000">|</FONT> _ <FONT COLOR="#000000">=&gt;</FONT> <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT>
<FONT COLOR="#000000">in</FONT>
  aux <FONT COLOR="#000000">(</FONT>0<FONT COLOR="#000000">,</FONT> ps<FONT COLOR="#000000">)</FONT>
<FONT COLOR="#000000">end</FONT>

<FONT COLOR="#787878">(* ****** ****** *)</FONT>

<FONT COLOR="#000000">extern</FONT> <FONT COLOR="#000000">fun</FONT> neg_dualnum <FONT COLOR="#000000">(</FONT>p<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">dualnum</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">dualnum</FONT>
<FONT COLOR="#000000">overload</FONT> <FONT COLOR="#800080"><FONT COLOR="#000000">~</FONT> <FONT COLOR="#000000">with</FONT> neg_dualnum</FONT>

<FONT COLOR="#000000">extern</FONT> <FONT COLOR="#000000">fun</FONT> recip_dualnum <FONT COLOR="#000000">(</FONT>p<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">dualnum</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">dualnum</FONT>

<FONT COLOR="#000000">extern</FONT> <FONT COLOR="#000000">fun</FONT> add_dualnum_dualnum <FONT COLOR="#000000">(</FONT>p1<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">dualnum</FONT><FONT COLOR="#000000">,</FONT> p2<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">dualnum</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">dualnum</FONT>
<FONT COLOR="#000000">overload</FONT> <FONT COLOR="#800080">+ <FONT COLOR="#000000">with</FONT> add_dualnum_dualnum</FONT>

<FONT COLOR="#000000">extern</FONT> <FONT COLOR="#000000">fun</FONT> sub_dualnum_dualnum <FONT COLOR="#000000">(</FONT>p1<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">dualnum</FONT><FONT COLOR="#000000">,</FONT> p2<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">dualnum</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">dualnum</FONT>
<FONT COLOR="#000000">overload</FONT> <FONT COLOR="#800080">- <FONT COLOR="#000000">with</FONT> sub_dualnum_dualnum</FONT>

<FONT COLOR="#000000">extern</FONT> <FONT COLOR="#000000">fun</FONT> mul_dualnum_dualnum <FONT COLOR="#000000">(</FONT>p1<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">dualnum</FONT><FONT COLOR="#000000">,</FONT> p2<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">dualnum</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">dualnum</FONT>
<FONT COLOR="#000000">overload</FONT> <FONT COLOR="#800080">* <FONT COLOR="#000000">with</FONT> mul_dualnum_dualnum</FONT>

<FONT COLOR="#000000">extern</FONT> <FONT COLOR="#000000">fun</FONT> div_dualnum_dualnum <FONT COLOR="#000000">(</FONT>p1<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">dualnum</FONT><FONT COLOR="#000000">,</FONT> p2<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">dualnum</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">dualnum</FONT>
<FONT COLOR="#000000">overload</FONT> <FONT COLOR="#800080">/ <FONT COLOR="#000000">with</FONT> div_dualnum_dualnum</FONT>

<FONT COLOR="#787878">//
</FONT>
<FONT COLOR="#000000">implement</FONT> neg_dualnum <FONT COLOR="#000000">(</FONT>p<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">case+</FONT> p <FONT COLOR="#000000">of</FONT>
  <FONT COLOR="#000000">|</FONT> Bundle <FONT COLOR="#000000">(</FONT>e<FONT COLOR="#000000">,</FONT> x<FONT COLOR="#000000">,</FONT> x'<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=&gt;</FONT> Bundle <FONT COLOR="#000000">(</FONT>e<FONT COLOR="#000000">,</FONT> <FONT COLOR="#000000">~</FONT>x<FONT COLOR="#000000">,</FONT> <FONT COLOR="#000000">~</FONT>x'<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">|</FONT> Base x <FONT COLOR="#000000">=&gt;</FONT> Base <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">~</FONT>x<FONT COLOR="#000000">)</FONT>

<FONT COLOR="#787878">//
</FONT>
<FONT COLOR="#000000">implement</FONT> add_dualnum_dualnum <FONT COLOR="#000000">(</FONT>p1<FONT COLOR="#000000">,</FONT> p2<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> 
  <FONT COLOR="#000000">case+</FONT> p1 <FONT COLOR="#000000">of</FONT>
  <FONT COLOR="#000000">|</FONT> Bundle <FONT COLOR="#000000">(</FONT>e1<FONT COLOR="#000000">,</FONT> x1<FONT COLOR="#000000">,</FONT> x1'<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=&gt;</FONT> <FONT COLOR="#000000">begin</FONT> <FONT COLOR="#000000">case+</FONT> p2 <FONT COLOR="#000000">of</FONT>
    <FONT COLOR="#000000">|</FONT> Bundle <FONT COLOR="#000000">(</FONT>e2<FONT COLOR="#000000">,</FONT> x2<FONT COLOR="#000000">,</FONT> x2'<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=&gt;</FONT> <FONT COLOR="#000000">let</FONT>
        <FONT COLOR="#000000">val</FONT> e<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">int</FONT> <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">if</FONT> e1 &lt;= e2 <FONT COLOR="#000000">then</FONT> e2 <FONT COLOR="#000000">else</FONT> e1
        <FONT COLOR="#000000">val</FONT> x <FONT COLOR="#000000">=</FONT> primal <FONT COLOR="#000000">(</FONT>e<FONT COLOR="#000000">,</FONT> p1<FONT COLOR="#000000">)</FONT> + primal <FONT COLOR="#000000">(</FONT>e<FONT COLOR="#000000">,</FONT> p2<FONT COLOR="#000000">)</FONT>
        <FONT COLOR="#000000">val</FONT> x' <FONT COLOR="#000000">=</FONT> perturbation <FONT COLOR="#000000">(</FONT>e<FONT COLOR="#000000">,</FONT> p1<FONT COLOR="#000000">)</FONT> + perturbation <FONT COLOR="#000000">(</FONT>e<FONT COLOR="#000000">,</FONT> p2<FONT COLOR="#000000">)</FONT>
      <FONT COLOR="#000000">in</FONT>
        Bundle <FONT COLOR="#000000">(</FONT>e<FONT COLOR="#000000">,</FONT> x<FONT COLOR="#000000">,</FONT> x'<FONT COLOR="#000000">)</FONT>
      <FONT COLOR="#000000">end</FONT>
    <FONT COLOR="#000000">|</FONT> Base x2 <FONT COLOR="#000000">=&gt;</FONT> Bundle <FONT COLOR="#000000">(</FONT>e1<FONT COLOR="#000000">,</FONT> x1 + p2<FONT COLOR="#000000">,</FONT> x1'<FONT COLOR="#000000">)</FONT>
    <FONT COLOR="#000000">end</FONT>
  <FONT COLOR="#000000">|</FONT> Base x1 <FONT COLOR="#000000">=&gt;</FONT> <FONT COLOR="#000000">begin</FONT> <FONT COLOR="#000000">case+</FONT> p2 <FONT COLOR="#000000">of</FONT>
    <FONT COLOR="#000000">|</FONT> Bundle <FONT COLOR="#000000">(</FONT>e2<FONT COLOR="#000000">,</FONT> x2<FONT COLOR="#000000">,</FONT> x2'<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=&gt;</FONT> Bundle <FONT COLOR="#000000">(</FONT>e2<FONT COLOR="#000000">,</FONT> p1 + x2<FONT COLOR="#000000">,</FONT> x2'<FONT COLOR="#000000">)</FONT>
    <FONT COLOR="#000000">|</FONT> Base x2 <FONT COLOR="#000000">=&gt;</FONT> Base <FONT COLOR="#000000">(</FONT>x1 + x2<FONT COLOR="#000000">)</FONT>
    <FONT COLOR="#000000">end</FONT>

<FONT COLOR="#787878">//
</FONT>
<FONT COLOR="#000000">implement</FONT> sub_dualnum_dualnum <FONT COLOR="#000000">(</FONT>p1<FONT COLOR="#000000">,</FONT> p2<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> 
  <FONT COLOR="#000000">case+</FONT> p1 <FONT COLOR="#000000">of</FONT>
  <FONT COLOR="#000000">|</FONT> Bundle <FONT COLOR="#000000">(</FONT>e1<FONT COLOR="#000000">,</FONT> x1<FONT COLOR="#000000">,</FONT> x1'<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=&gt;</FONT> <FONT COLOR="#000000">begin</FONT> <FONT COLOR="#000000">case+</FONT> p2 <FONT COLOR="#000000">of</FONT>
    <FONT COLOR="#000000">|</FONT> Bundle <FONT COLOR="#000000">(</FONT>e2<FONT COLOR="#000000">,</FONT> x2<FONT COLOR="#000000">,</FONT> x2'<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=&gt;</FONT> <FONT COLOR="#000000">let</FONT>
        <FONT COLOR="#000000">val</FONT> e<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">int</FONT> <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">if</FONT> e1 &lt;= e2 <FONT COLOR="#000000">then</FONT> e2 <FONT COLOR="#000000">else</FONT> e1
        <FONT COLOR="#000000">val</FONT> x <FONT COLOR="#000000">=</FONT> primal <FONT COLOR="#000000">(</FONT>e<FONT COLOR="#000000">,</FONT> p1<FONT COLOR="#000000">)</FONT> - primal <FONT COLOR="#000000">(</FONT>e<FONT COLOR="#000000">,</FONT> p2<FONT COLOR="#000000">)</FONT>
        <FONT COLOR="#000000">val</FONT> x' <FONT COLOR="#000000">=</FONT> perturbation <FONT COLOR="#000000">(</FONT>e<FONT COLOR="#000000">,</FONT> p1<FONT COLOR="#000000">)</FONT> - perturbation <FONT COLOR="#000000">(</FONT>e<FONT COLOR="#000000">,</FONT> p2<FONT COLOR="#000000">)</FONT>
      <FONT COLOR="#000000">in</FONT>
        Bundle <FONT COLOR="#000000">(</FONT>e<FONT COLOR="#000000">,</FONT> x<FONT COLOR="#000000">,</FONT> x'<FONT COLOR="#000000">)</FONT>
      <FONT COLOR="#000000">end</FONT>
    <FONT COLOR="#000000">|</FONT> Base x2 <FONT COLOR="#000000">=&gt;</FONT> Bundle <FONT COLOR="#000000">(</FONT>e1<FONT COLOR="#000000">,</FONT> x1 - p2<FONT COLOR="#000000">,</FONT> x1'<FONT COLOR="#000000">)</FONT>
    <FONT COLOR="#000000">end</FONT>
  <FONT COLOR="#000000">|</FONT> Base x1 <FONT COLOR="#000000">=&gt;</FONT> <FONT COLOR="#000000">begin</FONT> <FONT COLOR="#000000">case+</FONT> p2 <FONT COLOR="#000000">of</FONT>
    <FONT COLOR="#000000">|</FONT> Bundle <FONT COLOR="#000000">(</FONT>e2<FONT COLOR="#000000">,</FONT> x2<FONT COLOR="#000000">,</FONT> x2'<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=&gt;</FONT> Bundle <FONT COLOR="#000000">(</FONT>e2<FONT COLOR="#000000">,</FONT> p1 - x2<FONT COLOR="#000000">,</FONT> <FONT COLOR="#000000">~</FONT>x2'<FONT COLOR="#000000">)</FONT>
    <FONT COLOR="#000000">|</FONT> Base x2 <FONT COLOR="#000000">=&gt;</FONT> Base <FONT COLOR="#000000">(</FONT>x1 - x2<FONT COLOR="#000000">)</FONT>
    <FONT COLOR="#000000">end</FONT>

<FONT COLOR="#787878">//
</FONT>
<FONT COLOR="#000000">implement</FONT> mul_dualnum_dualnum <FONT COLOR="#000000">(</FONT>p1<FONT COLOR="#000000">,</FONT> p2<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> 
  <FONT COLOR="#000000">case+</FONT> p1 <FONT COLOR="#000000">of</FONT>
  <FONT COLOR="#000000">|</FONT> Bundle <FONT COLOR="#000000">(</FONT>e1<FONT COLOR="#000000">,</FONT> x1<FONT COLOR="#000000">,</FONT> x1'<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=&gt;</FONT> <FONT COLOR="#000000">begin</FONT> <FONT COLOR="#000000">case+</FONT> p2 <FONT COLOR="#000000">of</FONT>
    <FONT COLOR="#000000">|</FONT> Bundle <FONT COLOR="#000000">(</FONT>e2<FONT COLOR="#000000">,</FONT> x2<FONT COLOR="#000000">,</FONT> x2'<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=&gt;</FONT> <FONT COLOR="#000000">let</FONT>
        <FONT COLOR="#000000">val</FONT> e<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">int</FONT> <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">if</FONT> e1 &lt;= e2 <FONT COLOR="#000000">then</FONT> e2 <FONT COLOR="#000000">else</FONT> e1
        <FONT COLOR="#000000">val</FONT> x1 <FONT COLOR="#000000">=</FONT> primal <FONT COLOR="#000000">(</FONT>e<FONT COLOR="#000000">,</FONT> p1<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">and</FONT> x2 <FONT COLOR="#000000">=</FONT> primal <FONT COLOR="#000000">(</FONT>e<FONT COLOR="#000000">,</FONT> p2<FONT COLOR="#000000">)</FONT>
        <FONT COLOR="#000000">val</FONT> x <FONT COLOR="#000000">=</FONT> x1 * x2
        <FONT COLOR="#000000">val</FONT> x' <FONT COLOR="#000000">=</FONT> x1 * perturbation <FONT COLOR="#000000">(</FONT>e<FONT COLOR="#000000">,</FONT> p2<FONT COLOR="#000000">)</FONT> + x2 * perturbation <FONT COLOR="#000000">(</FONT>e<FONT COLOR="#000000">,</FONT> p1<FONT COLOR="#000000">)</FONT>
      <FONT COLOR="#000000">in</FONT>
        Bundle <FONT COLOR="#000000">(</FONT>e<FONT COLOR="#000000">,</FONT> x<FONT COLOR="#000000">,</FONT> x'<FONT COLOR="#000000">)</FONT>
      <FONT COLOR="#000000">end</FONT>
    <FONT COLOR="#000000">|</FONT> Base x2 <FONT COLOR="#000000">=&gt;</FONT> Bundle <FONT COLOR="#000000">(</FONT>e1<FONT COLOR="#000000">,</FONT> x1 * p2<FONT COLOR="#000000">,</FONT> p2 * x1'<FONT COLOR="#000000">)</FONT>
    <FONT COLOR="#000000">end</FONT>
  <FONT COLOR="#000000">|</FONT> Base x1 <FONT COLOR="#000000">=&gt;</FONT> <FONT COLOR="#000000">begin</FONT> <FONT COLOR="#000000">case+</FONT> p2 <FONT COLOR="#000000">of</FONT>
    <FONT COLOR="#000000">|</FONT> Bundle <FONT COLOR="#000000">(</FONT>e2<FONT COLOR="#000000">,</FONT> x2<FONT COLOR="#000000">,</FONT> x2'<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=&gt;</FONT> Bundle <FONT COLOR="#000000">(</FONT>e2<FONT COLOR="#000000">,</FONT> p1 * x2<FONT COLOR="#000000">,</FONT> p1 * x2'<FONT COLOR="#000000">)</FONT>
    <FONT COLOR="#000000">|</FONT> Base x2 <FONT COLOR="#000000">=&gt;</FONT> Base <FONT COLOR="#000000">(</FONT>x1 * x2<FONT COLOR="#000000">)</FONT>
    <FONT COLOR="#000000">end</FONT>

<FONT COLOR="#787878">//
</FONT>
<FONT COLOR="#000000">implement</FONT> recip_dualnum <FONT COLOR="#000000">(</FONT>p<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">case+</FONT> p <FONT COLOR="#000000">of</FONT>
  <FONT COLOR="#000000">|</FONT> Bundle <FONT COLOR="#000000">(</FONT>e<FONT COLOR="#000000">,</FONT> x<FONT COLOR="#000000">,</FONT> x'<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=&gt;</FONT> Bundle <FONT COLOR="#000000">(</FONT>e<FONT COLOR="#000000">,</FONT> recip_dualnum x<FONT COLOR="#000000">,</FONT> <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">~</FONT>x'<FONT COLOR="#000000">)</FONT> / <FONT COLOR="#000000">(</FONT>x * x<FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT>
  <FONT COLOR="#000000">|</FONT> Base x <FONT COLOR="#000000">=&gt;</FONT> Base <FONT COLOR="#000000">(</FONT>1.0 / x<FONT COLOR="#000000">)</FONT>

<FONT COLOR="#000000">implement</FONT> div_dualnum_dualnum <FONT COLOR="#000000">(</FONT>p1<FONT COLOR="#000000">,</FONT> p2<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> p1 * <FONT COLOR="#000000">(</FONT>recip_dualnum p2<FONT COLOR="#000000">)</FONT>

<FONT COLOR="#787878">//
</FONT>
<FONT COLOR="#000000">extern</FONT> <FONT COLOR="#000000">fun</FONT> sqrt_dualnum <FONT COLOR="#000000">(</FONT>p<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">dualnum</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">dualnum</FONT>
<FONT COLOR="#000000">overload</FONT> <FONT COLOR="#800080">sqrt <FONT COLOR="#000000">with</FONT> sqrt_dualnum</FONT>

<FONT COLOR="#000000">implement</FONT> sqrt_dualnum <FONT COLOR="#000000">(</FONT>p<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">case+</FONT> p <FONT COLOR="#000000">of</FONT>
  <FONT COLOR="#000000">|</FONT> Bundle <FONT COLOR="#000000">(</FONT>e<FONT COLOR="#000000">,</FONT> x<FONT COLOR="#000000">,</FONT> x'<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=&gt;</FONT> <FONT COLOR="#000000">let</FONT>
      <FONT COLOR="#000000">val</FONT> x_sqrt <FONT COLOR="#000000">=</FONT> sqrt x
      <FONT COLOR="#000000">val</FONT> x'_sqrt <FONT COLOR="#000000">=</FONT> x' / <FONT COLOR="#000000">(</FONT>x_sqrt + x_sqrt<FONT COLOR="#000000">)</FONT>
    <FONT COLOR="#000000">in</FONT>
      Bundle <FONT COLOR="#000000">(</FONT>e<FONT COLOR="#000000">,</FONT> x_sqrt<FONT COLOR="#000000">,</FONT> x'_sqrt<FONT COLOR="#000000">)</FONT>
    <FONT COLOR="#000000">end</FONT>
  <FONT COLOR="#000000">|</FONT> Base x <FONT COLOR="#000000">=&gt;</FONT> Base <FONT COLOR="#000000">(</FONT>sqrt x<FONT COLOR="#000000">)</FONT>

<FONT COLOR="#787878">//
</FONT>
<FONT COLOR="#000000">extern</FONT> <FONT COLOR="#000000">fun</FONT> lt_dualnum_dualnum <FONT COLOR="#000000">(</FONT>p1<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">dualnum</FONT><FONT COLOR="#000000">,</FONT> p2<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">dualnum</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">bool</FONT>
<FONT COLOR="#000000">overload</FONT> <FONT COLOR="#800080"><FONT COLOR="#000000">&lt;</FONT> <FONT COLOR="#000000">with</FONT> lt_dualnum_dualnum</FONT>

<FONT COLOR="#000000">implement</FONT> lt_dualnum_dualnum <FONT COLOR="#000000">(</FONT>p1<FONT COLOR="#000000">,</FONT> p2<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT>
  <FONT COLOR="#000000">case+</FONT> p1 <FONT COLOR="#000000">of</FONT>
  <FONT COLOR="#000000">|</FONT> Bundle <FONT COLOR="#000000">(</FONT>_<FONT COLOR="#000000">,</FONT> x1<FONT COLOR="#000000">,</FONT> _<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=&gt;</FONT> <FONT COLOR="#000000">begin</FONT> <FONT COLOR="#000000">case+</FONT> p2 <FONT COLOR="#000000">of</FONT>
    <FONT COLOR="#000000">|</FONT> Bundle <FONT COLOR="#000000">(</FONT>_<FONT COLOR="#000000">,</FONT> x2<FONT COLOR="#000000">,</FONT> _<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=&gt;</FONT> x1 <FONT COLOR="#000000">&lt;</FONT> x2 <FONT COLOR="#000000">|</FONT> Base x2 <FONT COLOR="#000000">=&gt;</FONT> x1 <FONT COLOR="#000000">&lt;</FONT> p2
    <FONT COLOR="#000000">end</FONT>
  <FONT COLOR="#000000">|</FONT> Base x1 <FONT COLOR="#000000">=&gt;</FONT> <FONT COLOR="#000000">begin</FONT> <FONT COLOR="#000000">case+</FONT> p2 <FONT COLOR="#000000">of</FONT>
    <FONT COLOR="#000000">|</FONT> Bundle <FONT COLOR="#000000">(</FONT>_<FONT COLOR="#000000">,</FONT> x2<FONT COLOR="#000000">,</FONT> _<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=&gt;</FONT> p1 <FONT COLOR="#000000">&lt;</FONT> x2 <FONT COLOR="#000000">|</FONT> Base x2 <FONT COLOR="#000000">=&gt;</FONT> x1 <FONT COLOR="#000000">&lt;</FONT> x2
    <FONT COLOR="#000000">end</FONT>

<FONT COLOR="#000000">extern</FONT> <FONT COLOR="#000000">fun</FONT> lte_dualnum_dualnum <FONT COLOR="#000000">(</FONT>p1<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">dualnum</FONT><FONT COLOR="#000000">,</FONT> p2<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">dualnum</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">bool</FONT>
<FONT COLOR="#000000">overload</FONT> <FONT COLOR="#800080">&lt;= <FONT COLOR="#000000">with</FONT> lte_dualnum_dualnum</FONT>

<FONT COLOR="#000000">implement</FONT> lte_dualnum_dualnum <FONT COLOR="#000000">(</FONT>p1<FONT COLOR="#000000">,</FONT> p2<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT>
  <FONT COLOR="#000000">case+</FONT> p1 <FONT COLOR="#000000">of</FONT>
  <FONT COLOR="#000000">|</FONT> Bundle <FONT COLOR="#000000">(</FONT>_<FONT COLOR="#000000">,</FONT> x1<FONT COLOR="#000000">,</FONT> _<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=&gt;</FONT> <FONT COLOR="#000000">begin</FONT> <FONT COLOR="#000000">case+</FONT> p2 <FONT COLOR="#000000">of</FONT>
    <FONT COLOR="#000000">|</FONT> Bundle <FONT COLOR="#000000">(</FONT>_<FONT COLOR="#000000">,</FONT> x2<FONT COLOR="#000000">,</FONT> _<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=&gt;</FONT> x1 &lt;= x2 <FONT COLOR="#000000">|</FONT> Base x2 <FONT COLOR="#000000">=&gt;</FONT> x1 &lt;= p2
    <FONT COLOR="#000000">end</FONT>
  <FONT COLOR="#000000">|</FONT> Base x1 <FONT COLOR="#000000">=&gt;</FONT> <FONT COLOR="#000000">begin</FONT> <FONT COLOR="#000000">case+</FONT> p2 <FONT COLOR="#000000">of</FONT>
    <FONT COLOR="#000000">|</FONT> Bundle <FONT COLOR="#000000">(</FONT>_<FONT COLOR="#000000">,</FONT> x2<FONT COLOR="#000000">,</FONT> _<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=&gt;</FONT> p1 &lt;= x2 <FONT COLOR="#000000">|</FONT> Base x2 <FONT COLOR="#000000">=&gt;</FONT> x1 &lt;= x2
    <FONT COLOR="#000000">end</FONT>

<FONT COLOR="#787878">(* ****** ****** *)</FONT>

<FONT COLOR="#000000">fn</FONT> square <FONT COLOR="#000000">(</FONT>p<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">dualnum</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">dualnum</FONT> <FONT COLOR="#000000">=</FONT> p * p

<FONT COLOR="#000000">fn</FONT> list_tabulate <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>n<FONT COLOR="#000000">:</FONT>nat<FONT COLOR="#000000">}</FONT></FONT>
  <FONT COLOR="#000000">(</FONT>f<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">natLt n <FONT COLOR="#000000">-&gt;</FONT> dualnum</FONT><FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">int n</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">dualnumlst n</FONT> <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">let</FONT>
  <FONT COLOR="#000000">fun</FONT> aux <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>i<FONT COLOR="#000000">:</FONT>int <FONT COLOR="#000000">|</FONT> ~1 &lt;= i<FONT COLOR="#000000">;</FONT> i <FONT COLOR="#000000">&lt;</FONT> n<FONT COLOR="#000000">}</FONT></FONT>
    <FONT COLOR="#000000">(</FONT>f<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">natLt n <FONT COLOR="#000000">-&gt;</FONT> dualnum</FONT><FONT COLOR="#000000">,</FONT> i<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">int i</FONT><FONT COLOR="#000000">,</FONT> res<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">list <FONT COLOR="#000000">(</FONT>dualnum<FONT COLOR="#000000">,</FONT> n-i-1<FONT COLOR="#000000">)</FONT></FONT><FONT COLOR="#000000">)</FONT>
    <FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">list <FONT COLOR="#000000">(</FONT>dualnum<FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">)</FONT></FONT> <FONT COLOR="#000000">=</FONT>
    <FONT COLOR="#000000">if</FONT> i &gt;= 0 <FONT COLOR="#000000">then</FONT> aux <FONT COLOR="#000000">(</FONT>f<FONT COLOR="#000000">,</FONT> i-1<FONT COLOR="#000000">,</FONT> list_cons <FONT COLOR="#000000">(</FONT>f i<FONT COLOR="#000000">,</FONT> res<FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">else</FONT> res
<FONT COLOR="#000000">in</FONT>
  aux <FONT COLOR="#000000">(</FONT>f<FONT COLOR="#000000">,</FONT> n-1<FONT COLOR="#000000">,</FONT> list_nil <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT>
<FONT COLOR="#000000">end</FONT>

<FONT COLOR="#000000">fun</FONT> vplus <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>n<FONT COLOR="#000000">:</FONT>nat<FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">.&lt;</FONT>n<FONT COLOR="#000000">&gt;.</FONT></FONT>
  <FONT COLOR="#000000">(</FONT>us<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">dualnumlst n</FONT><FONT COLOR="#000000">,</FONT> vs<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">dualnumlst n</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">dualnumlst n</FONT> <FONT COLOR="#000000">=</FONT>
  <FONT COLOR="#000000">case+</FONT> us <FONT COLOR="#000000">of</FONT>
  <FONT COLOR="#000000">|</FONT> list_cons <FONT COLOR="#000000">(</FONT>u<FONT COLOR="#000000">,</FONT> us<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=&gt;</FONT> <FONT COLOR="#000000">let</FONT>
      <FONT COLOR="#000000">val+</FONT> list_cons <FONT COLOR="#000000">(</FONT>v<FONT COLOR="#000000">,</FONT> vs<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> vs
    <FONT COLOR="#000000">in</FONT>
      list_cons <FONT COLOR="#000000">(</FONT>u + v<FONT COLOR="#000000">,</FONT> vplus <FONT COLOR="#000000">(</FONT>us<FONT COLOR="#000000">,</FONT> vs<FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT>
    <FONT COLOR="#000000">end</FONT>
  <FONT COLOR="#000000">|</FONT> _ <FONT COLOR="#000000">=&gt;&gt;</FONT> list_nil <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT>

<FONT COLOR="#000000">fun</FONT> vminus <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>n<FONT COLOR="#000000">:</FONT>nat<FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">.&lt;</FONT>n<FONT COLOR="#000000">&gt;.</FONT></FONT>
  <FONT COLOR="#000000">(</FONT>us<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">dualnumlst n</FONT><FONT COLOR="#000000">,</FONT> vs<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">dualnumlst n</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">dualnumlst n</FONT> <FONT COLOR="#000000">=</FONT>
  <FONT COLOR="#000000">case+</FONT> us <FONT COLOR="#000000">of</FONT>
  <FONT COLOR="#000000">|</FONT> list_cons <FONT COLOR="#000000">(</FONT>u<FONT COLOR="#000000">,</FONT> us<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=&gt;</FONT> <FONT COLOR="#000000">let</FONT>
      <FONT COLOR="#000000">val+</FONT> list_cons <FONT COLOR="#000000">(</FONT>v<FONT COLOR="#000000">,</FONT> vs<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> vs
    <FONT COLOR="#000000">in</FONT>
      list_cons <FONT COLOR="#000000">(</FONT>u - v<FONT COLOR="#000000">,</FONT> vminus <FONT COLOR="#000000">(</FONT>us<FONT COLOR="#000000">,</FONT> vs<FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT>
    <FONT COLOR="#000000">end</FONT>
  <FONT COLOR="#000000">|</FONT> _ <FONT COLOR="#000000">=&gt;&gt;</FONT> list_nil <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT>

<FONT COLOR="#000000">fun</FONT> vscale <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>n<FONT COLOR="#000000">:</FONT>nat<FONT COLOR="#000000">}</FONT></FONT>
  <FONT COLOR="#000000">(</FONT>k<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">dualnum</FONT><FONT COLOR="#000000">,</FONT> xs<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">dualnumlst n</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">dualnumlst n</FONT> <FONT COLOR="#000000">=</FONT>
  <FONT COLOR="#000000">case+</FONT> xs <FONT COLOR="#000000">of</FONT>
  <FONT COLOR="#000000">|</FONT> list_cons <FONT COLOR="#000000">(</FONT>x<FONT COLOR="#000000">,</FONT> xs<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=&gt;</FONT> list_cons <FONT COLOR="#000000">(</FONT>k * x<FONT COLOR="#000000">,</FONT> vscale <FONT COLOR="#000000">(</FONT>k<FONT COLOR="#000000">,</FONT> xs<FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT>
  <FONT COLOR="#000000">|</FONT> list_nil <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=&gt;</FONT> list_nil <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT>

<FONT COLOR="#000000">fn</FONT> magnitude_squared <FONT COLOR="#000000">(</FONT>xs<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">dualnumLst</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">dualnum</FONT> <FONT COLOR="#000000">=</FONT>
  <FONT COLOR="#000000">let</FONT>
    <FONT COLOR="#000000">fun</FONT> aux <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>n<FONT COLOR="#000000">:</FONT>nat<FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">.&lt;</FONT>n<FONT COLOR="#000000">&gt;.</FONT></FONT>
      <FONT COLOR="#000000">(</FONT>xs<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">dualnumlst n</FONT><FONT COLOR="#000000">,</FONT> res<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">dualnum</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">dualnum</FONT> <FONT COLOR="#000000">=</FONT>
      <FONT COLOR="#000000">case+</FONT> xs <FONT COLOR="#000000">of</FONT> list_cons <FONT COLOR="#000000">(</FONT>x<FONT COLOR="#000000">,</FONT> xs<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=&gt;</FONT> aux <FONT COLOR="#000000">(</FONT>xs<FONT COLOR="#000000">,</FONT> res + x * x<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">|</FONT> _ <FONT COLOR="#000000">=&gt;</FONT> res
  <FONT COLOR="#000000">in</FONT>
    aux <FONT COLOR="#000000">(</FONT>xs<FONT COLOR="#000000">,</FONT> zero_dualnum<FONT COLOR="#000000">)</FONT>
  <FONT COLOR="#000000">end</FONT>

<FONT COLOR="#000000">fn</FONT> magnitude <FONT COLOR="#000000">(</FONT>xs<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">dualnumLst</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">dualnum</FONT> <FONT COLOR="#000000">=</FONT> sqrt <FONT COLOR="#000000">(</FONT>magnitude_squared xs<FONT COLOR="#000000">)</FONT>
<FONT COLOR="#000000">fn</FONT> distance <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>n<FONT COLOR="#000000">:</FONT>nat<FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#000000">(</FONT>us<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">dualnumlst n</FONT><FONT COLOR="#000000">,</FONT> vs<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">dualnumlst n</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">dualnum</FONT> <FONT COLOR="#000000">=</FONT>
  magnitude <FONT COLOR="#000000">(</FONT>vminus <FONT COLOR="#000000">(</FONT>us<FONT COLOR="#000000">,</FONT> vs<FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT>

<FONT COLOR="#000000">fun</FONT> list_nth_get <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>n<FONT COLOR="#000000">:</FONT>nat<FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">.&lt;</FONT>n<FONT COLOR="#000000">&gt;.</FONT></FONT>
  <FONT COLOR="#000000">(</FONT>xs<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">dualnumlst n</FONT><FONT COLOR="#000000">,</FONT> i<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">natLt n</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">dualnum</FONT> <FONT COLOR="#000000">=</FONT>
  <FONT COLOR="#000000">if</FONT> i <FONT COLOR="#000000">&gt;</FONT> 0 <FONT COLOR="#000000">then</FONT> <FONT COLOR="#000000">begin</FONT>
    <FONT COLOR="#000000">let</FONT> <FONT COLOR="#000000">val+</FONT> list_cons <FONT COLOR="#000000">(</FONT>_<FONT COLOR="#000000">,</FONT> xs<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> xs <FONT COLOR="#000000">in</FONT> list_nth_get <FONT COLOR="#000000">(</FONT>xs<FONT COLOR="#000000">,</FONT> i-1<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">end</FONT>
  <FONT COLOR="#000000">end</FONT> <FONT COLOR="#000000">else</FONT> <FONT COLOR="#000000">begin</FONT>
    <FONT COLOR="#000000">let</FONT> <FONT COLOR="#000000">val+</FONT> list_cons <FONT COLOR="#000000">(</FONT>x<FONT COLOR="#000000">,</FONT> _<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> xs <FONT COLOR="#000000">in</FONT> x <FONT COLOR="#000000">end</FONT>
  <FONT COLOR="#000000">end</FONT>

<FONT COLOR="#000000">fun</FONT> list_nth_set <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>n<FONT COLOR="#000000">:</FONT>nat<FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">.&lt;</FONT>n<FONT COLOR="#000000">&gt;.</FONT></FONT>
  <FONT COLOR="#000000">(</FONT>xs<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">dualnumlst n</FONT><FONT COLOR="#000000">,</FONT> i<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">natLt n</FONT><FONT COLOR="#000000">,</FONT> x0<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">dualnum</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">dualnumlst n</FONT> <FONT COLOR="#000000">=</FONT>
  <FONT COLOR="#000000">if</FONT> i <FONT COLOR="#000000">&gt;</FONT> 0 <FONT COLOR="#000000">then</FONT> <FONT COLOR="#000000">let</FONT>
    <FONT COLOR="#000000">val+</FONT> list_cons <FONT COLOR="#000000">(</FONT>x<FONT COLOR="#000000">,</FONT> xs<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> xs
  <FONT COLOR="#000000">in</FONT>
    list_cons <FONT COLOR="#000000">(</FONT>x<FONT COLOR="#000000">,</FONT> list_nth_set <FONT COLOR="#000000">(</FONT>xs<FONT COLOR="#000000">,</FONT> i-1<FONT COLOR="#000000">,</FONT> x0<FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT>
  <FONT COLOR="#000000">end</FONT> <FONT COLOR="#000000">else</FONT> <FONT COLOR="#000000">begin</FONT>
    <FONT COLOR="#000000">let</FONT> <FONT COLOR="#000000">val+</FONT> list_cons <FONT COLOR="#000000">(</FONT>_<FONT COLOR="#000000">,</FONT> xs<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> xs <FONT COLOR="#000000">in</FONT> list_cons <FONT COLOR="#000000">(</FONT>x0<FONT COLOR="#000000">,</FONT> xs<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">end</FONT>
  <FONT COLOR="#000000">end</FONT>

<FONT COLOR="#000000">fn</FONT> gradient <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>n<FONT COLOR="#000000">:</FONT>nat<FONT COLOR="#000000">}</FONT></FONT>
  <FONT COLOR="#000000">(</FONT>f<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">dualnumlst n <FONT COLOR="#000000">-&gt;</FONT> dualnum</FONT><FONT COLOR="#000000">,</FONT> xs<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">dualnumlst n</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">dualnumlst n</FONT> <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">let</FONT>
  <FONT COLOR="#000000">fun</FONT> fi <FONT COLOR="#000000">(</FONT>i<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">natLt n</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">:&lt;</FONT><FONT COLOR="#0000FF">clo1</FONT><FONT COLOR="#000000">&gt;</FONT> <FONT COLOR="#0000FF">dualnum</FONT> <FONT COLOR="#000000">=</FONT>
    derivative <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">lam</FONT> xi <FONT COLOR="#000000">=&gt;</FONT> f <FONT COLOR="#000000">(</FONT>list_nth_set <FONT COLOR="#000000">(</FONT>xs<FONT COLOR="#000000">,</FONT> i<FONT COLOR="#000000">,</FONT> xi<FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">,</FONT> list_nth_get <FONT COLOR="#000000">(</FONT>xs<FONT COLOR="#000000">,</FONT> i<FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT>
  <FONT COLOR="#000000">val</FONT> gxs <FONT COLOR="#000000">=</FONT> list_tabulate <FONT COLOR="#000000">(</FONT>fi<FONT COLOR="#000000">,</FONT> list_length xs<FONT COLOR="#000000">)</FONT>
<FONT COLOR="#787878">(*
  val () = begin
    print "gradient: xs = "; print_dualnumlst xs; print_newline ();
    print "gradient: gxs = "; print_dualnumlst gxs; print_newline ();
  end
*)</FONT>
<FONT COLOR="#000000">in</FONT>
  gxs
<FONT COLOR="#000000">end</FONT> <FONT COLOR="#787878">// end of [gradient]
</FONT>
<FONT COLOR="#000000">val</FONT> PRECISION <FONT COLOR="#000000">=</FONT> Base 1e-5

<FONT COLOR="#000000">fn</FONT> multivariate_argmin <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>n<FONT COLOR="#000000">:</FONT>nat<FONT COLOR="#000000">}</FONT></FONT>
  <FONT COLOR="#000000">(</FONT>f<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">dualnumlst n <FONT COLOR="#000000">-&gt;</FONT> dualnum</FONT><FONT COLOR="#000000">,</FONT> xs<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">dualnumlst n</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">dualnumlst n</FONT> <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">let</FONT>
  <FONT COLOR="#000000">fun</FONT> g <FONT COLOR="#000000">(</FONT>xs<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">dualnumlst n</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">:&lt;</FONT><FONT COLOR="#0000FF">clo1</FONT><FONT COLOR="#000000">&gt;</FONT> <FONT COLOR="#0000FF">dualnumlst n</FONT> <FONT COLOR="#000000">=</FONT> gradient <FONT COLOR="#000000">(</FONT>f<FONT COLOR="#000000">,</FONT> xs<FONT COLOR="#000000">)</FONT>
  <FONT COLOR="#000000">fun</FONT> loop
    <FONT COLOR="#000000">(</FONT>xs<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">dualnumlst n</FONT><FONT COLOR="#000000">,</FONT> fxs<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">dualnum</FONT><FONT COLOR="#000000">,</FONT> gxs<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">dualnumlst n</FONT><FONT COLOR="#000000">,</FONT> eta<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">dualnum</FONT><FONT COLOR="#000000">,</FONT>i<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">int</FONT><FONT COLOR="#000000">)</FONT>
    <FONT COLOR="#000000">:&lt;</FONT><FONT COLOR="#0000FF">clo1</FONT><FONT COLOR="#000000">&gt;</FONT> <FONT COLOR="#0000FF">dualnumlst n</FONT> <FONT COLOR="#000000">=</FONT>
    <FONT COLOR="#000000">if</FONT> magnitude gxs &lt;= PRECISION <FONT COLOR="#000000">then</FONT> xs
    <FONT COLOR="#000000">else</FONT> <FONT COLOR="#000000">if</FONT> i <FONT COLOR="#000000">=</FONT> 10 <FONT COLOR="#000000">then</FONT> loop <FONT COLOR="#000000">(</FONT>xs<FONT COLOR="#000000">,</FONT> fxs<FONT COLOR="#000000">,</FONT> gxs<FONT COLOR="#000000">,</FONT> two_dualnum * eta<FONT COLOR="#000000">,</FONT> 0<FONT COLOR="#000000">)</FONT>
    <FONT COLOR="#000000">else</FONT> <FONT COLOR="#000000">let</FONT>
      <FONT COLOR="#000000">val</FONT> xs' <FONT COLOR="#000000">=</FONT> vminus <FONT COLOR="#000000">(</FONT>xs<FONT COLOR="#000000">,</FONT> vscale <FONT COLOR="#000000">(</FONT>eta<FONT COLOR="#000000">,</FONT> gxs<FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT>
    <FONT COLOR="#000000">in</FONT>
      <FONT COLOR="#000000">if</FONT> distance <FONT COLOR="#000000">(</FONT>xs<FONT COLOR="#000000">,</FONT> xs'<FONT COLOR="#000000">)</FONT> &lt;= PRECISION <FONT COLOR="#000000">then</FONT> xs
      <FONT COLOR="#000000">else</FONT> <FONT COLOR="#000000">let</FONT>
        <FONT COLOR="#000000">val</FONT> fxs' <FONT COLOR="#000000">=</FONT> f xs'
      <FONT COLOR="#000000">in</FONT>
        <FONT COLOR="#000000">if</FONT> fxs' <FONT COLOR="#000000">&lt;</FONT> fxs <FONT COLOR="#000000">then</FONT> loop <FONT COLOR="#000000">(</FONT>xs'<FONT COLOR="#000000">,</FONT> fxs'<FONT COLOR="#000000">,</FONT> g xs'<FONT COLOR="#000000">,</FONT> eta<FONT COLOR="#000000">,</FONT> i+1<FONT COLOR="#000000">)</FONT>
        <FONT COLOR="#000000">else</FONT> loop <FONT COLOR="#000000">(</FONT>xs<FONT COLOR="#000000">,</FONT> fxs<FONT COLOR="#000000">,</FONT> gxs<FONT COLOR="#000000">,</FONT> eta / two_dualnum<FONT COLOR="#000000">,</FONT> 0<FONT COLOR="#000000">)</FONT>
      <FONT COLOR="#000000">end</FONT>
    <FONT COLOR="#000000">end</FONT>
<FONT COLOR="#000000">in</FONT>
  loop <FONT COLOR="#000000">(</FONT>xs<FONT COLOR="#000000">,</FONT> f xs<FONT COLOR="#000000">,</FONT> g xs<FONT COLOR="#000000">,</FONT> PRECISION<FONT COLOR="#000000">,</FONT> 0<FONT COLOR="#000000">)</FONT>
<FONT COLOR="#000000">end</FONT>

<FONT COLOR="#000000">fn</FONT> multivariate_argmax <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>n<FONT COLOR="#000000">:</FONT>nat<FONT COLOR="#000000">}</FONT></FONT>
  <FONT COLOR="#000000">(</FONT>f<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">dualnumlst n <FONT COLOR="#000000">-&gt;</FONT> dualnum</FONT><FONT COLOR="#000000">,</FONT> xs<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">dualnumlst n</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">dualnumlst n</FONT> <FONT COLOR="#000000">=</FONT>
  multivariate_argmin <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">lam</FONT> xs <FONT COLOR="#000000">=&gt;</FONT> <FONT COLOR="#000000">~</FONT><FONT COLOR="#000000">(</FONT>f xs<FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">,</FONT> xs<FONT COLOR="#000000">)</FONT>

<FONT COLOR="#000000">fn</FONT> multivariate_max <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>n<FONT COLOR="#000000">:</FONT>nat<FONT COLOR="#000000">}</FONT></FONT>
  <FONT COLOR="#000000">(</FONT>f<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">dualnumlst n <FONT COLOR="#000000">-&gt;</FONT> dualnum</FONT><FONT COLOR="#000000">,</FONT> xs<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">dualnumlst n</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">dualnum</FONT> <FONT COLOR="#000000">=</FONT>
  f <FONT COLOR="#000000">(</FONT>multivariate_argmax <FONT COLOR="#000000">(</FONT>f<FONT COLOR="#000000">,</FONT> xs<FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT>

<FONT COLOR="#787878">(* ****** ****** *)</FONT>

<FONT COLOR="#000000">fn</FONT> saddle <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">void</FONT> <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">let</FONT>

<FONT COLOR="#000000">val</FONT> start<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">dualnumlst2</FONT> <FONT COLOR="#000000">=</FONT>
  list_cons <FONT COLOR="#000000">(</FONT>one_dualnum<FONT COLOR="#000000">,</FONT> list_cons <FONT COLOR="#000000">(</FONT>one_dualnum<FONT COLOR="#000000">,</FONT> list_nil <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT>

<FONT COLOR="#000000">val</FONT> xy1_star<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">dualnumlst2</FONT> <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">let</FONT>
  <FONT COLOR="#000000">fn</FONT> f1 <FONT COLOR="#000000">(</FONT>xy1<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">dualnumlst2</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">:&lt;</FONT><FONT COLOR="#0000FF">clo1</FONT><FONT COLOR="#000000">&gt;</FONT> <FONT COLOR="#0000FF">dualnum</FONT> <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">let</FONT>
    <FONT COLOR="#000000">val+</FONT> list_cons <FONT COLOR="#000000">(</FONT>x1<FONT COLOR="#000000">,</FONT> list_cons <FONT COLOR="#000000">(</FONT>y1<FONT COLOR="#000000">,</FONT> list_nil <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> xy1
    <FONT COLOR="#000000">val</FONT> sum <FONT COLOR="#000000">=</FONT> x1 * x1 + y1 * y1
    <FONT COLOR="#000000">fn</FONT> f2 <FONT COLOR="#000000">(</FONT>xy2<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">dualnumlst2</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">:&lt;</FONT><FONT COLOR="#0000FF">clo1</FONT><FONT COLOR="#000000">&gt;</FONT> <FONT COLOR="#0000FF">dualnum</FONT> <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">let</FONT>
      <FONT COLOR="#000000">val+</FONT> list_cons <FONT COLOR="#000000">(</FONT>x2<FONT COLOR="#000000">,</FONT> list_cons <FONT COLOR="#000000">(</FONT>y2<FONT COLOR="#000000">,</FONT> list_nil <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> xy2
    <FONT COLOR="#000000">in</FONT>
      sum - <FONT COLOR="#000000">(</FONT>x2 * x2 + y2 * y2<FONT COLOR="#000000">)</FONT>
    <FONT COLOR="#000000">end</FONT>
  <FONT COLOR="#000000">in</FONT>
    multivariate_max <FONT COLOR="#000000">(</FONT>f2<FONT COLOR="#000000">,</FONT> start<FONT COLOR="#000000">)</FONT>
  <FONT COLOR="#000000">end</FONT>
<FONT COLOR="#000000">in</FONT>
  multivariate_argmin <FONT COLOR="#000000">(</FONT>f1<FONT COLOR="#000000">,</FONT> start<FONT COLOR="#000000">)</FONT>
<FONT COLOR="#000000">end</FONT>

<FONT COLOR="#000000">val+</FONT> list_cons <FONT COLOR="#000000">(</FONT>x1_star<FONT COLOR="#000000">,</FONT> list_cons <FONT COLOR="#000000">(</FONT>y1_star<FONT COLOR="#000000">,</FONT> list_nil <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> xy1_star

<FONT COLOR="#000000">val</FONT> xy2_star<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">dualnumlst2</FONT> <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">let</FONT>
  <FONT COLOR="#000000">val</FONT> sum <FONT COLOR="#000000">=</FONT> x1_star * x1_star + y1_star * y1_star
  <FONT COLOR="#000000">fn</FONT> f3 <FONT COLOR="#000000">(</FONT>xy2<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">dualnumlst2</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">:&lt;</FONT><FONT COLOR="#0000FF">clo1</FONT><FONT COLOR="#000000">&gt;</FONT> <FONT COLOR="#0000FF">dualnum</FONT> <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">let</FONT>
    <FONT COLOR="#000000">val+</FONT> list_cons <FONT COLOR="#000000">(</FONT>x2<FONT COLOR="#000000">,</FONT> list_cons <FONT COLOR="#000000">(</FONT>y2<FONT COLOR="#000000">,</FONT> list_nil <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> xy2
  <FONT COLOR="#000000">in</FONT>
    sum - <FONT COLOR="#000000">(</FONT>x2 * x2 + y2 * y2<FONT COLOR="#000000">)</FONT>
  <FONT COLOR="#000000">end</FONT>
<FONT COLOR="#000000">in</FONT>
  multivariate_argmax <FONT COLOR="#000000">(</FONT>f3<FONT COLOR="#000000">,</FONT> start<FONT COLOR="#000000">)</FONT>
<FONT COLOR="#000000">end</FONT>

<FONT COLOR="#000000">val+</FONT> list_cons <FONT COLOR="#000000">(</FONT>x2_star<FONT COLOR="#000000">,</FONT> list_cons <FONT COLOR="#000000">(</FONT>y2_star<FONT COLOR="#000000">,</FONT> list_nil <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> xy2_star

<FONT COLOR="#000000">in</FONT> <FONT COLOR="#787878">// in of [let]
</FONT>
print_dualnum x1_star<FONT COLOR="#000000">;</FONT> print_newline <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">;</FONT>
print_dualnum y1_star<FONT COLOR="#000000">;</FONT> print_newline <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">;</FONT>
print_dualnum x2_star<FONT COLOR="#000000">;</FONT> print_newline <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">;</FONT>
print_dualnum y2_star<FONT COLOR="#000000">;</FONT> print_newline <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">;</FONT>

<FONT COLOR="#000000">end</FONT> <FONT COLOR="#787878">// end of [saddle]
</FONT>
<FONT COLOR="#787878">(* ****** ****** *)</FONT>

<FONT COLOR="#000000">fn</FONT> particle <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">let</FONT>

<FONT COLOR="#000000">fn</FONT> naive_euler <FONT COLOR="#000000">(</FONT>w<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">dualnum</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">dualnum</FONT> <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">let</FONT>
  <FONT COLOR="#000000">val</FONT> ten_dualnum <FONT COLOR="#000000">=</FONT> Base 10.0
  <FONT COLOR="#000000">val</FONT> delta_t <FONT COLOR="#000000">=</FONT> Base 1e-1
  <FONT COLOR="#000000">val</FONT> charge1 <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">'[</FONT>ten_dualnum<FONT COLOR="#000000">,</FONT> ten_dualnum - w<FONT COLOR="#000000">]</FONT>
  <FONT COLOR="#000000">val</FONT> charge2 <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">'[</FONT>ten_dualnum<FONT COLOR="#000000">,</FONT> zero_dualnum<FONT COLOR="#000000">]</FONT>
  <FONT COLOR="#000000">val</FONT> charges<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">list <FONT COLOR="#000000">(</FONT>dualnumlst2<FONT COLOR="#000000">,</FONT> 2<FONT COLOR="#000000">)</FONT></FONT> <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">'[</FONT>charge1<FONT COLOR="#000000">,</FONT> charge2<FONT COLOR="#000000">]</FONT>
  <FONT COLOR="#000000">fn</FONT> p <FONT COLOR="#000000">(</FONT>xs<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">dualnumlst2</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">:&lt;</FONT><FONT COLOR="#0000FF">clo1</FONT><FONT COLOR="#000000">&gt;</FONT> <FONT COLOR="#0000FF">dualnum</FONT> <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">let</FONT>
    <FONT COLOR="#000000">fun</FONT> aux <FONT COLOR="#000000">(</FONT>charges<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">List dualnumlst2</FONT><FONT COLOR="#000000">,</FONT> res<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">dualnum</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">:&lt;</FONT><FONT COLOR="#0000FF">clo1</FONT><FONT COLOR="#000000">&gt;</FONT> <FONT COLOR="#0000FF">dualnum</FONT> <FONT COLOR="#000000">=</FONT>
      <FONT COLOR="#000000">case+</FONT> charges <FONT COLOR="#000000">of</FONT>
      <FONT COLOR="#000000">|</FONT> list_cons <FONT COLOR="#000000">(</FONT>charge<FONT COLOR="#000000">,</FONT> charges<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=&gt;</FONT>
          aux <FONT COLOR="#000000">(</FONT>charges<FONT COLOR="#000000">,</FONT> res + recip_dualnum <FONT COLOR="#000000">(</FONT>distance <FONT COLOR="#000000">(</FONT>xs<FONT COLOR="#000000">,</FONT> charge<FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT>
      <FONT COLOR="#000000">|</FONT> list_nil <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=&gt;</FONT> res
  <FONT COLOR="#000000">in</FONT>
    aux <FONT COLOR="#000000">(</FONT>charges<FONT COLOR="#000000">,</FONT> zero_dualnum<FONT COLOR="#000000">)</FONT>
  <FONT COLOR="#000000">end</FONT>
  <FONT COLOR="#000000">fun</FONT> loop
    <FONT COLOR="#000000">(</FONT>xs<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">dualnumlst2</FONT><FONT COLOR="#000000">,</FONT> xs_dot<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">dualnumlst2</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">:&lt;</FONT><FONT COLOR="#0000FF">clo1</FONT><FONT COLOR="#000000">&gt;</FONT> <FONT COLOR="#0000FF">dualnum</FONT> <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">let</FONT>
    <FONT COLOR="#000000">val</FONT> xs_ddot <FONT COLOR="#000000">=</FONT> vscale <FONT COLOR="#000000">(</FONT>negone_dualnum<FONT COLOR="#000000">,</FONT> gradient <FONT COLOR="#000000">(</FONT>p<FONT COLOR="#000000">,</FONT> xs<FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT>
    <FONT COLOR="#000000">val</FONT> xs_new <FONT COLOR="#000000">=</FONT> vplus <FONT COLOR="#000000">(</FONT>xs<FONT COLOR="#000000">,</FONT> vscale <FONT COLOR="#000000">(</FONT>delta_t<FONT COLOR="#000000">,</FONT> xs_dot<FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT>
  <FONT COLOR="#000000">in</FONT>
    <FONT COLOR="#000000">if</FONT> zero_dualnum <FONT COLOR="#000000">&lt;</FONT> list_nth_get <FONT COLOR="#000000">(</FONT>xs_new<FONT COLOR="#000000">,</FONT> 1<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">then</FONT>
      loop <FONT COLOR="#000000">(</FONT>xs_new<FONT COLOR="#000000">,</FONT> vplus <FONT COLOR="#000000">(</FONT>xs_dot<FONT COLOR="#000000">,</FONT> vscale <FONT COLOR="#000000">(</FONT>delta_t<FONT COLOR="#000000">,</FONT> xs_ddot<FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT>
    <FONT COLOR="#000000">else</FONT> <FONT COLOR="#000000">let</FONT>
      <FONT COLOR="#000000">val</FONT> delta_t_f <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">~</FONT><FONT COLOR="#000000">(</FONT>list_nth_get <FONT COLOR="#000000">(</FONT>xs<FONT COLOR="#000000">,</FONT> 1<FONT COLOR="#000000">)</FONT> / list_nth_get <FONT COLOR="#000000">(</FONT>xs_dot<FONT COLOR="#000000">,</FONT> 1<FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT>
      <FONT COLOR="#000000">val</FONT> xs_t_f <FONT COLOR="#000000">=</FONT> vplus <FONT COLOR="#000000">(</FONT>xs<FONT COLOR="#000000">,</FONT> vscale <FONT COLOR="#000000">(</FONT>delta_t_f<FONT COLOR="#000000">,</FONT> xs_dot<FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT>
    <FONT COLOR="#000000">in</FONT>
      square <FONT COLOR="#000000">(</FONT>list_nth_get <FONT COLOR="#000000">(</FONT>xs_t_f<FONT COLOR="#000000">,</FONT> 0<FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT>
    <FONT COLOR="#000000">end</FONT>
  <FONT COLOR="#000000">end</FONT>
  <FONT COLOR="#000000">val</FONT> xs_initial<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">dualnumlst2</FONT> <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">'[</FONT>zero_dualnum<FONT COLOR="#000000">,</FONT> Base 8.0<FONT COLOR="#000000">]</FONT>
  <FONT COLOR="#000000">val</FONT> xs_dot_initial<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">dualnumlst2</FONT> <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">'[</FONT>Base 0.75<FONT COLOR="#000000">,</FONT> zero_dualnum<FONT COLOR="#000000">]</FONT>
<FONT COLOR="#000000">in</FONT>
  loop <FONT COLOR="#000000">(</FONT>xs_initial<FONT COLOR="#000000">,</FONT> xs_dot_initial<FONT COLOR="#000000">)</FONT>
<FONT COLOR="#000000">end</FONT>

<FONT COLOR="#000000">val</FONT> w0 <FONT COLOR="#000000">=</FONT> zero_dualnum
<FONT COLOR="#000000">val</FONT> ws_star<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">dualnumlst1</FONT> <FONT COLOR="#000000">=</FONT> multivariate_argmin <FONT COLOR="#000000">(</FONT>f<FONT COLOR="#000000">,</FONT> <FONT COLOR="#000000">'[</FONT>w0<FONT COLOR="#000000">]</FONT><FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">where</FONT> <FONT COLOR="#000000">{</FONT>
  <FONT COLOR="#000000">fn</FONT> f <FONT COLOR="#000000">(</FONT>ws<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">dualnumlst1</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">:&lt;</FONT><FONT COLOR="#0000FF">clo1</FONT><FONT COLOR="#000000">&gt;</FONT> <FONT COLOR="#0000FF">dualnum</FONT> <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">let</FONT>
    <FONT COLOR="#000000">val+</FONT> list_cons <FONT COLOR="#000000">(</FONT>w<FONT COLOR="#000000">,</FONT> list_nil <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> ws
  <FONT COLOR="#000000">in</FONT>
    naive_euler w
  <FONT COLOR="#000000">end</FONT>
<FONT COLOR="#000000">}</FONT> <FONT COLOR="#787878">// end of [where]
</FONT>
<FONT COLOR="#000000">val</FONT> list_cons <FONT COLOR="#000000">(</FONT>w_star<FONT COLOR="#000000">,</FONT> list_nil <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> ws_star

<FONT COLOR="#000000">in</FONT> <FONT COLOR="#787878">// in of [let]
</FONT>
print_dualnum w_star<FONT COLOR="#000000">;</FONT> print_newline <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT>

<FONT COLOR="#000000">end</FONT> <FONT COLOR="#787878">// end of [particle]
</FONT>
<FONT COLOR="#787878">(* ****** ****** *)</FONT>

<FONT COLOR="#000000">implement</FONT> main <FONT COLOR="#000000">(</FONT>argc<FONT COLOR="#000000">,</FONT> argv<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">begin</FONT>
  saddle <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">;</FONT> <FONT COLOR="#787878">// test
</FONT>  particle <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">;</FONT> <FONT COLOR="#787878">// test
</FONT><FONT COLOR="#000000">end</FONT>

<FONT COLOR="#787878">(* ****** ****** *)</FONT>

<FONT COLOR="#787878">(* end of [AutoDiff.dats] *)</FONT>
</PRE></BODY>

<BODY BGCOLOR="#E0E0E0" TEXT="#E80000"><PRE><FONT COLOR="#787878">//
</FONT><FONT COLOR="#787878">//
</FONT><FONT COLOR="#787878">// An implementation of the Black-Scholes formula. The ATS code is
</FONT><FONT COLOR="#787878">// largely _translated_ from the C++ version by Espen Gaarder Haug
</FONT><FONT COLOR="#787878">// attached at the end of this file.
</FONT><FONT COLOR="#787878">//
</FONT><FONT COLOR="#787878">// Hongwei Xi (November 17 2007)
</FONT><FONT COLOR="#787878">//
</FONT><FONT COLOR="#787878">//
</FONT>
<FONT COLOR="#A52A2A">%{^

#include "libc/CATS/math.cats"

%}</FONT>

<FONT COLOR="#000000">staload</FONT> <FONT COLOR="#0000FF">"libc/SATS/math.sats"</FONT>

<FONT COLOR="#787878">(* ****** ****** *)</FONT>

<FONT COLOR="#000000">#define</FONT> <FONT COLOR="#800080">Pi 3.1415926535897932384626</FONT>

<FONT COLOR="#787878">// The cumulative normal distribution function 
</FONT><FONT COLOR="#000000">fn</FONT> CND <FONT COLOR="#000000">(</FONT>X<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">double</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">double</FONT> <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">let</FONT>

<FONT COLOR="#000000">val</FONT> a1 <FONT COLOR="#000000">=</FONT> 0.31938153
<FONT COLOR="#000000">val</FONT> a2 <FONT COLOR="#000000">=</FONT> ~0.356563782
<FONT COLOR="#000000">val</FONT> a3 <FONT COLOR="#000000">=</FONT> 1.781477937
<FONT COLOR="#000000">val</FONT> a4 <FONT COLOR="#000000">=</FONT> ~1.821255978
<FONT COLOR="#000000">val</FONT> a5 <FONT COLOR="#000000">=</FONT> 1.330274429
<FONT COLOR="#000000">val</FONT> L <FONT COLOR="#000000">=</FONT> abs<FONT COLOR="#000000">(</FONT>X<FONT COLOR="#000000">)</FONT>
<FONT COLOR="#000000">val</FONT> K <FONT COLOR="#000000">=</FONT> 1.0 / <FONT COLOR="#000000">(</FONT>1.0 + 0.2316419 * L<FONT COLOR="#000000">)</FONT>
<FONT COLOR="#000000">var</FONT> w<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">double</FONT> <FONT COLOR="#000000">=</FONT> a5
<FONT COLOR="#000000">val</FONT> <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> w := <FONT COLOR="#000000">(</FONT>w + a4<FONT COLOR="#000000">)</FONT> * K
<FONT COLOR="#000000">val</FONT> <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> w := <FONT COLOR="#000000">(</FONT>w + a3<FONT COLOR="#000000">)</FONT> * K
<FONT COLOR="#000000">val</FONT> <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> w := <FONT COLOR="#000000">(</FONT>w + a2<FONT COLOR="#000000">)</FONT> * K
<FONT COLOR="#000000">val</FONT> <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> w := <FONT COLOR="#000000">(</FONT>w + a1<FONT COLOR="#000000">)</FONT> * K
<FONT COLOR="#000000">val</FONT> <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> w := 1.0 - 1.0 / sqrt <FONT COLOR="#000000">(</FONT>Pi + Pi<FONT COLOR="#000000">)</FONT> * exp <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">~</FONT><FONT COLOR="#000000">(</FONT>L * L / 2.0<FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT> * w

<FONT COLOR="#000000">in</FONT>

<FONT COLOR="#000000">if</FONT> X <FONT COLOR="#000000">&lt;</FONT> 0.0 <FONT COLOR="#000000">then</FONT> 1.0 - w <FONT COLOR="#000000">else</FONT> w

<FONT COLOR="#000000">end</FONT>

<FONT COLOR="#000000">fn</FONT> BlackScholes
  <FONT COLOR="#000000">(</FONT>CallPutFlag<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">char</FONT><FONT COLOR="#000000">,</FONT> S<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">double</FONT><FONT COLOR="#000000">,</FONT> X<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">double</FONT><FONT COLOR="#000000">,</FONT> T<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">double</FONT><FONT COLOR="#000000">,</FONT> r<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">double</FONT><FONT COLOR="#000000">,</FONT> v<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">double</FONT><FONT COLOR="#000000">)</FONT>
  <FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">double</FONT> <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">let</FONT>

<FONT COLOR="#000000">val</FONT> sqrt_T <FONT COLOR="#000000">=</FONT> sqrt T
<FONT COLOR="#000000">val</FONT> d1<FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">(</FONT>log <FONT COLOR="#000000">(</FONT>S/X<FONT COLOR="#000000">)</FONT> + <FONT COLOR="#000000">(</FONT>r+v*v/2.0<FONT COLOR="#000000">)</FONT> * T<FONT COLOR="#000000">)</FONT> / <FONT COLOR="#000000">(</FONT>v * sqrt_T<FONT COLOR="#000000">)</FONT>
<FONT COLOR="#000000">val</FONT> d2 <FONT COLOR="#000000">=</FONT> d1 - v * sqrt_T

<FONT COLOR="#000000">in</FONT>

<FONT COLOR="#000000">case+</FONT> CallPutFlag <FONT COLOR="#000000">of</FONT>
  <FONT COLOR="#000000">|</FONT> 'c' <FONT COLOR="#000000">=&gt;</FONT> S * CND<FONT COLOR="#000000">(</FONT>d1<FONT COLOR="#000000">)</FONT> - X * exp<FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">~</FONT>r*T<FONT COLOR="#000000">)</FONT> * CND<FONT COLOR="#000000">(</FONT>d2<FONT COLOR="#000000">)</FONT>
  <FONT COLOR="#000000">|</FONT> 'p' <FONT COLOR="#000000">=&gt;</FONT> X * exp<FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">~</FONT>r * T<FONT COLOR="#000000">)</FONT> * CND<FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">~</FONT>d2<FONT COLOR="#000000">)</FONT> - S * CND <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">~</FONT>d1<FONT COLOR="#000000">)</FONT>
  <FONT COLOR="#000000">|</FONT> _ <FONT COLOR="#000000">=&gt;</FONT> <FONT COLOR="#000000">begin</FONT>
      prerr "The value of [CallPutFlag] is illegal: "<FONT COLOR="#000000">;</FONT>
      prerr CallPutFlag<FONT COLOR="#000000">;</FONT>
      prerr_newline <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">;</FONT>
      exit <FONT COLOR="#000000">(</FONT>1<FONT COLOR="#000000">)</FONT>
   <FONT COLOR="#000000">end</FONT>

<FONT COLOR="#000000">end</FONT> <FONT COLOR="#787878">// end of [BlackScholes]
</FONT>
<FONT COLOR="#787878">////

Black-Scholes in C++

By Espen Gaarder Haug

C++: a bit harder than most other languages but very fast and powerful. After my opinion the Rolls Royce computer language for mathematical models where you need speed (for closed form solutions like Blacks-Scholes you are naturally doing fine in almost any language, but when it comes to large scale Monte Carlo C++ is really a plus).

#ifndef Pi 
#define Pi 3.141592653589793238462643 
#endif 


// The Black and Scholes (1973) Stock option formula
double BlackScholes(char CallPutFlag, double S, double X, double T, double r, double v)
{
double d1, d2;


d1=(log(S/X)+(r+v*v/2)*T)/(v*sqrt(T));
d2=d1-v*sqrt(T);

if(CallPutFlag == 'c')
return S *CND(d1)-X * exp(-r*T)*CND(d2);
else if(CallPutFlag == 'p')
return X * exp(-r * T) * CND(-d2) - S * CND(-d1);
}


// The cumulative normal distribution function 
double CND( double X )
{

double L, K, w ;

double const a1 = 0.31938153, a2 = -0.356563782, a3 = 1.781477937;
double const a4 = -1.821255978, a5 = 1.330274429;

L = fabs(X);
K = 1.0 / (1.0 + 0.2316419 * L);
w = 1.0 - 1.0 / sqrt(2 * Pi) * exp(-L *L / 2) * (a1 * K + a2 * K *K + a3 * pow(K,3) + a4 * pow(K,4) + a5 * pow(K,5));

if (X &lt; 0 ){
w= 1.0 - w;
}
return w;
} 

(* ****** ****** *)

(* end of [BlackScholes.dats] *)
</FONT></PRE></BODY>

<BODY BGCOLOR="#E0E0E0" TEXT="#E80000"><PRE><FONT COLOR="#787878">(*
 *
 * An implementation of KMP string search algorithm in ATS
 * 
 *)</FONT>

<FONT COLOR="#787878">// March 2007:
</FONT><FONT COLOR="#787878">// Author: Hongwei Xi (* hwxi AT CS DOT BU DOT EDU *)
</FONT>
<FONT COLOR="#787878">// In this implementation, both memory safety and termination
</FONT><FONT COLOR="#787878">// of the algorithm are guaranteed with no use of run-time
</FONT><FONT COLOR="#787878">// checks. Compared to a previous implementation in DML (1998),
</FONT><FONT COLOR="#787878">// which requires run-time checks to ensure safe array access,
</FONT><FONT COLOR="#787878">// the progress made during these years in support of dependent
</FONT><FONT COLOR="#787878">// types for practical programming should be evident.
</FONT>
<FONT COLOR="#000000">stadef</FONT> <FONT COLOR="#0000FF">intsz<FONT COLOR="#000000">:</FONT> int <FONT COLOR="#000000">=</FONT> sizeof <FONT COLOR="#000000">(</FONT>Int<FONT COLOR="#000000">)</FONT></FONT>

<FONT COLOR="#787878">// extern val intsz: int intsz = "ats_intsz"
</FONT><FONT COLOR="#000000">val</FONT> intsz <FONT COLOR="#000000">=</FONT> sizeof&lt;<FONT COLOR="#0000FF">Int</FONT><FONT COLOR="#000000">&gt;</FONT>

<FONT COLOR="#000000">extern</FONT> <FONT COLOR="#000000">fun</FONT> ptr_get_t
  <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>i<FONT COLOR="#000000">:</FONT>int<FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>l<FONT COLOR="#000000">:</FONT>addr<FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#000000">(</FONT><FONT COLOR="#009000">pf<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">!</FONT>int i @ l</FONT></FONT> <FONT COLOR="#000000">|</FONT> p<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">ptr l</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">:&lt;&gt;</FONT> <FONT COLOR="#0000FF">int i</FONT>
  <FONT COLOR="#000000">=</FONT> "ats_ptr_get_t"

<FONT COLOR="#000000">extern</FONT> <FONT COLOR="#000000">fun</FONT> ptr_set_t <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>i<FONT COLOR="#000000">:</FONT>int<FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>l<FONT COLOR="#000000">:</FONT>addr<FONT COLOR="#000000">}</FONT></FONT> 
  <FONT COLOR="#000000">(</FONT><FONT COLOR="#009000">pf<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">!</FONT><FONT COLOR="#000000">(</FONT>int i<FONT COLOR="#000000">)</FONT>? @ l &gt;&gt; int i @ l</FONT></FONT> <FONT COLOR="#000000">|</FONT> p<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">ptr l</FONT><FONT COLOR="#000000">,</FONT> i<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">int i</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">:&lt;&gt;</FONT> <FONT COLOR="#0000FF">void</FONT>
  <FONT COLOR="#000000">=</FONT> "ats_ptr_set_t"
  
<FONT COLOR="#000000">extern</FONT> <FONT COLOR="#000000">fun</FONT> array_int_ptr_make <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>n<FONT COLOR="#000000">:</FONT>nat<FONT COLOR="#000000">}</FONT></FONT>
  <FONT COLOR="#000000">(</FONT>n<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">int n</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">:&lt;&gt;</FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">[</FONT>l<FONT COLOR="#000000">:</FONT>addr<FONT COLOR="#000000">]</FONT> <FONT COLOR="#000000">(</FONT>free_ngc_v l<FONT COLOR="#000000">,</FONT> array_v <FONT COLOR="#000000">(</FONT>Int?<FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">,</FONT> l<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">|</FONT> ptr l<FONT COLOR="#000000">)</FONT></FONT> 
  <FONT COLOR="#000000">=</FONT> "ats_array_int_ptr_make"

<FONT COLOR="#000000">extern</FONT> <FONT COLOR="#000000">fun</FONT> array_int_ptr_free <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>n<FONT COLOR="#000000">:</FONT>nat<FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>l<FONT COLOR="#000000">:</FONT>addr<FONT COLOR="#000000">}</FONT></FONT>
  <FONT COLOR="#000000">(</FONT><FONT COLOR="#009000">_<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">free_ngc_v l</FONT></FONT><FONT COLOR="#000000">,</FONT> <FONT COLOR="#009000">_<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">array_v <FONT COLOR="#000000">(</FONT>Int?<FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">,</FONT> l<FONT COLOR="#000000">)</FONT></FONT></FONT> <FONT COLOR="#000000">|</FONT> p<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">ptr l</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">:&lt;&gt;</FONT> <FONT COLOR="#0000FF">void</FONT>
  <FONT COLOR="#000000">=</FONT> "ats_array_int_ptr_free"

<FONT COLOR="#A52A2A">%{^

ats_int_type ats_intsz = sizeof(ats_int_type) ;

static inline
ats_int_type ats_ptr_get_t(ats_ptr_type arg) { 
  return *((ats_int_type *)arg) ; 
}

static inline
ats_void_type ats_ptr_set_t(ats_ptr_type arg1, ats_int_type arg2) {
  *((ats_int_type *)arg1) = arg2;
}

static inline
ats_ptr_type ats_array_int_ptr_make(ats_int_type n) {
  return ats_calloc_ngc(n, sizeof(int)) ;
}

static inline
ats_void_type ats_array_int_ptr_free (ats_ptr_type A) {
  ats_free_ngc(A) ;
}

%}</FONT>

<FONT COLOR="#787878">//
</FONT>
<FONT COLOR="#000000">dataview</FONT> <FONT COLOR="#009000"><FONT COLOR="#0000FF">kmp_v <FONT COLOR="#000000">(</FONT>l<FONT COLOR="#000000">:</FONT>addr<FONT COLOR="#000000">,</FONT> int<FONT COLOR="#000000">)</FONT></FONT> <FONT COLOR="#000000">=</FONT>
  <FONT COLOR="#000000">|</FONT> kmp_v_none <FONT COLOR="#0000FF"><FONT COLOR="#000000">(</FONT>l<FONT COLOR="#000000">,</FONT> 0<FONT COLOR="#000000">)</FONT></FONT>
  <FONT COLOR="#000000">|</FONT> <FONT COLOR="#000000">{</FONT><FONT COLOR="#0000FF">n<FONT COLOR="#000000">:</FONT>nat</FONT><FONT COLOR="#000000">}</FONT> <FONT COLOR="#000000">{</FONT><FONT COLOR="#0000FF">ofs<FONT COLOR="#000000">:</FONT>int</FONT><FONT COLOR="#000000">}</FONT> kmp_v_more <FONT COLOR="#0000FF"><FONT COLOR="#000000">(</FONT>l<FONT COLOR="#000000">,</FONT> n+1<FONT COLOR="#000000">)</FONT></FONT> <FONT COLOR="#000000">of</FONT>
      <FONT COLOR="#0000FF"><FONT COLOR="#000000">(</FONT>MUL <FONT COLOR="#000000">(</FONT>n+1<FONT COLOR="#000000">,</FONT> intsz<FONT COLOR="#000000">,</FONT> ofs<FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">,</FONT> kmp_v <FONT COLOR="#000000">(</FONT>l<FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">,</FONT> natLte n @ <FONT COLOR="#000000">(</FONT>l + ofs<FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT></FONT></FONT>

<FONT COLOR="#787878">//
</FONT>
<FONT COLOR="#000000">prfun</FONT> <FONT COLOR="#009000">kmp_v_takeout
   <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>n<FONT COLOR="#000000">,</FONT>i<FONT COLOR="#000000">:</FONT>int <FONT COLOR="#000000">|</FONT> 0 <FONT COLOR="#000000">&lt;</FONT> i<FONT COLOR="#000000">;</FONT> i &lt;= n<FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>l<FONT COLOR="#000000">:</FONT>addr<FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>ofs<FONT COLOR="#000000">:</FONT>int<FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">.&lt;</FONT>n<FONT COLOR="#000000">&gt;.</FONT></FONT>
   <FONT COLOR="#000000">(</FONT>pf0_mul<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">MUL <FONT COLOR="#000000">(</FONT>i<FONT COLOR="#000000">,</FONT> intsz<FONT COLOR="#000000">,</FONT> ofs<FONT COLOR="#000000">)</FONT></FONT><FONT COLOR="#000000">,</FONT> pf0_kmp<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">kmp_v <FONT COLOR="#000000">(</FONT>l<FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">)</FONT></FONT><FONT COLOR="#000000">)</FONT>
  <FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">[</FONT>i1<FONT COLOR="#000000">:</FONT>nat <FONT COLOR="#000000">|</FONT> i1 <FONT COLOR="#000000">&lt;</FONT> i<FONT COLOR="#000000">]</FONT> <FONT COLOR="#000000">(</FONT>
    int i1 @ l + ofs<FONT COLOR="#000000">,</FONT> int i1 @ l + ofs <FONT COLOR="#000000">-&lt;</FONT>lin<FONT COLOR="#000000">&gt;</FONT> kmp_v <FONT COLOR="#000000">(</FONT>l<FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">)</FONT>
  <FONT COLOR="#000000">)</FONT></FONT> <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">let</FONT>
  <FONT COLOR="#000000">prval</FONT> <FONT COLOR="#009000">kmp_v_more <FONT COLOR="#000000">(</FONT>pf_mul<FONT COLOR="#000000">,</FONT> pf_kmp<FONT COLOR="#000000">,</FONT> pf_elt<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> pf0_kmp</FONT>
<FONT COLOR="#000000">in</FONT>
  <FONT COLOR="#009000"><FONT COLOR="#000000">sif</FONT> <FONT COLOR="#0000FF">i == n</FONT> <FONT COLOR="#000000">then</FONT> <FONT COLOR="#000000">let</FONT>
    <FONT COLOR="#000000">val</FONT> <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> mul_is_fun <FONT COLOR="#000000">(</FONT>pf0_mul<FONT COLOR="#000000">,</FONT> pf_mul<FONT COLOR="#000000">)</FONT>
  <FONT COLOR="#000000">in</FONT>
    <FONT COLOR="#0000FF"><FONT COLOR="#000000">#[</FONT><FONT COLOR="#000000">..</FONT> <FONT COLOR="#000000">|</FONT></FONT> <FONT COLOR="#000000">(</FONT>pf_elt<FONT COLOR="#000000">,</FONT> <FONT COLOR="#000000">llam</FONT> pf_elt <FONT COLOR="#000000">=&gt;</FONT> kmp_v_more <FONT COLOR="#000000">(</FONT>pf_mul<FONT COLOR="#000000">,</FONT> pf_kmp<FONT COLOR="#000000">,</FONT> pf_elt<FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">]</FONT>
  <FONT COLOR="#000000">end</FONT> <FONT COLOR="#000000">else</FONT> <FONT COLOR="#000000">let</FONT>
    <FONT COLOR="#000000">prval</FONT> <FONT COLOR="#009000"><FONT COLOR="#000000">(</FONT>pf1_elt<FONT COLOR="#000000">,</FONT> pf1_rest<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> kmp_v_takeout <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>n-1<FONT COLOR="#000000">,</FONT>i<FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#000000">(</FONT>pf0_mul<FONT COLOR="#000000">,</FONT> pf_kmp<FONT COLOR="#000000">)</FONT></FONT>
  <FONT COLOR="#000000">in</FONT>
    <FONT COLOR="#0000FF"><FONT COLOR="#000000">#[</FONT><FONT COLOR="#000000">..</FONT> <FONT COLOR="#000000">|</FONT></FONT> <FONT COLOR="#000000">(</FONT>pf1_elt<FONT COLOR="#000000">,</FONT> <FONT COLOR="#000000">llam</FONT> pf1_elt <FONT COLOR="#000000">=&gt;</FONT> kmp_v_more <FONT COLOR="#000000">(</FONT>pf_mul<FONT COLOR="#000000">,</FONT> pf1_rest pf1_elt<FONT COLOR="#000000">,</FONT> pf_elt<FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">]</FONT>
  <FONT COLOR="#000000">end</FONT></FONT> <FONT COLOR="#787878">// end of [sif]
</FONT><FONT COLOR="#000000">end</FONT></FONT> <FONT COLOR="#787878">// end of [kmp_v_takeout]
</FONT>
<FONT COLOR="#787878">//
</FONT>
<FONT COLOR="#000000">fn</FONT> kmp_sub <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>n<FONT COLOR="#000000">,</FONT>i<FONT COLOR="#000000">:</FONT>int <FONT COLOR="#000000">|</FONT> 0 <FONT COLOR="#000000">&lt;</FONT> i<FONT COLOR="#000000">;</FONT> i &lt;= n<FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>l<FONT COLOR="#000000">:</FONT>addr<FONT COLOR="#000000">}</FONT></FONT>
   <FONT COLOR="#000000">(</FONT><FONT COLOR="#009000">pf_kmp<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">!</FONT>kmp_v <FONT COLOR="#000000">(</FONT>l<FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">)</FONT></FONT></FONT> <FONT COLOR="#000000">|</FONT> tbl<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">ptr l</FONT><FONT COLOR="#000000">,</FONT> i<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">int i</FONT><FONT COLOR="#000000">)</FONT>
  <FONT COLOR="#000000">:&lt;&gt;</FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">[</FONT>i1<FONT COLOR="#000000">:</FONT>nat <FONT COLOR="#000000">|</FONT> i1 <FONT COLOR="#000000">&lt;</FONT> i<FONT COLOR="#000000">]</FONT> int <FONT COLOR="#000000">(</FONT>i1<FONT COLOR="#000000">)</FONT></FONT> <FONT COLOR="#000000">=</FONT>
  <FONT COLOR="#000000">let</FONT>
     <FONT COLOR="#000000">val</FONT> <FONT COLOR="#000000">(</FONT><FONT COLOR="#009000">pf_mul</FONT> <FONT COLOR="#000000">|</FONT> ofs<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> i imul2 intsz
     <FONT COLOR="#000000">prval</FONT> <FONT COLOR="#009000"><FONT COLOR="#000000">(</FONT>pf_elt<FONT COLOR="#000000">,</FONT> pf_rest<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> kmp_v_takeout <FONT COLOR="#000000">(</FONT>pf_mul<FONT COLOR="#000000">,</FONT> pf_kmp<FONT COLOR="#000000">)</FONT></FONT>
     <FONT COLOR="#000000">val</FONT> i1 <FONT COLOR="#000000">=</FONT> ptr_get_t <FONT COLOR="#000000">(</FONT><FONT COLOR="#009000">pf_elt</FONT> <FONT COLOR="#000000">|</FONT> tbl + ofs<FONT COLOR="#000000">)</FONT>
  <FONT COLOR="#000000">in</FONT>
     pf_kmp := pf_rest pf_elt<FONT COLOR="#000000">;</FONT> i1
  <FONT COLOR="#000000">end</FONT>

<FONT COLOR="#787878">//
</FONT>
<FONT COLOR="#000000">fun</FONT> kmp_table_make_aux
   <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>i<FONT COLOR="#000000">,</FONT>j<FONT COLOR="#000000">,</FONT>n<FONT COLOR="#000000">:</FONT>int <FONT COLOR="#000000">|</FONT> 0 &lt;= j<FONT COLOR="#000000">;</FONT> j+1 <FONT COLOR="#000000">&lt;</FONT> i<FONT COLOR="#000000">;</FONT> i &lt;= n<FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>l<FONT COLOR="#000000">:</FONT>addr<FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>ofs<FONT COLOR="#000000">:</FONT>int<FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">.&lt;</FONT>n-i<FONT COLOR="#000000">,</FONT>j<FONT COLOR="#000000">&gt;.</FONT></FONT>
   <FONT COLOR="#000000">(</FONT><FONT COLOR="#009000">pf_mul<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">MUL <FONT COLOR="#000000">(</FONT>i<FONT COLOR="#000000">,</FONT> intsz<FONT COLOR="#000000">,</FONT> ofs<FONT COLOR="#000000">)</FONT></FONT></FONT><FONT COLOR="#000000">,</FONT>
    <FONT COLOR="#009000">pf_kmp<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">kmp_v <FONT COLOR="#000000">(</FONT>l<FONT COLOR="#000000">,</FONT> i-1<FONT COLOR="#000000">)</FONT></FONT></FONT><FONT COLOR="#000000">,</FONT>
    <FONT COLOR="#009000">pf_arr<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">array_v <FONT COLOR="#000000">(</FONT>Int?<FONT COLOR="#000000">,</FONT> n-i<FONT COLOR="#000000">,</FONT> l+ofs<FONT COLOR="#000000">)</FONT></FONT></FONT> <FONT COLOR="#000000">|</FONT>
    w<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">string n</FONT><FONT COLOR="#000000">,</FONT> tbl<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">ptr l</FONT><FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">:</FONT><FONT COLOR="#0000FF">int n</FONT><FONT COLOR="#000000">,</FONT> i<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">int i</FONT><FONT COLOR="#000000">,</FONT> j<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">int j</FONT><FONT COLOR="#000000">,</FONT> tbl_ofs<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">ptr<FONT COLOR="#000000">(</FONT>l+ofs<FONT COLOR="#000000">)</FONT></FONT><FONT COLOR="#000000">)</FONT>
  <FONT COLOR="#000000">:&lt;&gt;</FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">(</FONT>kmp_v <FONT COLOR="#000000">(</FONT>l<FONT COLOR="#000000">,</FONT> n-1<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">|</FONT> void<FONT COLOR="#000000">)</FONT></FONT> <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">begin</FONT>
  <FONT COLOR="#000000">if</FONT> i <FONT COLOR="#000000">&lt;</FONT> n <FONT COLOR="#000000">then</FONT>
    <FONT COLOR="#000000">if</FONT> w[<FONT COLOR="#009000">i-1</FONT><FONT COLOR="#000000">]</FONT> <FONT COLOR="#000000">=</FONT> w[<FONT COLOR="#009000">j</FONT><FONT COLOR="#000000">]</FONT> <FONT COLOR="#000000">then</FONT>
      <FONT COLOR="#000000">let</FONT>
         <FONT COLOR="#000000">prval</FONT> <FONT COLOR="#009000"><FONT COLOR="#000000">(</FONT>pf_elt<FONT COLOR="#000000">,</FONT> pf_arr<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> array_v_unsome <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>Int?<FONT COLOR="#000000">}</FONT></FONT> pf_arr</FONT>
         <FONT COLOR="#000000">val</FONT> <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> ptr_set_t <FONT COLOR="#000000">(</FONT><FONT COLOR="#009000">pf_elt</FONT> <FONT COLOR="#000000">|</FONT> tbl_ofs<FONT COLOR="#000000">,</FONT> j+1<FONT COLOR="#000000">)</FONT>
         <FONT COLOR="#000000">prval</FONT> <FONT COLOR="#009000">pf_kmp <FONT COLOR="#000000">=</FONT> kmp_v_more <FONT COLOR="#000000">(</FONT>pf_mul<FONT COLOR="#000000">,</FONT> pf_kmp<FONT COLOR="#000000">,</FONT> pf_elt<FONT COLOR="#000000">)</FONT></FONT>
         <FONT COLOR="#000000">prval</FONT> <FONT COLOR="#009000">pf_mul <FONT COLOR="#000000">=</FONT> mul_add_const <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>1<FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#000000">(</FONT>pf_mul<FONT COLOR="#000000">)</FONT></FONT>
      <FONT COLOR="#000000">in</FONT>
         kmp_table_make_aux
           <FONT COLOR="#000000">(</FONT><FONT COLOR="#009000">pf_mul</FONT><FONT COLOR="#000000">,</FONT> <FONT COLOR="#009000">pf_kmp</FONT><FONT COLOR="#000000">,</FONT> <FONT COLOR="#009000">pf_arr</FONT> <FONT COLOR="#000000">|</FONT> w<FONT COLOR="#000000">,</FONT> tbl<FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">,</FONT> i+1<FONT COLOR="#000000">,</FONT> j+1<FONT COLOR="#000000">,</FONT> tbl_ofs+intsz<FONT COLOR="#000000">)</FONT>
      <FONT COLOR="#000000">end</FONT>
    <FONT COLOR="#000000">else</FONT> <FONT COLOR="#000000">if</FONT> j <FONT COLOR="#000000">&gt;</FONT> 0 <FONT COLOR="#000000">then</FONT>
      kmp_table_make_aux
        <FONT COLOR="#000000">(</FONT><FONT COLOR="#009000">pf_mul</FONT><FONT COLOR="#000000">,</FONT> <FONT COLOR="#009000">pf_kmp</FONT><FONT COLOR="#000000">,</FONT> <FONT COLOR="#009000">pf_arr</FONT> <FONT COLOR="#000000">|</FONT> w<FONT COLOR="#000000">,</FONT> tbl<FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">,</FONT> i<FONT COLOR="#000000">,</FONT> kmp_sub <FONT COLOR="#000000">(</FONT><FONT COLOR="#009000">pf_kmp</FONT> <FONT COLOR="#000000">|</FONT> tbl<FONT COLOR="#000000">,</FONT> j<FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">,</FONT> tbl_ofs<FONT COLOR="#000000">)</FONT>
    <FONT COLOR="#000000">else</FONT>
      <FONT COLOR="#000000">let</FONT>
         <FONT COLOR="#000000">prval</FONT> <FONT COLOR="#009000"><FONT COLOR="#000000">(</FONT>pf_elt<FONT COLOR="#000000">,</FONT> pf_arr<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> array_v_unsome <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>Int?<FONT COLOR="#000000">}</FONT></FONT> pf_arr</FONT>
         <FONT COLOR="#000000">val</FONT> <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> ptr_set_t <FONT COLOR="#000000">(</FONT><FONT COLOR="#009000">pf_elt</FONT> <FONT COLOR="#000000">|</FONT> tbl_ofs<FONT COLOR="#000000">,</FONT> 0<FONT COLOR="#000000">)</FONT>
         <FONT COLOR="#000000">prval</FONT> <FONT COLOR="#009000">pf_kmp <FONT COLOR="#000000">=</FONT> kmp_v_more <FONT COLOR="#000000">(</FONT>pf_mul<FONT COLOR="#000000">,</FONT> pf_kmp<FONT COLOR="#000000">,</FONT> pf_elt<FONT COLOR="#000000">)</FONT></FONT>
         <FONT COLOR="#000000">prval</FONT> <FONT COLOR="#009000">pf_mul <FONT COLOR="#000000">=</FONT> mul_add_const <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>1<FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#000000">(</FONT>pf_mul<FONT COLOR="#000000">)</FONT></FONT>
      <FONT COLOR="#000000">in</FONT>
         kmp_table_make_aux
           <FONT COLOR="#000000">(</FONT><FONT COLOR="#009000">pf_mul</FONT><FONT COLOR="#000000">,</FONT> <FONT COLOR="#009000">pf_kmp</FONT><FONT COLOR="#000000">,</FONT> <FONT COLOR="#009000">pf_arr</FONT> <FONT COLOR="#000000">|</FONT> w<FONT COLOR="#000000">,</FONT> tbl<FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">,</FONT> i+1<FONT COLOR="#000000">,</FONT> 0<FONT COLOR="#000000">,</FONT> tbl_ofs+intsz<FONT COLOR="#000000">)</FONT>
      <FONT COLOR="#000000">end</FONT>
   <FONT COLOR="#000000">else</FONT> <FONT COLOR="#000000">let</FONT> <FONT COLOR="#000000">prval</FONT> <FONT COLOR="#009000"><FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> array_v_unnone pf_arr</FONT> <FONT COLOR="#000000">in</FONT> <FONT COLOR="#000000">(</FONT><FONT COLOR="#009000">pf_kmp</FONT> <FONT COLOR="#000000">|</FONT> <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">end</FONT>
<FONT COLOR="#000000">end</FONT> <FONT COLOR="#787878">// end of [kmp_table_make_aux]
</FONT>
<FONT COLOR="#787878">//
</FONT>
<FONT COLOR="#000000">fn</FONT> kmp_table_make <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>n<FONT COLOR="#000000">:</FONT>int <FONT COLOR="#000000">|</FONT> n &gt;= 1<FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#000000">(</FONT>w<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">string n</FONT><FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">int n</FONT><FONT COLOR="#000000">)</FONT>
  <FONT COLOR="#000000">:&lt;&gt;</FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">[</FONT>l<FONT COLOR="#000000">:</FONT>addr<FONT COLOR="#000000">]</FONT> <FONT COLOR="#000000">(</FONT>free_ngc_v <FONT COLOR="#000000">(</FONT>l+intsz<FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">,</FONT> kmp_v <FONT COLOR="#000000">(</FONT>l<FONT COLOR="#000000">,</FONT> n-1<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">|</FONT> ptr l<FONT COLOR="#000000">)</FONT></FONT> <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">let</FONT>
  <FONT COLOR="#000000">val</FONT> n <FONT COLOR="#000000">=</FONT> string1_length w
  <FONT COLOR="#000000">val</FONT> <FONT COLOR="#000000">[</FONT><FONT COLOR="#0000FF">l</FONT><FONT COLOR="#000000">:</FONT>addr<FONT COLOR="#000000">]</FONT> <FONT COLOR="#000000">(</FONT><FONT COLOR="#009000">pf_ngc</FONT><FONT COLOR="#000000">,</FONT> <FONT COLOR="#009000">pf_arr</FONT> <FONT COLOR="#000000">|</FONT> p_arr<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> array_int_ptr_make <FONT COLOR="#000000">(</FONT>n-1<FONT COLOR="#000000">)</FONT>
  <FONT COLOR="#000000">val</FONT> tbl <FONT COLOR="#000000">=</FONT> p_arr-intsz
  <FONT COLOR="#000000">prval</FONT> <FONT COLOR="#009000">pf_kmp <FONT COLOR="#000000">=</FONT> kmp_v_none <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>l-intsz<FONT COLOR="#000000">}</FONT></FONT></FONT>
<FONT COLOR="#000000">in</FONT>
  <FONT COLOR="#000000">if</FONT> n <FONT COLOR="#000000">&gt;</FONT> 1 <FONT COLOR="#000000">then</FONT> <FONT COLOR="#000000">let</FONT>
    <FONT COLOR="#000000">prval</FONT> <FONT COLOR="#009000"><FONT COLOR="#000000">(</FONT>pf_elt<FONT COLOR="#000000">,</FONT> pf_arr<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> array_v_unsome <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>Int?<FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#000000">(</FONT>pf_arr<FONT COLOR="#000000">)</FONT></FONT>
    <FONT COLOR="#000000">val</FONT> <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> ptr_set_t <FONT COLOR="#000000">(</FONT><FONT COLOR="#009000">pf_elt</FONT> <FONT COLOR="#000000">|</FONT> p_arr<FONT COLOR="#000000">,</FONT> 0<FONT COLOR="#000000">)</FONT>
    <FONT COLOR="#000000">prval</FONT> <FONT COLOR="#009000">pf1_mul <FONT COLOR="#000000">=</FONT> mul_make_const <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>1<FONT COLOR="#000000">,</FONT>intsz<FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT></FONT>
    <FONT COLOR="#000000">prval</FONT> <FONT COLOR="#009000">pf2_mul <FONT COLOR="#000000">=</FONT> mul_make_const <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>2<FONT COLOR="#000000">,</FONT>intsz<FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT></FONT>
    <FONT COLOR="#000000">prval</FONT> <FONT COLOR="#009000">pf_kmp <FONT COLOR="#000000">=</FONT> kmp_v_more <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>l-intsz<FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#000000">(</FONT>pf1_mul<FONT COLOR="#000000">,</FONT> pf_kmp<FONT COLOR="#000000">,</FONT> pf_elt<FONT COLOR="#000000">)</FONT></FONT>
    <FONT COLOR="#000000">val</FONT> <FONT COLOR="#000000">(</FONT><FONT COLOR="#009000">pf_kmp</FONT> <FONT COLOR="#000000">|</FONT> <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> kmp_table_make_aux
      <FONT COLOR="#000000">(</FONT><FONT COLOR="#009000">pf2_mul</FONT><FONT COLOR="#000000">,</FONT> <FONT COLOR="#009000">pf_kmp</FONT><FONT COLOR="#000000">,</FONT> <FONT COLOR="#009000">pf_arr</FONT> <FONT COLOR="#000000">|</FONT> w<FONT COLOR="#000000">,</FONT> tbl<FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">,</FONT> 2<FONT COLOR="#000000">,</FONT> 0<FONT COLOR="#000000">,</FONT> p_arr+intsz<FONT COLOR="#000000">)</FONT>
  <FONT COLOR="#000000">in</FONT>
    <FONT COLOR="#000000">(</FONT><FONT COLOR="#009000">pf_ngc</FONT><FONT COLOR="#000000">,</FONT> <FONT COLOR="#009000">pf_kmp</FONT> <FONT COLOR="#000000">|</FONT> tbl<FONT COLOR="#000000">)</FONT>
  <FONT COLOR="#000000">end</FONT> <FONT COLOR="#000000">else</FONT> <FONT COLOR="#000000">let</FONT>
    <FONT COLOR="#000000">prval</FONT> <FONT COLOR="#009000"><FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> array_v_unnone<FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>Int?<FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#000000">(</FONT>pf_arr<FONT COLOR="#000000">)</FONT></FONT>
  <FONT COLOR="#000000">in</FONT>
    <FONT COLOR="#000000">(</FONT><FONT COLOR="#009000">pf_ngc</FONT><FONT COLOR="#000000">,</FONT> <FONT COLOR="#009000">pf_kmp</FONT> <FONT COLOR="#000000">|</FONT> tbl<FONT COLOR="#000000">)</FONT>
  <FONT COLOR="#000000">end</FONT>
<FONT COLOR="#000000">end</FONT> <FONT COLOR="#787878">// end of [kmp_table_make]
</FONT>
<FONT COLOR="#787878">//
</FONT>
<FONT COLOR="#000000">prfun</FONT> <FONT COLOR="#009000">array_v_of_kmp_v <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>n<FONT COLOR="#000000">:</FONT>nat<FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>l<FONT COLOR="#000000">:</FONT>addr<FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">.&lt;</FONT>n<FONT COLOR="#000000">&gt;.</FONT></FONT>
  <FONT COLOR="#000000">(</FONT>pf_kmp<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">kmp_v <FONT COLOR="#000000">(</FONT>l<FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">)</FONT></FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">array_v <FONT COLOR="#000000">(</FONT>Int?<FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">,</FONT> l+intsz<FONT COLOR="#000000">)</FONT></FONT> <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">begin</FONT>
  <FONT COLOR="#009000"><FONT COLOR="#000000">sif</FONT> <FONT COLOR="#0000FF">n == 0</FONT> <FONT COLOR="#000000">then</FONT>
    <FONT COLOR="#000000">let</FONT> <FONT COLOR="#000000">prval</FONT> <FONT COLOR="#009000">kmp_v_none <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> pf_kmp</FONT> <FONT COLOR="#000000">in</FONT> array_v_none<FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>Int?<FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">end</FONT>
  <FONT COLOR="#000000">else</FONT> <FONT COLOR="#000000">let</FONT>
    <FONT COLOR="#000000">prval</FONT> <FONT COLOR="#009000">kmp_v_more <FONT COLOR="#000000">(</FONT>pf_mul<FONT COLOR="#000000">,</FONT> pf_kmp<FONT COLOR="#000000">,</FONT> pf_elt<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> pf_kmp</FONT>
    <FONT COLOR="#000000">prval</FONT> <FONT COLOR="#009000">pf1_mul <FONT COLOR="#000000">=</FONT> mul_add_const <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>~1<FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#000000">(</FONT>pf_mul<FONT COLOR="#000000">)</FONT></FONT>
    <FONT COLOR="#000000">prval</FONT> <FONT COLOR="#009000">pf_arr <FONT COLOR="#000000">=</FONT> array_v_of_kmp_v pf_kmp</FONT>
  <FONT COLOR="#000000">in</FONT>
    array_v_extend <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>Int?<FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#000000">(</FONT>pf1_mul<FONT COLOR="#000000">,</FONT> pf_arr<FONT COLOR="#000000">,</FONT> pf_elt<FONT COLOR="#000000">)</FONT>
  <FONT COLOR="#000000">end</FONT></FONT>
<FONT COLOR="#000000">end</FONT></FONT> <FONT COLOR="#787878">// end of [array_v_of_kmp_v]
</FONT>
<FONT COLOR="#000000">fn</FONT> kmp_table_free <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>n<FONT COLOR="#000000">:</FONT>nat<FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>l<FONT COLOR="#000000">:</FONT>addr<FONT COLOR="#000000">}</FONT></FONT>
  <FONT COLOR="#000000">(</FONT><FONT COLOR="#009000">pf_ngc<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">free_ngc_v <FONT COLOR="#000000">(</FONT>l+intsz<FONT COLOR="#000000">)</FONT></FONT></FONT><FONT COLOR="#000000">,</FONT> <FONT COLOR="#009000">pf_kmp<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">kmp_v <FONT COLOR="#000000">(</FONT>l<FONT COLOR="#000000">,</FONT> n<FONT COLOR="#000000">)</FONT></FONT></FONT> <FONT COLOR="#000000">|</FONT> p<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">ptr l</FONT><FONT COLOR="#000000">)</FONT>
  <FONT COLOR="#000000">:&lt;&gt;</FONT> <FONT COLOR="#0000FF">void</FONT> <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">let</FONT>
  <FONT COLOR="#000000">prval</FONT> <FONT COLOR="#009000">pf_arr <FONT COLOR="#000000">=</FONT> array_v_of_kmp_v pf_kmp</FONT>
<FONT COLOR="#000000">in</FONT>
  array_int_ptr_free <FONT COLOR="#000000">(</FONT><FONT COLOR="#009000">pf_ngc</FONT><FONT COLOR="#000000">,</FONT> <FONT COLOR="#009000">pf_arr</FONT> <FONT COLOR="#000000">|</FONT> p+intsz<FONT COLOR="#000000">)</FONT>
<FONT COLOR="#000000">end</FONT> <FONT COLOR="#787878">// end of [kmp_table_free]
</FONT>
<FONT COLOR="#787878">//
</FONT>
<FONT COLOR="#000000">fn</FONT> kmp_search <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>ns<FONT COLOR="#000000">:</FONT>nat<FONT COLOR="#000000">;</FONT> nw<FONT COLOR="#000000">:</FONT>int <FONT COLOR="#000000">|</FONT> nw &gt;= 1<FONT COLOR="#000000">}</FONT></FONT>
   <FONT COLOR="#000000">(</FONT>s<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">string ns</FONT><FONT COLOR="#000000">,</FONT> w<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">string nw</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">:&lt;&gt;</FONT> <FONT COLOR="#0000FF">intBtw <FONT COLOR="#000000">(</FONT>~1<FONT COLOR="#000000">,</FONT> ns<FONT COLOR="#000000">)</FONT></FONT> <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">let</FONT>
  <FONT COLOR="#000000">val</FONT> ns <FONT COLOR="#000000">=</FONT> string1_length s
  <FONT COLOR="#000000">val</FONT> nw <FONT COLOR="#000000">=</FONT> string1_length w
  <FONT COLOR="#000000">val</FONT> <FONT COLOR="#000000">[</FONT><FONT COLOR="#0000FF">l</FONT><FONT COLOR="#000000">:</FONT>addr<FONT COLOR="#000000">]</FONT> <FONT COLOR="#000000">(</FONT><FONT COLOR="#009000">pf_ngc</FONT><FONT COLOR="#000000">,</FONT> <FONT COLOR="#009000">pf</FONT> <FONT COLOR="#000000">|</FONT> tbl<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> kmp_table_make <FONT COLOR="#000000">(</FONT>w<FONT COLOR="#000000">,</FONT> nw<FONT COLOR="#000000">)</FONT>
  <FONT COLOR="#000000">fun</FONT> aux <FONT COLOR="#0000FF"><FONT COLOR="#000000">{</FONT>m<FONT COLOR="#000000">,</FONT>i<FONT COLOR="#000000">:</FONT>nat <FONT COLOR="#000000">|</FONT> m+i &lt;= ns<FONT COLOR="#000000">;</FONT> i &lt;= nw<FONT COLOR="#000000">}</FONT></FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">.&lt;</FONT>ns-m-i<FONT COLOR="#000000">,</FONT> i<FONT COLOR="#000000">&gt;.</FONT></FONT>
    <FONT COLOR="#000000">(</FONT><FONT COLOR="#009000">pf<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF"><FONT COLOR="#000000">!</FONT>kmp_v <FONT COLOR="#000000">(</FONT>l<FONT COLOR="#000000">,</FONT> nw-1<FONT COLOR="#000000">)</FONT></FONT></FONT> <FONT COLOR="#000000">|</FONT> m<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">int m</FONT><FONT COLOR="#000000">,</FONT> i<FONT COLOR="#000000">:</FONT> <FONT COLOR="#0000FF">int i</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">:&lt;</FONT><FONT COLOR="#0000FF">cloptr</FONT><FONT COLOR="#000000">&gt;</FONT> <FONT COLOR="#0000FF">intBtw <FONT COLOR="#000000">(</FONT>~1<FONT COLOR="#000000">,</FONT> ns<FONT COLOR="#000000">)</FONT></FONT> <FONT COLOR="#000000">=</FONT>
    <FONT COLOR="#000000">if</FONT> i <FONT COLOR="#000000">=</FONT> nw <FONT COLOR="#000000">then</FONT> m <FONT COLOR="#000000">else</FONT> <FONT COLOR="#000000">begin</FONT>
      <FONT COLOR="#000000">if</FONT> m+i <FONT COLOR="#000000">&lt;</FONT> ns <FONT COLOR="#000000">then</FONT>
        <FONT COLOR="#000000">if</FONT> w[<FONT COLOR="#009000">i</FONT><FONT COLOR="#000000">]</FONT> <FONT COLOR="#000000">=</FONT> s[<FONT COLOR="#009000">m+i</FONT><FONT COLOR="#000000">]</FONT> <FONT COLOR="#000000">then</FONT> aux <FONT COLOR="#000000">(</FONT><FONT COLOR="#009000">pf</FONT> <FONT COLOR="#000000">|</FONT> m<FONT COLOR="#000000">,</FONT> i+1<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">else</FONT> <FONT COLOR="#000000">begin</FONT>
          <FONT COLOR="#000000">if</FONT> i <FONT COLOR="#000000">&gt;</FONT> 0 <FONT COLOR="#000000">then</FONT> <FONT COLOR="#000000">begin</FONT>
            <FONT COLOR="#000000">let</FONT> <FONT COLOR="#000000">val</FONT> i1 <FONT COLOR="#000000">=</FONT> kmp_sub <FONT COLOR="#000000">(</FONT><FONT COLOR="#009000">pf</FONT> <FONT COLOR="#000000">|</FONT> tbl<FONT COLOR="#000000">,</FONT> i<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">in</FONT> aux <FONT COLOR="#000000">(</FONT><FONT COLOR="#009000">pf</FONT> <FONT COLOR="#000000">|</FONT> m+i-i1<FONT COLOR="#000000">,</FONT> i1<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">end</FONT>
          <FONT COLOR="#000000">end</FONT> <FONT COLOR="#000000">else</FONT> <FONT COLOR="#000000">begin</FONT>
            aux <FONT COLOR="#000000">(</FONT><FONT COLOR="#009000">pf</FONT> <FONT COLOR="#000000">|</FONT> m+1<FONT COLOR="#000000">,</FONT> 0<FONT COLOR="#000000">)</FONT>
          <FONT COLOR="#000000">end</FONT>
        <FONT COLOR="#000000">end</FONT> <FONT COLOR="#787878">// end of [if]
</FONT>      <FONT COLOR="#000000">else</FONT> ~1
    <FONT COLOR="#000000">end</FONT> <FONT COLOR="#787878">// end of [if]
</FONT>  <FONT COLOR="#000000">val</FONT> ans <FONT COLOR="#000000">=</FONT> aux <FONT COLOR="#000000">(</FONT><FONT COLOR="#009000">pf</FONT> <FONT COLOR="#000000">|</FONT> 0<FONT COLOR="#000000">,</FONT> 0<FONT COLOR="#000000">)</FONT>
<FONT COLOR="#000000">in</FONT>
  kmp_table_free <FONT COLOR="#000000">(</FONT><FONT COLOR="#009000">pf_ngc</FONT><FONT COLOR="#000000">,</FONT> <FONT COLOR="#009000">pf</FONT> <FONT COLOR="#000000">|</FONT> tbl<FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">;</FONT> ans
<FONT COLOR="#000000">end</FONT> <FONT COLOR="#787878">// end of [kmp_search]
</FONT>
<FONT COLOR="#787878">// some tests
</FONT>
<FONT COLOR="#000000">implement</FONT> main <FONT COLOR="#000000">(</FONT>argc<FONT COLOR="#000000">,</FONT> argv<FONT COLOR="#000000">)</FONT> <FONT COLOR="#000000">=</FONT> <FONT COLOR="#000000">begin</FONT>
  print "kmp_search(\"abcdefggfedcbabcdefg\", \"fggf\") = "<FONT COLOR="#000000">;</FONT>
  print <FONT COLOR="#000000">(</FONT>kmp_search<FONT COLOR="#000000">(</FONT>"abcdefggfedcbabcdefg"<FONT COLOR="#000000">,</FONT> "fggf"<FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">;</FONT>
  print_newline <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">;</FONT>

  print "kmp_search(\"abcdefggfedcbabcdefg\", \"cbabc\") = "<FONT COLOR="#000000">;</FONT>
  print <FONT COLOR="#000000">(</FONT>kmp_search<FONT COLOR="#000000">(</FONT>"abcdefggfedcbabcdefg"<FONT COLOR="#000000">,</FONT> "cbabc"<FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">;</FONT>
  print_newline <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">;</FONT>

  print "kmp_search(\"abcdefggfedcbabcdefg\", \"baba\") = "<FONT COLOR="#000000">;</FONT>
  print <FONT COLOR="#000000">(</FONT>kmp_search<FONT COLOR="#000000">(</FONT>"abcdefggfedcbabcdefg"<FONT COLOR="#000000">,</FONT> "baba"<FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">;</FONT>
  print_newline <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">;</FONT>

  print "kmp_search(\"abcdefggfedcbabadefg\", \"baba\") = "<FONT COLOR="#000000">;</FONT>
  print <FONT COLOR="#000000">(</FONT>kmp_search<FONT COLOR="#000000">(</FONT>"abcdefggfedcbabadefg"<FONT COLOR="#000000">,</FONT> "baba"<FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">;</FONT>
  print_newline <FONT COLOR="#000000">(</FONT><FONT COLOR="#000000">)</FONT><FONT COLOR="#000000">;</FONT>
<FONT COLOR="#000000">end</FONT>

<FONT COLOR="#787878">(* ****** ****** *)</FONT>

<FONT COLOR="#787878">(* end of [kmp.dats] *)</FONT>

<FONT COLOR="#787878">////

// An (untested) implementation in C

(*

#include &lt;stdlib.h&gt;

int main()
{
  unsigned int Fail[1024];
  unsigned int M, K, R, i;
  const char* P = "AAAABAABACA";

  M = strlen(P);
  K = 1;

  Fail[K] = 0;

  while (K &lt;= M) {
    R = Fail[K];

    while ((R &gt; 0) &amp;&amp; (P[R-1] != P[K-1]))
      R = Fail[R];

    Fail[K+1] = R+1;
    K++;
  }

  /*
  K = 1;
  while (K &lt;= M) {
    R = Fail[K];

    if (P[K-1] == P[R-1])
      Fail[K] = Fail[R];

    K++;
  }
  */

  for (i = 1; i &lt;= M+1; i++)
    printf("Fail[%d] = %d\n", i, Fail[i]);

  return 0;
}

*)
</FONT></PRE></BODY>
